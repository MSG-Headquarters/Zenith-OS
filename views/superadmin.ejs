<!DOCTYPE html>
<html lang="en" data-theme="<%= typeof theme !== 'undefined' ? theme : 'light' %>">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSG Super Admin | CRE OS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/theme.css">
    <script src="/js/theme.js"></script>
    <style>
        :root {
            --bg-void: #000000; --bg-card: #0a0f1a; --bg-slate: #0f1419;
            --accent-emerald: #10B981; --accent-cyan: #06B6D4; --accent-blue: #3B82F6;
            --accent-violet: #8B5CF6; --accent-amber: #F59E0B; --accent-rose: #F43F5E;
            --text-primary: #F8FAFC; --text-secondary: #94A3B8; --text-muted: #64748B;
            --border: rgba(255, 255, 255, 0.08);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-void); color: var(--text-primary); min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 32px; }
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid var(--border); }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .logo-icon { width: 56px; height: 56px; background: linear-gradient(135deg, var(--accent-rose), var(--accent-amber)); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 28px; }
        .header-title h1 { font-size: 24px; font-weight: 800; }
        .header-title p { font-size: 14px; color: var(--text-muted); }
        .btn { padding: 12px 24px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--accent-emerald); color: white; }
        .btn-danger { background: var(--accent-rose); color: white; }
        .btn-ghost { background: var(--bg-card); color: var(--text-secondary); border: 1px solid var(--border); }
        .btn-sm { padding: 8px 14px; font-size: 12px; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--stat-color); }
        .stat-label { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; }
        .stat-value { font-size: 28px; font-weight: 800; margin-bottom: 4px; }
        .stat-change { font-size: 12px; color: var(--accent-emerald); }
        .stat-active { --stat-color: var(--accent-emerald); }
        .stat-revenue { --stat-color: var(--accent-cyan); }
        .stat-suspended { --stat-color: var(--accent-rose); }
        .stat-pending { --stat-color: var(--accent-amber); }
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; margin-bottom: 24px; }
        .card-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .card-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 16px 20px; text-align: left; border-bottom: 1px solid var(--border); }
        th { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; background: var(--bg-slate); }
        tr:hover { background: rgba(255,255,255,0.02); }
        .tenant-name { font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .tenant-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .status-badge { padding: 4px 12px; border-radius: 100px; font-size: 11px; font-weight: 600; }
        .status-active { background: rgba(16, 185, 129, 0.15); color: var(--accent-emerald); }
        .status-suspended { background: rgba(244, 63, 94, 0.15); color: var(--accent-rose); }
        .status-expired { background: rgba(245, 158, 11, 0.15); color: var(--accent-amber); }
        .actions-cell { display: flex; gap: 8px; }
        .action-btn { width: 32px; height: 32px; border-radius: 8px; background: var(--bg-slate); border: 1px solid var(--border); color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .action-btn:hover { background: var(--bg-card); color: var(--text-primary); }
        .action-btn.danger:hover { background: rgba(244, 63, 94, 0.15); color: var(--accent-rose); border-color: var(--accent-rose); }
        .action-btn.success:hover { background: rgba(16, 185, 129, 0.15); color: var(--accent-emerald); border-color: var(--accent-emerald); }
        .back-link { display: inline-flex; align-items: center; gap: 8px; color: var(--accent-emerald); text-decoration: none; font-size: 14px; margin-top: 24px; }
        .warning-banner { background: rgba(244, 63, 94, 0.1); border: 1px solid rgba(244, 63, 94, 0.3); border-radius: 12px; padding: 16px 20px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px; }
        .warning-icon { font-size: 24px; }
        .warning-text { font-size: 13px; color: var(--text-secondary); }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-left">
                <div class="logo-icon">üõ°Ô∏è</div>
                <div class="header-title"><h1>MSG Super Admin</h1><p>Master Control Panel ‚Ä¢ Dead Man's Switch</p></div>
            </div>
            <div>
                <button class="btn btn-ghost" style="margin-right: 12px;">üìä Reports</button>
                <button class="btn btn-primary">+ Add Tenant</button>
            </div>
        </header>

        <div class="warning-banner">
            <span class="warning-icon">‚ö†Ô∏è</span>
            <div class="warning-text"><strong>Super Admin Access:</strong> Actions taken here affect all tenant organizations immediately. Use with caution.</div>
        </div>

        <div class="stats-grid">
            <div class="stat-card stat-active"><div class="stat-label">Active Tenants</div><div class="stat-value"><%= organizations ? organizations.filter(o => o.license_status === 'active').length : 0 %></div><div class="stat-change">Licensed & operational</div></div>
            <div class="stat-card stat-revenue"><div class="stat-label">Total Platform Fees</div><div class="stat-value">$42K</div><div class="stat-change">YTD revenue share</div></div>
            <div class="stat-card stat-suspended"><div class="stat-label">Suspended</div><div class="stat-value"><%= organizations ? organizations.filter(o => o.license_status === 'suspended').length : 0 %></div><div class="stat-change">Awaiting resolution</div></div>
            <div class="stat-card stat-pending"><div class="stat-label">Total Users</div><div class="stat-value"><%= users ? users.length : 0 %></div><div class="stat-change">Across all tenants</div></div>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="card-title">üè¢ Tenant Organizations</span>
                <button class="btn btn-ghost btn-sm">Export</button>
            </div>
            <table>
                <thead><tr><th>Organization</th><th>License Key</th><th>Type</th><th>Status</th><th>Users</th><th>Actions</th></tr></thead>
                <tbody>
                    <% if (organizations && organizations.length > 0) { %>
                        <% organizations.forEach(org => { %>
                        <tr>
                            <td>
                                <div class="tenant-name">
                                    <div class="tenant-icon" style="background: rgba(59, 130, 246, 0.2);">üè¢</div>
                                    <%= org.name %>
                                </div>
                            </td>
                            <td style="font-family: monospace; font-size: 12px;"><%= org.license_key %></td>
                            <td><%= org.license_type %></td>
                            <td><span class="status-badge <%= org.license_status === 'active' ? 'status-active' : org.license_status === 'suspended' ? 'status-suspended' : 'status-expired' %>"><%= org.license_status %></span></td>
                            <td><%= users ? users.filter(u => u.organization_id === org.id).length : 0 %></td>
                            <td>
                                <div class="actions-cell">
                                    <button class="action-btn" title="View" onclick="alert('View details for <%= org.name %>')">üëÅÔ∏è</button>
                                    <% if (org.license_status === 'active') { %>
                                    <button class="action-btn danger" title="Suspend" onclick="suspendTenant(<%= org.id %>, '<%= org.name %>')">üîí</button>
                                    <% } else { %>
                                    <button class="action-btn success" title="Activate" onclick="activateTenant(<%= org.id %>, '<%= org.name %>')">‚úÖ</button>
                                    <% } %>
                                </div>
                            </td>
                        </tr>
                        <% }); %>
                    <% } else { %>
                        <tr><td colspan="6" style="text-align: center; color: var(--text-muted);">No organizations found</td></tr>
                    <% } %>
                </tbody>
            </table>
        </div>

        <div class="card">
            <div class="card-header"><span class="card-title">üë• All Platform Users</span></div>
            <table>
                <thead><tr><th>User</th><th>Organization</th><th>Role</th><th>Last Login</th><th>Actions</th></tr></thead>
                <tbody>
                    <% if (users && users.length > 0) { %>
                        <% users.forEach(u => { %>
                        <tr>
                            <td><%= u.name %><br><span style="font-size: 11px; color: var(--text-muted);"><%= u.email %></span></td>
                            <td><%= u.org_name %></td>
                            <td><span class="status-badge status-active"><%= u.role %></span></td>
                            <td><%= u.last_login ? new Date(u.last_login).toLocaleDateString() : 'Never' %></td>
                            <td><div class="actions-cell"><button class="action-btn" title="Edit">‚úèÔ∏è</button><button class="action-btn danger" title="Revoke">‚õî</button></div></td>
                        </tr>
                        <% }); %>
                    <% } %>
                </tbody>
            </table>
        </div>

        <a href="/dashboard" class="back-link">‚Üê Back to CRE Dashboard</a>
    </div>

    <script>
        async function suspendTenant(orgId, orgName) {
            if (!confirm(`‚ö†Ô∏è DEAD MAN'S SWITCH\n\nThis will immediately lock out ALL users from ${orgName}.\n\nAre you sure?`)) return;
            
            try {
                const res = await fetch(`/superadmin/suspend/${orgId}`, { method: 'POST' });
                if (res.ok) {
                    alert(`${orgName} has been SUSPENDED. All users are now locked out.`);
                    location.reload();
                } else {
                    alert('Failed to suspend tenant');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function activateTenant(orgId, orgName) {
            if (!confirm(`Reactivate ${orgName}?\n\nThis will restore access for all users.`)) return;
            
            try {
                const res = await fetch(`/superadmin/activate/${orgId}`, { method: 'POST' });
                if (res.ok) {
                    alert(`${orgName} has been ACTIVATED.`);
                    location.reload();
                } else {
                    alert('Failed to activate tenant');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }
    </script>
</body>
</html>
