<!DOCTYPE html>
<html lang="en" data-theme="<%= typeof theme !== 'undefined' ? theme : 'light' %>">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAWK â€” Deal Velocity Engine | CRE OS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/theme.css">
    <script src="/js/theme.js"></script>
    <style>
        :root {
            --bg-white: var(--bg-surface); --bg-light: var(--bg-page); --bg-gray: var(--bg-surface-alt);
            --accent-hawk: #0f3460; --accent-hawk-light: #1a4a7a; --accent-emerald: #10B981;
            --accent-blue: #3B82F6; --accent-rose: #F43F5E; --accent-amber: #F59E0B;
            --text-primary: var(--text-primary); --text-secondary: var(--text-secondary); --text-muted: var(--text-muted);
            --border: var(--border);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-light); color: var(--text-primary); min-height: 100vh; display: flex; }
        .sidebar { width: 260px; background: var(--bg-white); border-right: 1px solid var(--border); position: fixed; height: 100vh; display: flex; flex-direction: column; z-index: 100; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, #1a1a2e, #0f3460); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .logo-text h1 { font-size: 16px; font-weight: 700; }
        .logo-text p { font-size: 11px; color: var(--text-muted); }
        .sidebar-nav { flex: 1; padding: 16px 12px; overflow-y: auto; }
        .nav-section { margin-bottom: 20px; }
        .nav-section-label { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; padding: 0 12px; margin-bottom: 8px; }
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; color: var(--text-secondary); text-decoration: none; font-size: 14px; margin-bottom: 2px; }
        .nav-item:hover { background: var(--bg-gray); }
        .nav-item.active { background: rgba(15, 52, 96, 0.1); color: var(--accent-hawk); font-weight: 600; }
        .sidebar-footer { padding: 16px; border-top: 1px solid var(--border); }
        .back-link { display: flex; align-items: center; gap: 8px; color: var(--text-secondary); text-decoration: none; font-size: 13px; padding: 10px 12px; border-radius: 8px; }
        .back-link:hover { background: var(--bg-gray); }
        .main-content { flex: 1; margin-left: 260px; }
        .topbar { height: 64px; background: var(--bg-white); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 32px; position: sticky; top: 0; z-index: 50; }
        .topbar-left { display: flex; align-items: center; gap: 14px; }
        .topbar-title { font-size: 20px; font-weight: 700; }
        .topbar-subtitle { font-size: 12px; color: var(--text-muted); }
        .topbar-actions { display: flex; gap: 10px; align-items: center; }
        .content-area { padding: 28px 32px; max-width: 1600px; }
        .hawk-filter-select { padding: 8px 14px; border: 1px solid var(--border); border-radius: 8px; font-size: 13px; background: var(--bg-white); color: var(--text-primary); cursor: pointer; font-family: 'Inter', sans-serif; }
        .hawk-filter-select:focus { outline: none; border-color: var(--accent-hawk); box-shadow: 0 0 0 3px rgba(15,52,96,0.1); }
        .btn { padding: 8px 18px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 6px; font-family: 'Inter', sans-serif; }
        .btn-primary { background: var(--accent-hawk); color: white; }
        .btn-primary:hover { background: var(--accent-hawk-light); }
        .hawk-tabs { display: inline-flex; gap: 4px; padding: 4px; background: var(--bg-gray); border-radius: 10px; margin-bottom: 24px; }
        .hawk-tab { padding: 8px 22px; border: none; background: transparent; color: var(--text-muted); font-size: 13px; font-weight: 600; border-radius: 8px; cursor: pointer; font-family: 'Inter', sans-serif; }
        .hawk-tab.active { background: var(--bg-white); color: var(--accent-hawk); box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .hawk-tab:hover:not(.active) { color: var(--text-primary); }
        .hawk-tab-content { display: none; }
        .hawk-tab-content.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-white); border: 1px solid var(--border); border-radius: 12px; padding: 20px; transition: all 0.2s; }
        .stat-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.06); transform: translateY(-1px); }
        .stat-label { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .stat-value { font-size: 26px; font-weight: 700; line-height: 1.2; }
        .stat-detail { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
        .stat-positive { color: var(--accent-emerald) !important; }
        .stat-negative { color: var(--accent-rose) !important; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
        .grid-1 { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 24px; }
        .card { background: var(--bg-white); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .card-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .card-title { font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .card-body { padding: 16px 20px; }
        .badge { font-size: 11px; padding: 2px 10px; border-radius: 100px; font-weight: 600; }
        .badge-blue { background: rgba(59,130,246,0.1); color: #2563eb; }
        .badge-green { background: rgba(16,185,129,0.1); color: #059669; }
        .badge-amber { background: rgba(245,158,11,0.1); color: #d97706; }
        .badge-red { background: rgba(244,63,94,0.1); color: #e11d48; }
        .hawk-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .hawk-table thead th { text-align: left; padding: 10px 12px; font-weight: 600; color: var(--text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid var(--border); white-space: nowrap; }
        .hawk-table tbody td { padding: 10px 12px; border-bottom: 1px solid var(--bg-gray); }
        .hawk-table tbody tr:hover { background: var(--bg-gray); }
        .hawk-table tbody tr:last-child td { border-bottom: none; }
        .currency { font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; font-weight: 600; }
        .number { font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; }
        .bar-row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .bar-label { width: 160px; font-size: 12px; font-weight: 500; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .bar-track { flex: 1; height: 24px; background: var(--bg-gray); border-radius: 6px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 6px; transition: width 0.8s ease-out; display: flex; align-items: center; padding-left: 8px; }
        .bar-fill span { font-size: 11px; font-weight: 600; color: #fff; white-space: nowrap; }
        .bar-inflow { background: linear-gradient(90deg, #059669, #34d399); }
        .bar-outflow { background: linear-gradient(90deg, #e11d48, #fb7185); }
        .bar-sba { background: linear-gradient(90deg, #2563eb, #60a5fa); }
        .net-flow { display: inline-flex; align-items: center; gap: 4px; font-weight: 700; font-size: 13px; }
        .net-flow.positive { color: var(--accent-emerald); }
        .net-flow.negative { color: var(--accent-rose); }
        .hawk-loader { display: flex; align-items: center; justify-content: center; padding: 60px 20px; color: var(--text-muted); font-size: 14px; gap: 12px; }
        .hawk-spinner { width: 22px; height: 22px; border: 3px solid var(--border); border-top-color: var(--accent-hawk); border-radius: 50%; animation: hspin 0.7s linear infinite; }
        @keyframes hspin { to { transform: rotate(360deg); } }
        .hawk-empty { text-align: center; padding: 40px; color: var(--text-muted); font-size: 14px; }
        .hawk-pagination { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; border-top: 1px solid var(--border); }
        .hawk-pagination button { padding: 6px 14px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-white); color: var(--text-secondary); font-size: 12px; cursor: pointer; font-family: 'Inter', sans-serif; }
        .hawk-pagination button:hover:not(:disabled) { border-color: var(--accent-hawk); color: var(--accent-hawk); }
        .hawk-pagination button:disabled { opacity: 0.4; cursor: not-allowed; }
        .page-info { font-size: 12px; color: var(--text-muted); }
        .hawk-search input { padding: 7px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; width: 220px; font-family: 'Inter', sans-serif; background: var(--bg-white); color: var(--text-primary); }
        .hawk-search input:focus { outline: none; border-color: var(--accent-hawk); box-shadow: 0 0 0 3px rgba(15,52,96,0.1); }
        @media (max-width: 1024px) { .grid-2 { grid-template-columns: 1fr; } .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .sidebar { display: none; } .main-content { margin-left: 0; } .stats-grid { grid-template-columns: 1fr; } }
    </style>
<%- include("partials/security") %>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo-icon">&#129413;</div>
            <div class="logo-text"><h1>HAWK</h1><p>Deal Velocity Engine</p></div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-label">Intelligence</div>
                <a href="/hawk" class="nav-item active"><span>&#128202;</span> Overview</a>
                <a href="#" class="nav-item" onclick="HAWK.switchTab('migration');return false;"><span>&#127758;</span> Migration Data</a>
                <a href="#" class="nav-item" onclick="HAWK.switchTab('sba');return false;"><span>&#127974;</span> SBA Loans</a>
            </div>
            <div class="nav-section">
                <div class="nav-section-label">Navigate</div>
                <a href="/dashboard" class="nav-item"><span>&#127968;</span> CRE Home</a>
                <a href="/intel" class="nav-item"><span>&#128161;</span> INTEL</a>
                <a href="/danimal" class="nav-item"><span>&#128024;</span> Danimal Data</a>
                <a href="/crm" class="nav-item"><span>&#128200;</span> CRM</a>
                <a href="/cfo" class="nav-item"><span>&#128176;</span> CFO</a>
            </div>
        </nav>
        <div class="sidebar-footer"><a href="/dashboard" class="back-link">&#8592; Back to CRE Home</a></div>
    </aside>

    <main class="main-content">
        <header class="topbar">
            <div class="topbar-left">
                <div>
                    <div class="topbar-title">HAWK &#8212; Deal Velocity Engine</div>
                    <div class="topbar-subtitle">IRS Migration Intelligence + SBA Loan Signals | SWFL Market</div>
                </div>
            </div>
            <div class="topbar-actions">
                <select id="hawkCountyFilter" class="hawk-filter-select">
                    <option value="">All Counties</option>
                    <option value="Lee">Lee County</option>
                    <option value="Collier">Collier County</option>
                    <option value="Charlotte">Charlotte County</option>
                    <option value="Sarasota">Sarasota County</option>
                    <option value="Manatee">Manatee County</option>
                    <option value="Hillsborough">Hillsborough County</option>
                    <option value="Pinellas">Pinellas County</option>
                    <option value="Palm Beach">Palm Beach County</option>
                    <option value="Broward">Broward County</option>
                    <option value="Miami-Dade">Miami-Dade County</option>
                    <option value="Orange">Orange County</option>
                    <option value="Duval">Duval County</option>
                </select>
                <button class="btn btn-primary" onclick="HAWK.loadAll()">&#8635; Refresh</button>
            </div>
        </header>

        <div class="content-area">
            <div class="hawk-tabs">
                <button class="hawk-tab active" data-tab="overview" onclick="HAWK.switchTab('overview')">Overview</button>
                <button class="hawk-tab" data-tab="migration" onclick="HAWK.switchTab('migration')">Migration Intelligence</button>
                <button class="hawk-tab" data-tab="sba" onclick="HAWK.switchTab('sba')">SBA Loans</button>
            </div>

            <div id="tab-overview" class="hawk-tab-content active">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-label">Total Records</div><div class="stat-value" id="statTotalRecords">&#8212;</div><div class="stat-detail">Migration + SBA combined</div></div>
                    <div class="stat-card"><div class="stat-label">Net Migration</div><div class="stat-value" id="statNetMigration">&#8212;</div><div class="stat-detail">Tax returns (inflow - outflow)</div></div>
                    <div class="stat-card"><div class="stat-label">Net AGI Flow</div><div class="stat-value" id="statNetAGI">&#8212;</div><div class="stat-detail">Adjusted gross income net inflow</div></div>
                    <div class="stat-card"><div class="stat-label">SBA Loans</div><div class="stat-value" id="statSBALoans">&#8212;</div><div class="stat-detail" id="statSBADetail">Total funded</div></div>
                    <div class="stat-card"><div class="stat-label">Jobs Supported</div><div class="stat-value" id="statJobs">&#8212;</div><div class="stat-detail">Via SBA-backed loans</div></div>
                    <div class="stat-card"><div class="stat-label">Data Period</div><div class="stat-value" id="statPeriod">&#8212;</div><div class="stat-detail">Tax years covered</div></div>
                </div>
                <div class="grid-1"><div class="card"><div class="card-header"><div class="card-title">&#127758; County Migration Net Flow</div><span class="badge badge-blue">IRS Data</span></div><div class="card-body" id="countyFlowChart"><div class="hawk-loader"><div class="hawk-spinner"></div> Loading...</div></div></div></div>
            </div>

            <div id="tab-migration" class="hawk-tab-content">
                <div class="grid-2">
                    <div class="card"><div class="card-header"><div class="card-title">&#11014;&#65039; Top Inflow Origins</div><span class="badge badge-green">People Moving In</span></div><div class="card-body" id="inflowTable"><div class="hawk-loader"><div class="hawk-spinner"></div> Loading...</div></div></div>
                    <div class="card"><div class="card-header"><div class="card-title">&#11015;&#65039; Top Outflow Destinations</div><span class="badge badge-red">People Moving Out</span></div><div class="card-body" id="outflowTable"><div class="hawk-loader"><div class="hawk-spinner"></div> Loading...</div></div></div>
                </div>
                <div class="grid-1"><div class="card"><div class="card-header"><div class="card-title">&#128200; Year-over-Year Migration Trend</div><span class="badge badge-blue">Annual Summary</span></div><div class="card-body" id="migrationTrend"><div class="hawk-loader"><div class="hawk-spinner"></div> Loading...</div></div></div></div>
            </div>

            <div id="tab-sba" class="hawk-tab-content">
                <div class="grid-2">
                    <div class="card"><div class="card-header"><div class="card-title">&#127974; Loans by Program</div><span class="badge badge-blue">SBA</span></div><div class="card-body" id="sbaProgramChart"><div class="hawk-loader"><div class="hawk-spinner"></div> Loading...</div></div></div>
                    <div class="card"><div class="card-header"><div class="card-title">&#128736;&#65039; Top Sectors (NAICS)</div><span class="badge badge-amber">Industry Breakdown</span></div><div class="card-body" id="sbaSectorChart"><div class="hawk-loader"><div class="hawk-spinner"></div> Loading...</div></div></div>
                </div>
                <div class="grid-1"><div class="card"><div class="card-header"><div class="card-title">&#128196; SBA Loan Database</div><div class="hawk-search"><input type="text" id="sbaSearchInput" placeholder="Search borrower, city, sector..." onkeyup="HAWK.debounceSearch()"></div></div><div class="card-body" id="sbaLoanTable" style="padding:0;"><div class="hawk-loader"><div class="hawk-spinner"></div> Loading...</div></div><div class="hawk-pagination" id="sbaPagination" style="display:none;"><button onclick="HAWK.sbaPage(-1)" id="sbaPrev">&#8592; Previous</button><span class="page-info" id="sbaPageInfo">Page 1 of 1</span><button onclick="HAWK.sbaPage(1)" id="sbaNext">Next &#8594;</button></div></div></div>
            </div>
        </div>
    </main>

<script>
var HAWK={currentTab:'overview',sbaCurrentPage:1,sbaSearchTimeout:null,fmt:{currency:function(v){if(!v&&v!==0)return'\u2014';if(Math.abs(v)>=1e9)return'$'+(v/1e9).toFixed(1)+'B';if(Math.abs(v)>=1e6)return'$'+(v/1e6).toFixed(1)+'M';if(Math.abs(v)>=1e3)return'$'+(v/1e3).toFixed(0)+'K';return'$'+v.toLocaleString()},number:function(v){if(!v&&v!==0)return'\u2014';return v.toLocaleString()},compact:function(v){if(!v&&v!==0)return'\u2014';if(Math.abs(v)>=1e6)return(v/1e6).toFixed(1)+'M';if(Math.abs(v)>=1e3)return(v/1e3).toFixed(1)+'K';return v.toLocaleString()}},switchTab:function(tab){this.currentTab=tab;document.querySelectorAll('.hawk-tab').forEach(function(t){t.classList.toggle('active',t.dataset.tab===tab)});document.querySelectorAll('.hawk-tab-content').forEach(function(c){c.classList.toggle('active',c.id==='tab-'+tab)})},getCounty:function(){return document.getElementById('hawkCountyFilter').value},loadAll:async function(){await Promise.all([this.loadOverview(),this.loadInflows(),this.loadOutflows(),this.loadMigrationTrend(),this.loadSBAPrograms(),this.loadSBASectors(),this.loadSBALoans()])},loadOverview:async function(){try{var c=this.getCounty(),qs=c?'?county='+encodeURIComponent(c):'',r=await fetch('/hawk/api/overview'+qs),d=await r.json();if(!d.success)throw new Error(d.error);var m=d.migration,s=d.sba;document.getElementById('statTotalRecords').textContent=this.fmt.compact(m.total_records+s.total_loans);var ne=document.getElementById('statNetMigration');ne.textContent=(m.net_inflow_returns>=0?'+':'')+this.fmt.compact(m.net_inflow_returns);ne.className='stat-value '+(m.net_inflow_returns>=0?'stat-positive':'stat-negative');var na=document.getElementById('statNetAGI');na.textContent=(m.net_agi>=0?'+':'')+this.fmt.currency(m.net_agi);na.className='stat-value '+(m.net_agi>=0?'stat-positive':'stat-negative');document.getElementById('statSBALoans').textContent=this.fmt.compact(s.total_loans);document.getElementById('statSBADetail').textContent=this.fmt.currency(s.total_funded)+' funded';document.getElementById('statJobs').textContent=this.fmt.compact(s.total_jobs);document.getElementById('statPeriod').textContent=m.period||'N/A';this.renderCountyFlow(d.county_breakdown)}catch(e){console.error('[HAWK] Overview:',e)}},renderCountyFlow:function(counties){var el=document.getElementById('countyFlowChart');if(!counties||!counties.length){el.innerHTML='<div class="hawk-empty">No county data</div>';return}var mx=Math.max.apply(null,counties.map(function(c){return Math.max(c.inflows,c.outflows)})),self=this,h='';counties.forEach(function(c){var ip=mx>0?(c.inflows/mx)*100:0,op=mx>0?(c.outflows/mx)*100:0,nc=c.net>=0?'positive':'negative',ns=c.net>=0?'+':'';h+='<div style="margin-bottom:16px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><span style="font-weight:600;font-size:13px">'+c.county+'</span><span class="net-flow '+nc+'">'+ns+self.fmt.compact(c.net)+' net | '+self.fmt.currency(c.net_agi)+' AGI</span></div><div class="bar-row" style="margin-bottom:4px"><span class="bar-label" style="width:60px;color:#059669">In</span><div class="bar-track"><div class="bar-fill bar-inflow" style="width:'+ip+'%"><span>'+self.fmt.compact(c.inflows)+'</span></div></div></div><div class="bar-row"><span class="bar-label" style="width:60px;color:#e11d48">Out</span><div class="bar-track"><div class="bar-fill bar-outflow" style="width:'+op+'%"><span>'+self.fmt.compact(c.outflows)+'</span></div></div></div></div>'});el.innerHTML=h},loadInflows:async function(){try{var c=this.getCounty(),qs=c?'?county='+encodeURIComponent(c)+'&limit=15':'?limit=15',r=await fetch('/hawk/api/migration/inflows'+qs),d=await r.json();if(!d.success)throw new Error(d.error);var el=document.getElementById('inflowTable');if(!d.data.length){el.innerHTML='<div class="hawk-empty">No inflow data</div>';return}var self=this,h='<table class="hawk-table"><thead><tr><th>Origin</th><th>Returns</th><th>AGI</th><th>Avg AGI</th></tr></thead><tbody>';d.data.forEach(function(r){h+='<tr><td><strong>'+r.origin+'</strong></td><td class="number">'+self.fmt.number(r.returns)+'</td><td class="currency">'+self.fmt.currency(r.agi)+'</td><td class="currency">'+self.fmt.currency(r.avg_agi)+'</td></tr>'});h+='</tbody></table>';el.innerHTML=h}catch(e){console.error('[HAWK] Inflows:',e)}},loadOutflows:async function(){try{var c=this.getCounty(),qs=c?'?county='+encodeURIComponent(c)+'&limit=15':'?limit=15',r=await fetch('/hawk/api/migration/outflows'+qs),d=await r.json();if(!d.success)throw new Error(d.error);var el=document.getElementById('outflowTable');if(!d.data.length){el.innerHTML='<div class="hawk-empty">No outflow data</div>';return}var self=this,h='<table class="hawk-table"><thead><tr><th>Destination</th><th>Returns</th><th>AGI</th><th>Avg AGI</th></tr></thead><tbody>';d.data.forEach(function(r){h+='<tr><td><strong>'+r.destination+'</strong></td><td class="number">'+self.fmt.number(r.returns)+'</td><td class="currency">'+self.fmt.currency(r.agi)+'</td><td class="currency">'+self.fmt.currency(r.avg_agi)+'</td></tr>'});h+='</tbody></table>';el.innerHTML=h}catch(e){console.error('[HAWK] Outflows:',e)}},loadMigrationTrend:async function(){try{var c=this.getCounty(),qs=c?'?county='+encodeURIComponent(c):'',r=await fetch('/hawk/api/migration/summary'+qs),d=await r.json();if(!d.success)throw new Error(d.error);var el=document.getElementById('migrationTrend');if(!d.data.length){el.innerHTML='<div class="hawk-empty">No trend data</div>';return}var self=this,h='<table class="hawk-table"><thead><tr><th>Year</th><th>Inflow</th><th>Outflow</th><th>Net</th><th>Inflow AGI</th><th>Outflow AGI</th><th>Net AGI</th></tr></thead><tbody>';d.data.forEach(function(r){var nc=r.net_returns>=0?'stat-positive':'stat-negative',nac=r.net_agi>=0?'stat-positive':'stat-negative';h+='<tr><td><strong>'+r.year+'</strong></td><td class="number">'+self.fmt.number(r.inflow_returns)+'</td><td class="number">'+self.fmt.number(r.outflow_returns)+'</td><td class="number '+nc+'">'+(r.net_returns>=0?'+':'')+self.fmt.number(r.net_returns)+'</td><td class="currency">'+self.fmt.currency(r.inflow_agi)+'</td><td class="currency">'+self.fmt.currency(r.outflow_agi)+'</td><td class="currency '+nac+'">'+(r.net_agi>=0?'+':'')+self.fmt.currency(r.net_agi)+'</td></tr>'});h+='</tbody></table>';el.innerHTML=h}catch(e){console.error('[HAWK] Trend:',e)}},loadSBAPrograms:async function(){try{var c=this.getCounty(),qs=c?'?county='+encodeURIComponent(c):'',r=await fetch('/hawk/api/sba/summary'+qs),d=await r.json();if(!d.success)throw new Error(d.error);var el=document.getElementById('sbaProgramChart');if(!d.by_program.length){el.innerHTML='<div class="hawk-empty">No program data</div>';return}var mx=Math.max.apply(null,d.by_program.map(function(p){return p.total_funded})),self=this,h='';d.by_program.forEach(function(p){var pct=mx>0?(p.total_funded/mx)*100:0;h+='<div class="bar-row"><span class="bar-label">'+p.program+' ('+self.fmt.compact(p.loans)+')</span><div class="bar-track"><div class="bar-fill bar-sba" style="width:'+pct+'%"><span>'+self.fmt.currency(p.total_funded)+'</span></div></div></div>'});el.innerHTML=h}catch(e){console.error('[HAWK] Programs:',e)}},loadSBASectors:async function(){try{var c=this.getCounty(),qs=c?'?county='+encodeURIComponent(c):'',r=await fetch('/hawk/api/sba/sectors'+qs),d=await r.json();if(!d.success)throw new Error(d.error);var el=document.getElementById('sbaSectorChart');if(!d.data.length){el.innerHTML='<div class="hawk-empty">No sector data</div>';return}var self=this,h='<table class="hawk-table"><thead><tr><th>Sector</th><th>Loans</th><th>Funded</th><th>Avg</th><th>Jobs</th></tr></thead><tbody>';d.data.slice(0,12).forEach(function(r){h+='<tr><td>'+(r.sector||r.naics_code)+'</td><td class="number">'+self.fmt.number(r.loans)+'</td><td class="currency">'+self.fmt.currency(r.total_funded)+'</td><td class="currency">'+self.fmt.currency(r.avg_loan)+'</td><td class="number">'+self.fmt.number(r.jobs)+'</td></tr>'});h+='</tbody></table>';el.innerHTML=h}catch(e){console.error('[HAWK] Sectors:',e)}},loadSBALoans:async function(page){try{if(page)this.sbaCurrentPage=page;var c=this.getCounty(),sr=document.getElementById('sbaSearchInput')?document.getElementById('sbaSearchInput').value:'',qs='?page='+this.sbaCurrentPage+'&limit=25';if(c)qs+='&county='+encodeURIComponent(c);if(sr)qs+='&search='+encodeURIComponent(sr);var r=await fetch('/hawk/api/sba/loans'+qs),d=await r.json();if(!d.success)throw new Error(d.error);var el=document.getElementById('sbaLoanTable');if(!d.data.length){el.innerHTML='<div class="hawk-empty">No loans found</div>';document.getElementById('sbaPagination').style.display='none';return}var self=this,h='<table class="hawk-table"><thead><tr><th>Borrower</th><th>City</th><th>County</th><th>Program</th><th>Amount</th><th>Date</th><th>Sector</th><th>Jobs</th><th>Lender</th></tr></thead><tbody>';d.data.forEach(function(r){var dt=r.approval_date?new Date(r.approval_date).toLocaleDateString():'\u2014';h+='<tr><td><strong>'+(r.borrower_name||'\u2014')+'</strong></td><td>'+(r.borrower_city||'\u2014')+'</td><td>'+(r.county||'\u2014')+'</td><td><span class="badge badge-blue">'+(r.program||'\u2014')+'</span></td><td class="currency">'+self.fmt.currency(r.approval_amount)+'</td><td>'+dt+'</td><td>'+((r.naics_description||'').substring(0,30))+'</td><td class="number">'+(r.jobs_supported||0)+'</td><td>'+((r.lender_name||'').substring(0,22))+'</td></tr>'});h+='</tbody></table>';el.innerHTML=h;var pg=document.getElementById('sbaPagination');pg.style.display='flex';document.getElementById('sbaPageInfo').textContent='Page '+d.page+' of '+d.pages+' ('+self.fmt.number(d.total)+' loans)';document.getElementById('sbaPrev').disabled=d.page<=1;document.getElementById('sbaNext').disabled=d.page>=d.pages}catch(e){console.error('[HAWK] Loans:',e)}},sbaPage:function(delta){this.loadSBALoans(this.sbaCurrentPage+delta)},debounceSearch:function(){clearTimeout(this.sbaSearchTimeout);var self=this;this.sbaSearchTimeout=setTimeout(function(){self.sbaCurrentPage=1;self.loadSBALoans()},400)}};
document.addEventListener('DOMContentLoaded',function(){HAWK.loadAll();document.getElementById('hawkCountyFilter').addEventListener('change',function(){HAWK.loadAll()})});
</script>
<%- include('partials/notification-bubble') %>
</body>
</html>
