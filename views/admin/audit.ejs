<!DOCTYPE html>
<html lang="en" data-theme="<%= typeof theme !== 'undefined' ? theme : 'light' %>">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Log - CRE OS</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/css/theme.css">
    <script src="/js/theme.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f1724; color: #e2e8f0; min-height: 100vh; display: flex; }

        .sidebar { width: 240px; background: #1a2332; display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.06); position: fixed; top: 0; bottom: 0; left: 0; z-index: 100; }
        .main-content { flex: 1; margin-left: 240px; min-height: 100vh; }

        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 16px 32px; border-bottom: 1px solid rgba(255,255,255,0.06); background: #1a2332; }
        .top-bar h1 { font-size: 1.35rem; font-weight: 700; }
        .top-bar h1 .accent { color: #f59e0b; }

        .admin-tabs { display: flex; gap: 4px; padding: 12px 32px 0; background: #1a2332; }
        .admin-tab { padding: 10px 20px; border-radius: 8px 8px 0 0; font-size: 0.85rem; font-weight: 500; color: #64748b; text-decoration: none; display: flex; align-items: center; gap: 8px; transition: all 0.15s; border: 1px solid transparent; border-bottom: none; }
        .admin-tab:hover { color: #e2e8f0; background: rgba(255,255,255,0.03); }
        .admin-tab.active { color: #f59e0b; background: #0f1724; border-color: rgba(255,255,255,0.06); }

        .content { padding: 24px 32px; }

        .filters-bar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-label { font-size: 0.8rem; color: #64748b; }
        .filter-select, .filter-input { padding: 8px 12px; background: #1a2332; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e2e8f0; font-size: 0.85rem; min-width: 150px; }
        .filter-select:focus, .filter-input:focus { outline: none; border-color: #f59e0b; }
        .filter-input { min-width: 200px; }

        .btn { padding: 8px 16px; border-radius: 8px; font-size: 0.85rem; font-weight: 500; border: none; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; transition: all 0.15s; }
        .btn-primary { background: #f59e0b; color: #000; }
        .btn-primary:hover { background: #d97706; }
        .btn-secondary { background: rgba(255,255,255,0.06); color: #e2e8f0; }
        .btn-secondary:hover { background: rgba(255,255,255,0.1); }

        .card { background: #1a2332; border-radius: 12px; padding: 20px; border: 1px solid rgba(255,255,255,0.06); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .card-title { font-size: 1rem; font-weight: 600; color: #e2e8f0; display: flex; align-items: center; gap: 8px; }
        .card-title i { color: #64748b; }

        .audit-table { width: 100%; border-collapse: collapse; }
        .audit-table th { text-align: left; padding: 12px 16px; font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .audit-table td { padding: 14px 16px; font-size: 0.85rem; border-bottom: 1px solid rgba(255,255,255,0.04); vertical-align: top; }
        .audit-table tr:hover { background: rgba(255,255,255,0.02); }

        .audit-time { color: #64748b; font-size: 0.8rem; white-space: nowrap; }
        .audit-time .date { display: block; }
        .audit-time .time { font-size: 0.75rem; opacity: 0.7; }

        .audit-user { display: flex; align-items: center; gap: 10px; }
        .audit-avatar { width: 32px; height: 32px; border-radius: 50%; background: #10b981; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; color: #fff; flex-shrink: 0; }
        .audit-user-info { }
        .audit-user-name { color: #e2e8f0; font-weight: 500; }
        .audit-user-email { color: #64748b; font-size: 0.75rem; }

        .audit-action { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 500; }
        .audit-action.create { background: rgba(16,185,129,0.12); color: #10b981; }
        .audit-action.update { background: rgba(59,130,246,0.12); color: #3b82f6; }
        .audit-action.delete { background: rgba(239,68,68,0.12); color: #ef4444; }
        .audit-action.status { background: rgba(245,158,11,0.12); color: #f59e0b; }
        .audit-action.login { background: rgba(139,92,246,0.12); color: #8b5cf6; }
        .audit-action.other { background: rgba(100,116,139,0.12); color: #94a3b8; }

        .audit-details { max-width: 300px; }
        .audit-entity { color: #e2e8f0; font-weight: 500; margin-bottom: 4px; }
        .audit-changes { font-size: 0.75rem; color: #64748b; }
        .audit-change-item { display: flex; gap: 4px; margin-top: 2px; }
        .audit-change-item .field { color: #94a3b8; }
        .audit-change-item .old { color: #ef4444; text-decoration: line-through; }
        .audit-change-item .new { color: #10b981; }

        .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.06); }
        .pagination-info { font-size: 0.85rem; color: #64748b; }
        .pagination-buttons { display: flex; gap: 8px; }
        .page-btn { padding: 8px 14px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #94a3b8; font-size: 0.85rem; cursor: pointer; transition: all 0.15s; }
        .page-btn:hover:not(:disabled) { background: rgba(255,255,255,0.08); color: #e2e8f0; }
        .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .page-btn.active { background: #f59e0b; color: #000; border-color: #f59e0b; }

        .empty-state { text-align: center; padding: 50px; color: #64748b; }
        .empty-state i { font-size: 3rem; margin-bottom: 16px; opacity: 0.4; }

        .loading { text-align: center; padding: 40px; color: #64748b; }
        .loading i { font-size: 2rem; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
        .stat-mini { background: #1a2332; border-radius: 10px; padding: 16px; border: 1px solid rgba(255,255,255,0.06); }
        .stat-mini-value { font-size: 1.5rem; font-weight: 700; color: #e2e8f0; }
        .stat-mini-label { font-size: 0.75rem; color: #64748b; margin-top: 4px; }

        @media (max-width: 1200px) { .stats-row { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .filters-bar { flex-direction: column; align-items: stretch; } .filter-group { flex-direction: column; align-items: stretch; } }
    </style>
</head>
<body>
    <%- include('../partials/sidebar') %>

    <div class="main-content">
        <div class="top-bar">
            <h1><span class="accent">ðŸ“‹ Audit</span> Log</h1>
            <button class="btn btn-secondary" onclick="exportAudit()"><i class="bi bi-download"></i> Export CSV</button>
        </div>

        <div class="admin-tabs">
            <a href="/system" class="admin-tab"><i class="bi bi-speedometer2"></i> Overview</a>
            <a href="/system/users" class="admin-tab"><i class="bi bi-people"></i> Users</a>
            <a href="/system/roles" class="admin-tab"><i class="bi bi-shield"></i> Roles</a>
            <a href="/system/audit" class="admin-tab active"><i class="bi bi-clock-history"></i> Audit Log</a>
        </div>

        <div class="content">
            <div class="stats-row">
                <div class="stat-mini">
                    <div class="stat-mini-value" id="statTotal">--</div>
                    <div class="stat-mini-label">Total Events (24h)</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-value" id="statLogins">--</div>
                    <div class="stat-mini-label">Login Events</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-value" id="statChanges">--</div>
                    <div class="stat-mini-label">Data Changes</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-value" id="statUsers">--</div>
                    <div class="stat-mini-label">Active Users</div>
                </div>
            </div>

            <div class="filters-bar">
                <div class="filter-group">
                    <label class="filter-label">User:</label>
                    <select class="filter-select" id="filterUser" onchange="loadAudit()">
                        <option value="">All Users</option>
                        <% users.forEach(u => { %>
                            <option value="<%= u.id %>"><%= u.name %></option>
                        <% }); %>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Action:</label>
                    <select class="filter-select" id="filterAction" onchange="loadAudit()">
                        <option value="">All Actions</option>
                        <option value="user.">User Management</option>
                        <option value="role.">Role Changes</option>
                        <option value="login">Login Events</option>
                        <option value="permission">Permission Changes</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Search:</label>
                    <input type="text" class="filter-input" id="filterSearch" placeholder="Search audit log..." oninput="debounceSearch()">
                </div>
                <button class="btn btn-secondary" onclick="resetFilters()"><i class="bi bi-x-lg"></i> Clear</button>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title"><i class="bi bi-clock-history"></i> Activity History</div>
                    <span style="font-size: 0.8rem; color: #64748b;" id="resultCount">Loading...</span>
                </div>

                <div id="auditContent">
                    <div class="loading">
                        <i class="bi bi-arrow-repeat"></i>
                        <p style="margin-top: 12px;">Loading audit log...</p>
                    </div>
                </div>

                <div class="pagination" id="pagination" style="display: none;">
                    <div class="pagination-info" id="paginationInfo">Showing 1-50 of 100</div>
                    <div class="pagination-buttons" id="paginationButtons"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        const limit = 50;
        let searchTimeout;

        async function loadAudit() {
            const userId = document.getElementById('filterUser').value;
            const action = document.getElementById('filterAction').value;
            const search = document.getElementById('filterSearch').value;

            const params = new URLSearchParams();
            if (userId) params.append('user_id', userId);
            if (action) params.append('action', action);
            if (search) params.append('search', search);
            params.append('limit', limit);
            params.append('offset', (currentPage - 1) * limit);

            try {
                const res = await fetch(`/system/api/audit?${params}`);
                const data = await res.json();

                if (!data.success) throw new Error(data.error);

                renderAudit(data.audit, data.total);
                updateStats(data.stats);
            } catch (err) {
                document.getElementById('auditContent').innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-exclamation-triangle"></i>
                        <p>Error loading audit log: ${err.message}</p>
                    </div>
                `;
            }
        }

        function renderAudit(audit, total) {
            const content = document.getElementById('auditContent');
            const pagination = document.getElementById('pagination');

            if (audit.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-clock-history"></i>
                        <p>No audit events found</p>
                    </div>
                `;
                pagination.style.display = 'none';
                document.getElementById('resultCount').textContent = '0 events';
                return;
            }

            document.getElementById('resultCount').textContent = `${total} events`;

            let html = `
                <table class="audit-table">
                    <thead>
                        <tr>
                            <th style="width: 140px;">Time</th>
                            <th style="width: 200px;">User</th>
                            <th style="width: 140px;">Action</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            audit.forEach(entry => {
                const date = new Date(entry.created_at);
                const actionClass = getActionClass(entry.action);
                const actionLabel = formatAction(entry.action);
                const initials = getInitials(entry.user_name || 'System');

                html += `
                    <tr>
                        <td class="audit-time">
                            <span class="date">${date.toLocaleDateString()}</span>
                            <span class="time">${date.toLocaleTimeString()}</span>
                        </td>
                        <td>
                            <div class="audit-user">
                                <div class="audit-avatar">${initials}</div>
                                <div class="audit-user-info">
                                    <div class="audit-user-name">${entry.user_name || 'System'}</div>
                                    <div class="audit-user-email">${entry.user_email || ''}</div>
                                </div>
                            </div>
                        </td>
                        <td><span class="audit-action ${actionClass}">${actionLabel}</span></td>
                        <td class="audit-details">
                            ${formatDetails(entry)}
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            content.innerHTML = html;

            // Pagination
            const totalPages = Math.ceil(total / limit);
            if (totalPages > 1) {
                pagination.style.display = 'flex';
                const start = (currentPage - 1) * limit + 1;
                const end = Math.min(currentPage * limit, total);
                document.getElementById('paginationInfo').textContent = `Showing ${start}-${end} of ${total}`;

                let buttons = '';
                buttons += `<button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}><i class="bi bi-chevron-left"></i></button>`;
                
                for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                    buttons += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
                }
                
                buttons += `<button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}><i class="bi bi-chevron-right"></i></button>`;
                document.getElementById('paginationButtons').innerHTML = buttons;
            } else {
                pagination.style.display = 'none';
            }
        }

        function updateStats(stats) {
            if (!stats) return;
            document.getElementById('statTotal').textContent = stats.total_24h || 0;
            document.getElementById('statLogins').textContent = stats.logins || 0;
            document.getElementById('statChanges').textContent = stats.changes || 0;
            document.getElementById('statUsers').textContent = stats.active_users || 0;
        }

        function getActionClass(action) {
            if (action.includes('create') || action.includes('add')) return 'create';
            if (action.includes('update') || action.includes('edit')) return 'update';
            if (action.includes('delete') || action.includes('remove')) return 'delete';
            if (action.includes('status') || action.includes('freeze') || action.includes('terminate')) return 'status';
            if (action.includes('login') || action.includes('logout')) return 'login';
            return 'other';
        }

        function formatAction(action) {
            return action
                .replace(/\./g, ' ')
                .replace(/_/g, ' ')
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        function formatDetails(entry) {
            let html = '';
            
            if (entry.entity_type) {
                html += `<div class="audit-entity">${entry.entity_type} #${entry.entity_id || ''}</div>`;
            }

            if (entry.old_value || entry.new_value) {
                html += '<div class="audit-changes">';
                try {
                    const oldVal = entry.old_value ? JSON.parse(entry.old_value) : {};
                    const newVal = entry.new_value ? JSON.parse(entry.new_value) : {};
                    
                    const allKeys = new Set([...Object.keys(oldVal), ...Object.keys(newVal)]);
                    allKeys.forEach(key => {
                        if (oldVal[key] !== newVal[key]) {
                            html += `<div class="audit-change-item">
                                <span class="field">${key}:</span>
                                ${oldVal[key] ? `<span class="old">${oldVal[key]}</span>` : ''}
                                ${oldVal[key] && newVal[key] ? 'â†’' : ''}
                                ${newVal[key] ? `<span class="new">${newVal[key]}</span>` : ''}
                            </div>`;
                        }
                    });
                } catch (e) {
                    html += entry.new_value || '';
                }
                html += '</div>';
            }

            return html || '<span style="color: #64748b;">-</span>';
        }

        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        }

        function goToPage(page) {
            currentPage = page;
            loadAudit();
        }

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentPage = 1;
                loadAudit();
            }, 300);
        }

        function resetFilters() {
            document.getElementById('filterUser').value = '';
            document.getElementById('filterAction').value = '';
            document.getElementById('filterSearch').value = '';
            currentPage = 1;
            loadAudit();
        }

        function exportAudit() {
            const userId = document.getElementById('filterUser').value;
            const action = document.getElementById('filterAction').value;
            
            const params = new URLSearchParams();
            if (userId) params.append('user_id', userId);
            if (action) params.append('action', action);
            params.append('format', 'csv');
            
            window.location.href = `/system/api/audit/export?${params}`;
        }

        // Load on page ready
        loadAudit();
    </script>
</body>
</html>
