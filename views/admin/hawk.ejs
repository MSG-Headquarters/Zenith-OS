<%- include('partials/header', { title: 'HAWK — Deal Velocity Engine', activePage: 'hawk' }) %>

<style>
    /* ════════════════════════════════════════ */
    /* HAWK Dashboard Styles                    */
    /* ════════════════════════════════════════ */

    .hawk-container {
        padding: 24px 28px;
        max-width: 1600px;
        margin: 0 auto;
    }

    /* Header */
    .hawk-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .hawk-header-left {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .hawk-logo {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        box-shadow: 0 4px 12px rgba(15, 52, 96, 0.3);
    }

    .hawk-title h1 {
        font-size: 22px;
        font-weight: 700;
        color: #1a1a2e;
        margin: 0;
        letter-spacing: -0.3px;
    }

    .hawk-title p {
        font-size: 13px;
        color: #6b7280;
        margin: 2px 0 0 0;
    }

    .hawk-filters {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .hawk-filter-select {
        padding: 8px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 13px;
        background: #fff;
        color: #374151;
        cursor: pointer;
        transition: border-color 0.2s;
    }

    .hawk-filter-select:focus {
        outline: none;
        border-color: #0f3460;
        box-shadow: 0 0 0 3px rgba(15, 52, 96, 0.1);
    }

    .hawk-refresh-btn {
        padding: 8px 16px;
        background: #0f3460;
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .hawk-refresh-btn:hover {
        background: #1a4a7a;
        transform: translateY(-1px);
    }

    /* Stat Cards Row */
    .hawk-stat-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .hawk-stat-card {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        border: 1px solid #f0f0f5;
        transition: all 0.25s;
    }

    .hawk-stat-card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        transform: translateY(-2px);
    }

    .hawk-stat-card .stat-label {
        font-size: 12px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
    }

    .hawk-stat-card .stat-value {
        font-size: 26px;
        font-weight: 700;
        color: #1a1a2e;
        line-height: 1.2;
    }

    .hawk-stat-card .stat-detail {
        font-size: 12px;
        color: #9ca3af;
        margin-top: 4px;
    }

    .stat-positive { color: #059669 !important; }
    .stat-negative { color: #dc2626 !important; }

    /* Section Cards */
    .hawk-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 24px;
    }

    .hawk-grid-full {
        grid-template-columns: 1fr;
    }

    .hawk-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        border: 1px solid #f0f0f5;
        overflow: hidden;
    }

    .hawk-card-header {
        padding: 16px 20px;
        border-bottom: 1px solid #f0f0f5;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .hawk-card-header h3 {
        font-size: 15px;
        font-weight: 700;
        color: #1a1a2e;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .hawk-card-header .badge {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 100px;
        font-weight: 600;
    }

    .badge-blue { background: #eff6ff; color: #2563eb; }
    .badge-green { background: #ecfdf5; color: #059669; }
    .badge-amber { background: #fffbeb; color: #d97706; }
    .badge-red { background: #fef2f2; color: #dc2626; }

    .hawk-card-body {
        padding: 16px 20px;
    }

    /* Tables */
    .hawk-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }

    .hawk-table thead th {
        text-align: left;
        padding: 10px 12px;
        font-weight: 600;
        color: #6b7280;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #f0f0f5;
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
    }

    .hawk-table thead th:hover {
        color: #0f3460;
    }

    .hawk-table tbody td {
        padding: 10px 12px;
        border-bottom: 1px solid #f7f7fa;
        color: #374151;
    }

    .hawk-table tbody tr:hover {
        background: #f8fafc;
    }

    .hawk-table tbody tr:last-child td {
        border-bottom: none;
    }

    .currency { font-family: 'SF Mono', 'Fira Code', monospace; font-weight: 600; }
    .number { font-family: 'SF Mono', 'Fira Code', monospace; }

    /* Bar Chart (CSS-only) */
    .hawk-bar-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 10px;
    }

    .hawk-bar-label {
        width: 160px;
        font-size: 12px;
        font-weight: 500;
        color: #374151;
        flex-shrink: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .hawk-bar-track {
        flex: 1;
        height: 24px;
        background: #f3f4f6;
        border-radius: 6px;
        overflow: hidden;
        position: relative;
    }

    .hawk-bar-fill {
        height: 100%;
        border-radius: 6px;
        transition: width 0.8s ease-out;
        display: flex;
        align-items: center;
        padding-left: 8px;
    }

    .hawk-bar-fill span {
        font-size: 11px;
        font-weight: 600;
        color: #fff;
        white-space: nowrap;
    }

    .bar-inflow { background: linear-gradient(90deg, #059669, #34d399); }
    .bar-outflow { background: linear-gradient(90deg, #dc2626, #f87171); }
    .bar-sba { background: linear-gradient(90deg, #2563eb, #60a5fa); }

    /* Loader */
    .hawk-loader {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        color: #9ca3af;
        font-size: 14px;
        gap: 12px;
    }

    .hawk-spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #e5e7eb;
        border-top-color: #0f3460;
        border-radius: 50%;
        animation: hawk-spin 0.7s linear infinite;
    }

    @keyframes hawk-spin {
        to { transform: rotate(360deg); }
    }

    /* Net Flow Indicator */
    .net-flow {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-weight: 700;
        font-size: 14px;
    }

    .net-flow.positive { color: #059669; }
    .net-flow.negative { color: #dc2626; }

    /* Empty State */
    .hawk-empty {
        text-align: center;
        padding: 40px;
        color: #9ca3af;
    }

    /* Pagination */
    .hawk-pagination {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 20px;
        border-top: 1px solid #f0f0f5;
    }

    .hawk-pagination button {
        padding: 6px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        background: #fff;
        color: #374151;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .hawk-pagination button:hover:not(:disabled) {
        background: #f8fafc;
        border-color: #0f3460;
        color: #0f3460;
    }

    .hawk-pagination button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .hawk-pagination .page-info {
        font-size: 12px;
        color: #6b7280;
    }

    /* Search Bar */
    .hawk-search {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .hawk-search input {
        padding: 7px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 12px;
        width: 200px;
        transition: border-color 0.2s;
    }

    .hawk-search input:focus {
        outline: none;
        border-color: #0f3460;
        box-shadow: 0 0 0 3px rgba(15, 52, 96, 0.1);
    }

    /* Tab System */
    .hawk-tabs {
        display: flex;
        gap: 4px;
        padding: 4px;
        background: #f3f4f6;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .hawk-tab {
        padding: 8px 20px;
        border: none;
        background: transparent;
        color: #6b7280;
        font-size: 13px;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .hawk-tab.active {
        background: #fff;
        color: #0f3460;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .hawk-tab:hover:not(.active) {
        color: #374151;
    }

    .hawk-tab-content {
        display: none;
    }

    .hawk-tab-content.active {
        display: block;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .hawk-grid { grid-template-columns: 1fr; }
        .hawk-stat-row { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 640px) {
        .hawk-stat-row { grid-template-columns: 1fr; }
        .hawk-header { flex-direction: column; align-items: flex-start; }
    }
</style>

<div class="hawk-container">

    <!-- Header -->
    <div class="hawk-header">
        <div class="hawk-header-left">
            <div class="hawk-logo">&#129413;</div>
            <div class="hawk-title">
                <h1>HAWK — Deal Velocity Engine</h1>
                <p>IRS Migration Intelligence + SBA Loan Signals | SWFL Market</p>
            </div>
        </div>
        <div class="hawk-filters">
            <select id="hawkCountyFilter" class="hawk-filter-select">
                <option value="">All Counties</option>
                <option value="Lee">Lee County</option>
                <option value="Collier">Collier County</option>
                <option value="Charlotte">Charlotte County</option>
                <option value="Sarasota">Sarasota County</option>
                <option value="Manatee">Manatee County</option>
                <option value="Hillsborough">Hillsborough County</option>
                <option value="Pinellas">Pinellas County</option>
                <option value="Palm Beach">Palm Beach County</option>
                <option value="Broward">Broward County</option>
                <option value="Miami-Dade">Miami-Dade County</option>
                <option value="Orange">Orange County</option>
                <option value="Duval">Duval County</option>
            </select>
            <button class="hawk-refresh-btn" onclick="HAWK.loadAll()">
                &#8635; Refresh
            </button>
        </div>
    </div>

    <!-- Tabs -->
    <div class="hawk-tabs">
        <button class="hawk-tab active" data-tab="overview" onclick="HAWK.switchTab('overview')">Overview</button>
        <button class="hawk-tab" data-tab="migration" onclick="HAWK.switchTab('migration')">Migration Intelligence</button>
        <button class="hawk-tab" data-tab="sba" onclick="HAWK.switchTab('sba')">SBA Loans</button>
    </div>

    <!-- ═══════════════════════════════════ -->
    <!-- TAB: Overview                       -->
    <!-- ═══════════════════════════════════ -->
    <div id="tab-overview" class="hawk-tab-content active">

        <!-- Stat Cards -->
        <div class="hawk-stat-row" id="hawkStatRow">
            <div class="hawk-stat-card">
                <div class="stat-label">Total Records</div>
                <div class="stat-value" id="statTotalRecords">—</div>
                <div class="stat-detail">Migration + SBA combined</div>
            </div>
            <div class="hawk-stat-card">
                <div class="stat-label">Net Migration</div>
                <div class="stat-value" id="statNetMigration">—</div>
                <div class="stat-detail" id="statNetMigrationDetail">Tax returns (inflow − outflow)</div>
            </div>
            <div class="hawk-stat-card">
                <div class="stat-label">Net AGI Flow</div>
                <div class="stat-value" id="statNetAGI">—</div>
                <div class="stat-detail">Adjusted gross income net inflow</div>
            </div>
            <div class="hawk-stat-card">
                <div class="stat-label">SBA Loans</div>
                <div class="stat-value" id="statSBALoans">—</div>
                <div class="stat-detail" id="statSBADetail">Total funded</div>
            </div>
            <div class="hawk-stat-card">
                <div class="stat-label">Jobs Supported</div>
                <div class="stat-value" id="statJobs">—</div>
                <div class="stat-detail">Via SBA-backed loans</div>
            </div>
            <div class="hawk-stat-card">
                <div class="stat-label">Data Period</div>
                <div class="stat-value" id="statPeriod">—</div>
                <div class="stat-detail">Tax years covered</div>
            </div>
        </div>

        <!-- County Breakdown -->
        <div class="hawk-grid hawk-grid-full">
            <div class="hawk-card">
                <div class="hawk-card-header">
                    <h3>&#127758; County Migration Net Flow</h3>
                    <span class="badge badge-blue">IRS Data</span>
                </div>
                <div class="hawk-card-body" id="countyFlowChart">
                    <div class="hawk-loader"><div class="hawk-spinner"></div> Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════ -->
    <!-- TAB: Migration Intelligence         -->
    <!-- ═══════════════════════════════════ -->
    <div id="tab-migration" class="hawk-tab-content">

        <div class="hawk-grid">
            <!-- Top Inflow Origins -->
            <div class="hawk-card">
                <div class="hawk-card-header">
                    <h3>&#11014;&#65039; Top Inflow Origins</h3>
                    <span class="badge badge-green">People Moving In</span>
                </div>
                <div class="hawk-card-body" id="inflowTable">
                    <div class="hawk-loader"><div class="hawk-spinner"></div> Loading...</div>
                </div>
            </div>

            <!-- Top Outflow Destinations -->
            <div class="hawk-card">
                <div class="hawk-card-header">
                    <h3>&#11015;&#65039; Top Outflow Destinations</h3>
                    <span class="badge badge-red">People Moving Out</span>
                </div>
                <div class="hawk-card-body" id="outflowTable">
                    <div class="hawk-loader"><div class="hawk-spinner"></div> Loading...</div>
                </div>
            </div>
        </div>

        <!-- Year-over-Year Trend -->
        <div class="hawk-grid hawk-grid-full">
            <div class="hawk-card">
                <div class="hawk-card-header">
                    <h3>&#128200; Year-over-Year Migration Trend</h3>
                    <span class="badge badge-blue">Annual Summary</span>
                </div>
                <div class="hawk-card-body" id="migrationTrend">
                    <div class="hawk-loader"><div class="hawk-spinner"></div> Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════ -->
    <!-- TAB: SBA Loans                      -->
    <!-- ═══════════════════════════════════ -->
    <div id="tab-sba" class="hawk-tab-content">

        <!-- SBA Summary Cards -->
        <div class="hawk-grid">
            <!-- By Program -->
            <div class="hawk-card">
                <div class="hawk-card-header">
                    <h3>&#127974; Loans by Program</h3>
                    <span class="badge badge-blue">SBA</span>
                </div>
                <div class="hawk-card-body" id="sbaProgramChart">
                    <div class="hawk-loader"><div class="hawk-spinner"></div> Loading...</div>
                </div>
            </div>

            <!-- Top Sectors -->
            <div class="hawk-card">
                <div class="hawk-card-header">
                    <h3>&#128736;&#65039; Top Sectors (NAICS)</h3>
                    <span class="badge badge-amber">Industry Breakdown</span>
                </div>
                <div class="hawk-card-body" id="sbaSectorChart">
                    <div class="hawk-loader"><div class="hawk-spinner"></div> Loading...</div>
                </div>
            </div>
        </div>

        <!-- SBA Loan Table -->
        <div class="hawk-grid hawk-grid-full">
            <div class="hawk-card">
                <div class="hawk-card-header">
                    <h3>&#128196; SBA Loan Database</h3>
                    <div class="hawk-search">
                        <input type="text" id="sbaSearchInput" placeholder="Search borrower, city, sector..." onkeyup="HAWK.debounceSearch()">
                    </div>
                </div>
                <div class="hawk-card-body" id="sbaLoanTable" style="padding: 0;">
                    <div class="hawk-loader"><div class="hawk-spinner"></div> Loading...</div>
                </div>
                <div class="hawk-pagination" id="sbaPagination" style="display:none;">
                    <button onclick="HAWK.sbaPage(-1)" id="sbaPrev">&#8592; Previous</button>
                    <span class="page-info" id="sbaPageInfo">Page 1 of 1</span>
                    <button onclick="HAWK.sbaPage(1)" id="sbaNext">Next &#8594;</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
// ═══════════════════════════════════════════════════════════════
// HAWK Dashboard Controller
// ═══════════════════════════════════════════════════════════════
const HAWK = {
    currentTab: 'overview',
    sbaCurrentPage: 1,
    sbaSearchTimeout: null,

    // ── Format Helpers ──
    fmt: {
        currency(val) {
            if (!val && val !== 0) return '—';
            if (Math.abs(val) >= 1e9) return '$' + (val / 1e9).toFixed(1) + 'B';
            if (Math.abs(val) >= 1e6) return '$' + (val / 1e6).toFixed(1) + 'M';
            if (Math.abs(val) >= 1e3) return '$' + (val / 1e3).toFixed(0) + 'K';
            return '$' + val.toLocaleString();
        },
        number(val) {
            if (!val && val !== 0) return '—';
            return val.toLocaleString();
        },
        compact(val) {
            if (!val && val !== 0) return '—';
            if (Math.abs(val) >= 1e6) return (val / 1e6).toFixed(1) + 'M';
            if (Math.abs(val) >= 1e3) return (val / 1e3).toFixed(1) + 'K';
            return val.toLocaleString();
        }
    },

    // ── Tab Switching ──
    switchTab(tab) {
        this.currentTab = tab;
        document.querySelectorAll('.hawk-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
        document.querySelectorAll('.hawk-tab-content').forEach(c => c.classList.toggle('active', c.id === 'tab-' + tab));
    },

    // ── Get County Filter ──
    getCounty() {
        return document.getElementById('hawkCountyFilter').value;
    },

    // ── Load Everything ──
    async loadAll() {
        await Promise.all([
            this.loadOverview(),
            this.loadInflows(),
            this.loadOutflows(),
            this.loadMigrationTrend(),
            this.loadSBAPrograms(),
            this.loadSBASectors(),
            this.loadSBALoans()
        ]);
    },

    // ── Overview Stats ──
    async loadOverview() {
        try {
            const county = this.getCounty();
            const qs = county ? `?county=${encodeURIComponent(county)}` : '';
            const res = await fetch('/hawk/api/overview' + qs);
            const data = await res.json();
            if (!data.success) throw new Error(data.error);

            const m = data.migration;
            const s = data.sba;

            document.getElementById('statTotalRecords').textContent = this.fmt.compact(m.total_records + s.total_loans);
            
            const netEl = document.getElementById('statNetMigration');
            netEl.textContent = (m.net_inflow_returns >= 0 ? '+' : '') + this.fmt.compact(m.net_inflow_returns);
            netEl.className = 'stat-value ' + (m.net_inflow_returns >= 0 ? 'stat-positive' : 'stat-negative');

            const netAgiEl = document.getElementById('statNetAGI');
            netAgiEl.textContent = (m.net_agi >= 0 ? '+' : '') + this.fmt.currency(m.net_agi * 1000);
            netAgiEl.className = 'stat-value ' + (m.net_agi >= 0 ? 'stat-positive' : 'stat-negative');

            document.getElementById('statSBALoans').textContent = this.fmt.compact(s.total_loans);
            document.getElementById('statSBADetail').textContent = this.fmt.currency(s.total_funded) + ' funded';
            document.getElementById('statJobs').textContent = this.fmt.compact(s.total_jobs);
            document.getElementById('statPeriod').textContent = m.period || 'N/A';

            // County flow chart
            this.renderCountyFlow(data.county_breakdown);
        } catch (err) {
            console.error('[HAWK] Overview error:', err);
        }
    },

    // ── County Flow Chart ──
    renderCountyFlow(counties) {
        const el = document.getElementById('countyFlowChart');
        if (!counties || counties.length === 0) {
            el.innerHTML = '<div class="hawk-empty">No county data available</div>';
            return;
        }

        const maxVal = Math.max(...counties.map(c => Math.max(c.inflows, c.outflows)));
        
        let html = '';
        counties.forEach(c => {
            const inflowPct = maxVal > 0 ? (c.inflows / maxVal) * 100 : 0;
            const outflowPct = maxVal > 0 ? (c.outflows / maxVal) * 100 : 0;
            const net = c.net;
            const netClass = net >= 0 ? 'positive' : 'negative';
            const netSign = net >= 0 ? '+' : '';

            html += `
                <div style="margin-bottom: 16px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                        <span style="font-weight:600; font-size:13px; color:#374151;">${c.county}</span>
                        <span class="net-flow ${netClass}">${netSign}${this.fmt.compact(net)} net | ${this.fmt.currency(c.net_agi * 1000)} AGI</span>
                    </div>
                    <div class="hawk-bar-row" style="margin-bottom:4px;">
                        <span class="hawk-bar-label" style="width:60px; color:#059669;">In</span>
                        <div class="hawk-bar-track">
                            <div class="hawk-bar-fill bar-inflow" style="width:${inflowPct}%;">
                                <span>${this.fmt.compact(c.inflows)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="hawk-bar-row">
                        <span class="hawk-bar-label" style="width:60px; color:#dc2626;">Out</span>
                        <div class="hawk-bar-track">
                            <div class="hawk-bar-fill bar-outflow" style="width:${outflowPct}%;">
                                <span>${this.fmt.compact(c.outflows)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        el.innerHTML = html;
    },

    // ── Migration: Inflows ──
    async loadInflows() {
        try {
            const county = this.getCounty();
            const qs = county ? `?county=${encodeURIComponent(county)}&limit=15` : '?limit=15';
            const res = await fetch('/hawk/api/migration/inflows' + qs);
            const data = await res.json();
            if (!data.success) throw new Error(data.error);

            const el = document.getElementById('inflowTable');
            if (!data.data.length) {
                el.innerHTML = '<div class="hawk-empty">No inflow data</div>';
                return;
            }

            let html = `<table class="hawk-table">
                <thead><tr>
                    <th>Origin</th>
                    <th>Returns</th>
                    <th>AGI ($K)</th>
                    <th>Avg AGI/Return</th>
                </tr></thead><tbody>`;

            data.data.forEach(r => {
                html += `<tr>
                    <td><strong>${r.origin}</strong></td>
                    <td class="number">${this.fmt.number(r.returns)}</td>
                    <td class="currency">${this.fmt.currency(r.agi * 1000)}</td>
                    <td class="currency">${this.fmt.currency(r.avg_agi * 1000)}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            el.innerHTML = html;
        } catch (err) {
            console.error('[HAWK] Inflows error:', err);
        }
    },

    // ── Migration: Outflows ──
    async loadOutflows() {
        try {
            const county = this.getCounty();
            const qs = county ? `?county=${encodeURIComponent(county)}&limit=15` : '?limit=15';
            const res = await fetch('/hawk/api/migration/outflows' + qs);
            const data = await res.json();
            if (!data.success) throw new Error(data.error);

            const el = document.getElementById('outflowTable');
            if (!data.data.length) {
                el.innerHTML = '<div class="hawk-empty">No outflow data</div>';
                return;
            }

            let html = `<table class="hawk-table">
                <thead><tr>
                    <th>Destination</th>
                    <th>Returns</th>
                    <th>AGI ($K)</th>
                    <th>Avg AGI/Return</th>
                </tr></thead><tbody>`;

            data.data.forEach(r => {
                html += `<tr>
                    <td><strong>${r.destination}</strong></td>
                    <td class="number">${this.fmt.number(r.returns)}</td>
                    <td class="currency">${this.fmt.currency(r.agi * 1000)}</td>
                    <td class="currency">${this.fmt.currency(r.avg_agi * 1000)}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            el.innerHTML = html;
        } catch (err) {
            console.error('[HAWK] Outflows error:', err);
        }
    },

    // ── Migration: Year Trend ──
    async loadMigrationTrend() {
        try {
            const county = this.getCounty();
            const qs = county ? `?county=${encodeURIComponent(county)}` : '';
            const res = await fetch('/hawk/api/migration/summary' + qs);
            const data = await res.json();
            if (!data.success) throw new Error(data.error);

            const el = document.getElementById('migrationTrend');
            if (!data.data.length) {
                el.innerHTML = '<div class="hawk-empty">No trend data</div>';
                return;
            }

            let html = `<table class="hawk-table">
                <thead><tr>
                    <th>Tax Year</th>
                    <th>Inflow Returns</th>
                    <th>Outflow Returns</th>
                    <th>Net Returns</th>
                    <th>Inflow AGI</th>
                    <th>Outflow AGI</th>
                    <th>Net AGI</th>
                </tr></thead><tbody>`;

            data.data.forEach(r => {
                const netClass = r.net_returns >= 0 ? 'stat-positive' : 'stat-negative';
                const netAgiClass = r.net_agi >= 0 ? 'stat-positive' : 'stat-negative';
                html += `<tr>
                    <td><strong>${r.year}</strong></td>
                    <td class="number">${this.fmt.number(r.inflow_returns)}</td>
                    <td class="number">${this.fmt.number(r.outflow_returns)}</td>
                    <td class="number ${netClass}">${r.net_returns >= 0 ? '+' : ''}${this.fmt.number(r.net_returns)}</td>
                    <td class="currency">${this.fmt.currency(r.inflow_agi * 1000)}</td>
                    <td class="currency">${this.fmt.currency(r.outflow_agi * 1000)}</td>
                    <td class="currency ${netAgiClass}">${r.net_agi >= 0 ? '+' : ''}${this.fmt.currency(r.net_agi * 1000)}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            el.innerHTML = html;
        } catch (err) {
            console.error('[HAWK] Migration trend error:', err);
        }
    },

    // ── SBA: By Program ──
    async loadSBAPrograms() {
        try {
            const county = this.getCounty();
            const qs = county ? `?county=${encodeURIComponent(county)}` : '';
            const res = await fetch('/hawk/api/sba/summary' + qs);
            const data = await res.json();
            if (!data.success) throw new Error(data.error);

            // Programs chart
            const progEl = document.getElementById('sbaProgramChart');
            if (!data.by_program.length) {
                progEl.innerHTML = '<div class="hawk-empty">No program data</div>';
                return;
            }

            const maxFunded = Math.max(...data.by_program.map(p => p.total_funded));
            let html = '';
            data.by_program.forEach(p => {
                const pct = maxFunded > 0 ? (p.total_funded / maxFunded) * 100 : 0;
                html += `
                    <div class="hawk-bar-row">
                        <span class="hawk-bar-label">${p.program} (${this.fmt.compact(p.loans)})</span>
                        <div class="hawk-bar-track">
                            <div class="hawk-bar-fill bar-sba" style="width:${pct}%;">
                                <span>${this.fmt.currency(p.total_funded)}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            progEl.innerHTML = html;
        } catch (err) {
            console.error('[HAWK] SBA programs error:', err);
        }
    },

    // ── SBA: Top Sectors ──
    async loadSBASectors() {
        try {
            const county = this.getCounty();
            const qs = county ? `?county=${encodeURIComponent(county)}` : '';
            const res = await fetch('/hawk/api/sba/sectors' + qs);
            const data = await res.json();
            if (!data.success) throw new Error(data.error);

            const el = document.getElementById('sbaSectorChart');
            if (!data.data.length) {
                el.innerHTML = '<div class="hawk-empty">No sector data</div>';
                return;
            }

            let html = `<table class="hawk-table">
                <thead><tr>
                    <th>Sector</th>
                    <th>Loans</th>
                    <th>Total Funded</th>
                    <th>Avg Loan</th>
                    <th>Jobs</th>
                </tr></thead><tbody>`;

            data.data.slice(0, 12).forEach(r => {
                html += `<tr>
                    <td title="${r.naics_code}">${r.sector || r.naics_code}</td>
                    <td class="number">${this.fmt.number(r.loans)}</td>
                    <td class="currency">${this.fmt.currency(r.total_funded)}</td>
                    <td class="currency">${this.fmt.currency(r.avg_loan)}</td>
                    <td class="number">${this.fmt.number(r.jobs)}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            el.innerHTML = html;
        } catch (err) {
            console.error('[HAWK] SBA sectors error:', err);
        }
    },

    // ── SBA: Loan Table ──
    async loadSBALoans(page) {
        try {
            if (page) this.sbaCurrentPage = page;
            const county = this.getCounty();
            const search = document.getElementById('sbaSearchInput')?.value || '';
            
            let qs = `?page=${this.sbaCurrentPage}&limit=25`;
            if (county) qs += `&county=${encodeURIComponent(county)}`;
            if (search) qs += `&search=${encodeURIComponent(search)}`;

            const res = await fetch('/hawk/api/sba/loans' + qs);
            const data = await res.json();
            if (!data.success) throw new Error(data.error);

            const el = document.getElementById('sbaLoanTable');

            if (!data.data.length) {
                el.innerHTML = '<div class="hawk-empty">No loans found</div>';
                document.getElementById('sbaPagination').style.display = 'none';
                return;
            }

            let html = `<table class="hawk-table">
                <thead><tr>
                    <th>Borrower</th>
                    <th>City</th>
                    <th>County</th>
                    <th>Program</th>
                    <th>Amount</th>
                    <th>Date</th>
                    <th>Sector</th>
                    <th>Jobs</th>
                    <th>Lender</th>
                </tr></thead><tbody>`;

            data.data.forEach(r => {
                const dt = r.approval_date ? new Date(r.approval_date).toLocaleDateString() : '—';
                html += `<tr>
                    <td><strong>${r.borrower_name || '—'}</strong></td>
                    <td>${r.borrower_city || '—'}</td>
                    <td>${r.county || '—'}</td>
                    <td><span class="badge badge-blue">${r.program || '—'}</span></td>
                    <td class="currency">${this.fmt.currency(r.approval_amount)}</td>
                    <td>${dt}</td>
                    <td title="${r.naics_code}">${(r.naics_description || '').substring(0, 35)}</td>
                    <td class="number">${r.jobs_supported || 0}</td>
                    <td>${(r.lender_name || '').substring(0, 25)}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            el.innerHTML = html;

            // Pagination
            const pagEl = document.getElementById('sbaPagination');
            pagEl.style.display = 'flex';
            document.getElementById('sbaPageInfo').textContent = `Page ${data.page} of ${data.pages} (${this.fmt.number(data.total)} loans)`;
            document.getElementById('sbaPrev').disabled = data.page <= 1;
            document.getElementById('sbaNext').disabled = data.page >= data.pages;
        } catch (err) {
            console.error('[HAWK] SBA loans error:', err);
        }
    },

    sbaPage(delta) {
        this.loadSBALoans(this.sbaCurrentPage + delta);
    },

    debounceSearch() {
        clearTimeout(this.sbaSearchTimeout);
        this.sbaSearchTimeout = setTimeout(() => {
            this.sbaCurrentPage = 1;
            this.loadSBALoans();
        }, 400);
    }
};

// ── Init ──
document.addEventListener('DOMContentLoaded', () => {
    HAWK.loadAll();
    document.getElementById('hawkCountyFilter').addEventListener('change', () => HAWK.loadAll());
});
</script>

<%- include('partials/footer') %>
