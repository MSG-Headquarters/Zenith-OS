<!DOCTYPE html>
<html lang="en" data-theme="<%= typeof theme !== 'undefined' ? theme : 'light' %>">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRE OS | Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/theme.css">
    <script src="/js/theme.js"></script>
    <style>
        :root {
            --bg-white: #FFFFFF; --bg-light: #F8FAFC; --bg-gray: #F1F5F9; --bg-card: #FFFFFF;
            --accent-emerald: #10B981; --accent-cyan: #06B6D4; --accent-blue: #3B82F6;
            --accent-violet: #8B5CF6; --accent-amber: #F59E0B; --accent-rose: #F43F5E;
            --text-primary: #1E293B; --text-secondary: #475569; --text-muted: #64748B;
            --border: #E2E8F0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg-light); color: var(--text-primary); min-height: 100vh; display: flex; }
        
        .sidebar { width: 280px; background: var(--sidebar-bg); border-right: 1px solid var(--border); position: fixed; height: 100vh; z-index: 100; display: flex; flex-direction: column; box-shadow: 2px 0 8px rgba(0,0,0,0.04); }
        .sidebar-header { padding: 24px; border-bottom: 1px solid var(--border); }
        .user-profile { display: flex; align-items: center; gap: 14px; }
        .avatar { width: 48px; height: 48px; background: linear-gradient(135deg, var(--accent-emerald), var(--accent-cyan)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 700; color: white; }
        .user-info h3 { font-size: 16px; font-weight: 600; }
        .user-role { font-size: 12px; color: var(--accent-emerald); font-weight: 500; }
        .sidebar-nav { flex: 1; padding: 20px 16px; overflow-y: auto; }
        .nav-section { margin-bottom: 24px; }
        .nav-section-label { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; padding: 0 12px; margin-bottom: 8px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 10px; color: var(--text-secondary); text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s ease; margin-bottom: 4px; }
        .nav-item:hover { background: var(--bg-gray); color: var(--text-primary); }
        .nav-item.active { background: rgba(16, 185, 129, 0.1); color: var(--accent-emerald); }
        .nav-icon { width: 20px; text-align: center; font-size: 16px; }
        .nav-badge { margin-left: auto; background: var(--accent-rose); color: white; font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 100px; }
        .nav-item.csuite { border: 1px solid rgba(16, 185, 129, 0.3); background: rgba(16, 185, 129, 0.05); }
        .sidebar-footer { padding: 16px; border-top: 1px solid var(--border); }
        .sidebar-footer a, .sidebar-footer button { color: var(--text-secondary) !important; display: block; padding: 8px 12px; border-radius: 8px; text-decoration: none; font-size: 13px; }
        .sidebar-footer a:hover, .sidebar-footer button:hover { background: var(--sidebar-hover); color: var(--text-primary) !important; }
        .system-status { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-muted); }
        .status-dot { width: 8px; height: 8px; background: var(--accent-emerald); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .main-content { flex: 1; margin-left: 280px; }
        .topbar { height: 72px; background: var(--bg-surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 32px; position: sticky; top: 0; z-index: 50; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        .topbar-title { font-size: 24px; font-weight: 700; }
        .topbar-actions { display: flex; gap: 12px; }
        .btn { padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
        .btn-primary { background: var(--accent-emerald); color: white; }
        .btn-ghost { background: transparent; color: var(--text-secondary); border: 1px solid var(--border); }
        
        .content-area { padding: 32px; }
        .welcome-section { margin-bottom: 32px; }
        .welcome-title { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
        .welcome-subtitle { font-size: 14px; color: var(--text-muted); }
        
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px; }
        .stat-card { background: var(--bg-white); border: 1px solid var(--border); border-radius: 16px; padding: 24px; display: flex; align-items: center; gap: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        .stat-icon { width: 56px; height: 56px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .stat-icon.blue { background: rgba(59, 130, 246, 0.1); }
        .stat-icon.emerald { background: rgba(16, 185, 129, 0.1); }
        .stat-icon.violet { background: rgba(139, 92, 246, 0.1); }
        .stat-icon.amber { background: rgba(245, 158, 11, 0.1); }
        .stat-value { font-size: 28px; font-weight: 800; }
        .stat-label { font-size: 13px; color: var(--text-muted); }
        
        .section-title { font-size: 14px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px; }
        .modules-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px; }
        .module-card { background: var(--bg-white); border: 1px solid var(--border); border-radius: 16px; padding: 24px; cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden; text-decoration: none; color: inherit; }
        .module-card:hover { border-color: var(--accent-emerald); transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.08); }
        .module-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .card-crm::before { background: var(--accent-blue); }
        .card-huddle::before { background: var(--accent-violet); }
        .card-mailer::before { background: var(--accent-emerald); }
        .card-vault::before { background: var(--accent-cyan); }
        .module-header { display: flex; align-items: center; gap: 14px; margin-bottom: 12px; }
        .module-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .card-crm .module-icon { background: rgba(59, 130, 246, 0.1); }
        .card-huddle .module-icon { background: rgba(139, 92, 246, 0.1); }
        .card-mailer .module-icon { background: rgba(16, 185, 129, 0.1); }
        .card-vault .module-icon { background: rgba(6, 182, 212, 0.1); }
        .module-info h3 { font-size: 16px; font-weight: 600; margin-bottom: 2px; }
        .module-info p { font-size: 12px; color: var(--text-muted); }
        .module-description { font-size: 13px; color: var(--text-secondary); line-height: 1.5; }
        
        .activity-section { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
        .card { background: var(--bg-white); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        .card-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .card-title { font-size: 16px; font-weight: 600; }
        .card-body { padding: 20px 24px; }
        .activity-item { display: flex; align-items: flex-start; gap: 14px; padding: 14px 0; border-bottom: 1px solid var(--border); }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
        .activity-icon.lead { background: rgba(59, 130, 246, 0.1); }
        .activity-icon.email { background: rgba(16, 185, 129, 0.1); }
        .activity-icon.message { background: rgba(139, 92, 246, 0.1); }
        .activity-icon.deal { background: rgba(245, 158, 11, 0.1); }
        .activity-content { flex: 1; }
        .activity-content h4 { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
        .activity-content p { font-size: 13px; color: var(--text-muted); }
        .activity-time { font-size: 12px; color: var(--text-muted); white-space: nowrap; }
        
        .quick-action { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border); cursor: pointer; transition: all 0.15s ease; }
        .quick-action:hover { padding-left: 8px; }
        .quick-action:last-child { border-bottom: none; }
        .quick-action-icon { width: 36px; height: 36px; background: var(--bg-gray); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .quick-action-text { font-size: 14px; font-weight: 500; color: var(--text-primary) !important; }
        .quick-action-icon { color: var(--text-muted) !important; }
        
        .logout-btn { display: block; width: 100%; padding: 10px; background: rgba(244, 63, 94, 0.1); border: 1px solid rgba(244, 63, 94, 0.2); border-radius: 8px; color: var(--accent-rose); font-size: 13px; font-weight: 500; cursor: pointer; text-align: center; text-decoration: none; margin-top: 12px; }
    </style>
<%- include("partials/security") %>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="user-profile">
                <div class="avatar"><%= user.name ? user.name.charAt(0).toUpperCase() : 'U' %></div>
                <div class="user-info">
                    <h3><%= user.name %></h3>
                    <span class="user-role"><%= user.role %> | <%= org.name %></span>
                </div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-label">Dashboard</div>
                <a href="/dashboard" class="nav-item active">
                    <span class="nav-icon"><i class="bi bi-house"></i></span> CRE Home
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-label">Work Modules</div>
                <% if (features.crm !== false) { %>
                <a href="/crm" class="nav-item">
                    <span class="nav-icon"><i class="bi bi-kanban"></i></span> CRM Pipeline
                    <span class="nav-badge"><%= stats.leads || 0 %></span>
                </a>
                <% } %>
                <% if (features.inventory !== false) { %>
                <a href="/inventory" class="nav-item">
                    <span class="nav-icon"><i class="bi bi-box-seam"></i></span> Inventory
                </a>
                <% } %>
                <% if (features.huddle !== false) { %>
                <a href="/huddle" class="nav-item">
                    <span class="nav-icon"><i class="bi bi-chat-dots"></i></span> The Huddle
                </a>
                <% } %>
                <% if (features.mailer !== false) { %>
                <a href="/mailer" class="nav-item">
                    <span class="nav-icon"><i class="bi bi-envelope"></i></span> Mailer
                </a>
                <% } %>
                <% if (features.pm !== false) { %>
                <a href="/pm" class="nav-item">
                    <span class="nav-icon"><i class="bi bi-building"></i></span> Property Mgmt
                </a>
                <% } %>
                <% if (features.danimal !== false) { %>
                <a href="/danimal" class="nav-item"><span class="nav-icon"><i class="bi bi-database"></i></span> Danimal Data</a>
                <% } %>
                <% if (features.intel !== false) { %>
                <a href="/intel" class="nav-item"><span class="nav-icon"><i class="bi bi-lightbulb"></i></span> INTEL</a>
                <% } %>
                <% if (features.marketing !== false) { %>
                <a href="/marketing" class="nav-item"><span class="nav-icon"><i class="bi bi-megaphone"></i></span> Marketing</a>
                <% } %>
                <% if (features.vault !== false) { %>
                <a href="/vault" class="nav-item">
                    <span class="nav-icon"><i class="bi bi-safe"></i></span> The Vault
                </a>
                <% } %>
                <% if (features.hawk !== false) { %>
                <a href="/hawk" class="nav-item">
                    <span class="nav-icon"><i class="bi bi-crosshair"></i></span> HAWK
                </a>
                <% } %>
            </div>

            <% if (['Admin', 'Principal'].includes(user.role)) { %>
            <div class="nav-section">
                <div class="nav-section-label">C-Suite Access</div>
               <% if (features.command !== false) { %>
                <a href="/command" class="nav-item csuite">
                    <span class="nav-icon"><i class="bi bi-bullseye"></i></span> Command Center
                </a>
                <% } %>
                <% if (features.cfo !== false) { %>
                <a href="/cfo" class="nav-item csuite">
                    <span class="nav-icon"><i class="bi bi-graph-up"></i></span> CFO Dashboard
                </a>
                <% } %>
                </a>
            </div>
            <% } %>

            <% if (user.role === 'Admin') { %>
            <div class="nav-section">
                <div class="nav-section-label">Administration</div>
                <a href="/admin" class="nav-item">
                    <span class="nav-icon"><i class="bi bi-gear"></i></span> Admin Settings
                </a>
                <% if (user.email === 'koda@mainstgroup.com') { %>
                <a href="/superadmin" class="nav-item" style="border: 1px solid rgba(244, 63, 94, 0.3); background: rgba(244, 63, 94, 0.05);">
                    <span class="nav-icon"><i class="bi bi-shield-lock"></i></span> Super Admin
                </a>
                <% } %>
            </div>
            <% } %>
        </nav>

        <div class="sidebar-footer">
            <div class="system-status">
                <div class="status-dot"></div>
                <span>All systems operational</span>
            </div>
            <a href="/settings" class="logout-btn" style="background: rgba(16, 185, 129, 0.1); color: #10b981; margin-bottom: 8px;"><i class="bi bi-gear"></i> Settings</a>
            <a href="/auth/logout" class="logout-btn"><i class="bi bi-box-arrow-right"></i> Sign Out</a>
        </div>
    </aside>

    <main class="main-content">
        <header class="topbar">
            <h1 class="topbar-title">Welcome Back, <%= user.name.split(' ')[0] %></h1>
            <div class="topbar-actions">
                <a href="/settings" class="btn btn-ghost"><i class="bi bi-gear"></i> Settings</a>
                <a href="/crm" class="btn btn-primary">+ New Lead</a>
            </div>
        </header>

        <div class="content-area">
            <div class="welcome-section">
                <h2 class="welcome-title">Your CRE Dashboard</h2>
                <p class="welcome-subtitle" id="dateDisplay"></p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon blue"><i class="bi bi-people"></i></div>
                    <div>
                        <div class="stat-value"><%= stats.leads || 0 %></div>
                        <div class="stat-label">Active Leads</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon emerald"><i class="bi bi-chat-dots"></i></div>
                    <div>
                        <div class="stat-value"><%= stats.messages || 0 %></div>
                        <div class="stat-label">Messages</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon violet"><i class="bi bi-bell"></i></div>
                    <div>
                        <div class="stat-value">0</div>
                        <div class="stat-label">Unread Messages</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon amber"><i class="bi bi-currency-dollar"></i></div>
                    <div>
                        <div class="stat-value">$<%= Math.round((stats.pipelineValue || 0) / 1000) %>K</div>
                        <div class="stat-label">Pipeline Value</div>
                    </div>
                </div>
            </div>

            <p class="section-title">Quick Access</p>
            <div class="modules-grid">
                <a href="/crm" class="module-card card-crm">
                    <div class="module-header">
                        <div class="module-icon"><i class="bi bi-box"></i></div>
                        <div class="module-info">
                            <h3>CRM Pipeline</h3>
                            <p>Lead & Deal Management</p>
                        </div>
                    </div>
                    <p class="module-description">Track leads through your sales pipeline. Kanban boards, lead scoring, and automated stage progression.</p>
                </a>

                <a href="/huddle" class="module-card card-huddle">
                    <div class="module-header">
                        <div class="module-icon"><i class="bi bi-box"></i></div>
                        <div class="module-info">
                            <h3>The Huddle</h3>
                            <p>Team Communication</p>
                        </div>
                    </div>
                    <p class="module-description">Real-time messaging, deal-specific channels, and async standups to keep your team aligned.</p>
                </a>

                <a href="/mailer" class="module-card card-mailer">
                    <div class="module-header">
                        <div class="module-icon"><i class="bi bi-box"></i></div>
                        <div class="module-info">
                            <h3>Mailer</h3>
                            <p>Email Automation</p>
                        </div>
                    </div>
                    <p class="module-description">AI-powered drip campaigns, templates, and engagement tracking. M365 + AWS SES integration.</p>
                </a>

                <a href="/vault" class="module-card card-vault">
                    <div class="module-header">
                        <div class="module-icon"><i class="bi bi-box"></i></div>
                        <div class="module-info">
                            <h3>The Vault</h3>
                            <p>Secure Documents</p>
                        </div>
                    </div>
                    <p class="module-description">Encrypted document storage, version history, and secure sharing with clients and team members.</p>
                </a>
            </div>

            <div class="activity-section">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Activity</h3>
                        <button class="btn btn-ghost" style="padding: 6px 12px; font-size: 12px;">View All</button>
                    </div>
                    <div class="card-body">
                        <% if (activities && activities.length > 0) { %>
                            <% activities.forEach(activity => { %>
                            <div class="activity-item">
                                <div class="activity-icon <%= activity.type || 'lead' %>">
                                    <%= activity.type === 'email' ? '<i class="bi bi-envelope"></i>' : activity.type === 'message' ? '<i class="bi bi-chat"></i>' : activity.type === 'deal' ? '<i class="bi bi-trophy"></i>' : '<i class="bi bi-bell"></i>' %>
                                </div>
                                <div class="activity-content">
                                    <h4><%= activity.action %></h4>
                                    <p><%= activity.details %></p>
                                </div>
                                <span class="activity-time"><%= new Date(activity.created_at).toLocaleDateString() %></span>
                            </div>
                            <% }); %>
                        <% } else { %>
                            <div class="activity-item">
                                <div class="activity-icon lead"><i class="bi bi-person-plus"></i></div>
                                <div class="activity-content">
                                    <h4>Welcome to CRE OS!</h4>
                                    <p>Get started by adding your first lead or exploring the modules.</p>
                                </div>
                                <span class="activity-time">Now</span>
                            </div>
                        <% } %>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Quick Actions</h3>
                    </div>
                    <div class="card-body">
                        <a href="/crm" class="quick-action" style="text-decoration: none; color: inherit;">
                            <div class="quick-action-icon"><i class="bi bi-plus-circle"></i></div>
                            <span class="quick-action-text">Add New Lead</span>
                        </a>
                        <a href="/huddle" class="quick-action" style="text-decoration: none; color: inherit;">
                            <div class="quick-action-icon"><i class="bi bi-chat-square-text"></i></div><span class="quick-action-text">Start a Huddle</span>
                        </a>
                        <a href="/mailer" class="quick-action" style="text-decoration: none; color: inherit;">
                            <div class="quick-action-icon"><i class="bi bi-send"></i></div><span class="quick-action-text">Send Campaign</span>
                        </a>
                        <a href="/vault" class="quick-action" style="text-decoration: none; color: inherit;">
                            <div class="quick-action-icon"><i class="bi bi-lightning"></i></div>
                            <span class="quick-action-text">Upload Document</span>
                        </a>
                        <% if (['Admin', 'Principal'].includes(user.role)) { %>
                        <a href="/command" class="quick-action" style="text-decoration: none; color: inherit;">
                            <div class="quick-action-icon"><i class="bi bi-bullseye"></i></div><span class="quick-action-text">View Command Center</span>
                        </a>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('dateDisplay').textContent = now.toLocaleDateString('en-US', options) + ' | <%= org.name %>';
    </script>
<%- include('partials/notification-bubble') %>
</body>
</html>
