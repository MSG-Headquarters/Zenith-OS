<!DOCTYPE html>
<html lang="en" data-theme="<%= typeof theme !== 'undefined' ? theme : 'light' %>">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Management — CRE OS</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/theme.css">
    <script src="/js/theme.js"></script>
    <%- include('../partials/security') %>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-page, #F8FAFC); color: var(--text-primary, #1E293B); min-height: 100vh; display: flex; }
        .sidebar { width: 260px; background: var(--bg-surface, #fff); border-right: 1px solid var(--border, #E2E8F0); padding: 12px 8px; flex-shrink: 0; display: flex; flex-direction: column; height: 100vh; position: sticky; top: 0; }
        .sidebar-brand { display: flex; align-items: center; gap: 10px; padding: 16px 12px 20px; margin-bottom: 8px; border-bottom: 1px solid var(--border); }
        .sidebar-brand-icon { width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, #6366F1, #8B5CF6); display: flex; align-items: center; justify-content: center; }
        .sidebar-brand-icon i { color: #fff; font-size: 16px; }
        .sidebar-brand-text h3 { font-size: 15px; font-weight: 700; color: var(--text-primary); }
        .sidebar-brand-text span { font-size: 11px; color: var(--text-muted, #64748B); }
        .sidebar-nav { flex: 1; padding: 4px 0; overflow-y: auto; }
        .nav-section-label { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; padding: 12px 12px 8px; }
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; color: var(--text-secondary, #475569); text-decoration: none; font-size: 14px; transition: all 0.15s ease; margin-bottom: 2px; cursor: pointer; }
        .nav-item:hover { background: var(--bg-surface-alt, #F1F5F9); color: var(--text-primary); }
        .nav-item.active { background: rgba(99, 102, 241, 0.1); color: #6366F1; font-weight: 600; }
        .nav-item i { width: 20px; font-size: 16px; flex-shrink: 0; }
        .nav-badge { margin-left: auto; background: #EF4444; color: #fff; font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 10px; min-width: 18px; text-align: center; }
        .main { flex: 1; overflow-y: auto; height: 100vh; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 20px 32px; border-bottom: 1px solid var(--border); background: var(--bg-surface); }
        .top-bar h1 { font-size: 22px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .top-bar h1 i { color: #6366F1; }
        .content { padding: 24px 32px; }
        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 28px; }
        .stat-card { background: var(--bg-surface); border: 1px solid var(--border); border-radius: 12px; padding: 18px 20px; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; }
        .stat-card.properties::before { background: #6366F1; }
        .stat-card.tenants::before { background: #10B981; }
        .stat-card.occupancy::before { background: #F59E0B; }
        .stat-card.expiring::before { background: #EF4444; }
        .stat-card.maintenance::before { background: #06B6D4; }
        .stat-value { font-size: 28px; font-weight: 700; line-height: 1; }
        .stat-label { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
        .table-card { background: var(--bg-surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .table-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border); }
        .table-title { font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .table-actions { display: flex; gap: 8px; align-items: center; }
        table { width: 100%; border-collapse: collapse; }
        th { padding: 12px 16px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; background: var(--bg-surface-alt, #F8FAFC); border-bottom: 1px solid var(--border); }
        td { padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 13px; }
        tr:hover { background: var(--bg-surface-alt, #F8FAFC); }
        tr:last-child td { border-bottom: none; }
        .badge { padding: 3px 10px; border-radius: 100px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
        .badge-current { background: rgba(16, 185, 129, 0.1); color: #10B981; }
        .badge-mtm { background: rgba(245, 158, 11, 0.1); color: #F59E0B; }
        .badge-expiring { background: rgba(239, 68, 68, 0.1); color: #EF4444; }
        .badge-vacant { background: rgba(100, 116, 139, 0.1); color: #64748B; }
        .badge-emergency { background: #FEE2E2; color: #991B1B; }
        .badge-high { background: #FFEDD5; color: #9A3412; }
        .badge-medium { background: #FEF9C3; color: #854D0E; }
        .badge-low { background: #DCFCE7; color: #166534; }
        .badge-new { background: #DBEAFE; color: #1E40AF; }
        .badge-progress { background: #F3E8FF; color: #6B21A8; }
        .badge-complete { background: #DCFCE7; color: #166534; }
        .prop-name { font-weight: 600; color: var(--text-primary); }
        .prop-address { font-size: 12px; color: var(--text-muted); }
        .occupancy-bar { width: 60px; height: 6px; background: var(--bg-surface-alt, #E2E8F0); border-radius: 3px; overflow: hidden; display: inline-block; vertical-align: middle; margin-right: 6px; }
        .occupancy-fill { height: 100%; border-radius: 3px; }
        .btn { padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 6px; transition: all 0.15s; text-decoration: none; }
        .btn-primary { background: #6366F1; color: white; }
        .btn-primary:hover { background: #4F46E5; }
        .btn-outline { background: transparent; color: var(--text-secondary); border: 1px solid var(--border); }
        .btn-outline:hover { background: var(--bg-surface-alt); }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .search-box { display: flex; align-items: center; gap: 8px; background: var(--bg-surface-alt, #F1F5F9); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; }
        .search-box input { border: none; background: transparent; outline: none; font-size: 13px; color: var(--text-primary); width: 180px; font-family: inherit; }
        .search-box i { color: var(--text-muted); font-size: 14px; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .lease-dates { font-size: 12px; color: var(--text-secondary); }
        .lease-remaining { font-size: 12px; font-weight: 600; }
        .lease-remaining.danger { color: #EF4444; }
        .lease-remaining.warning { color: #F59E0B; }
        .lease-remaining.ok { color: #10B981; }
        .empty-state { text-align: center; padding: 48px 20px; color: var(--text-muted); }
        .empty-state i { font-size: 48px; margin-bottom: 12px; opacity: 0.3; display: block; }
        .empty-state h3 { font-size: 16px; margin-bottom: 4px; color: var(--text-secondary); }
        .toast { position: fixed; bottom: 24px; right: 24px; padding: 12px 20px; border-radius: 8px; color: white; font-size: 14px; font-weight: 500; z-index: 9999; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .toast.success { background: #10B981; }
        .toast.error { background: #EF4444; }
        @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 768px) { .sidebar { display: none; } .stats-grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-brand">
            <div class="sidebar-brand-icon"><i class="bi bi-building"></i></div>
            <div class="sidebar-brand-text">
                <h3>Property Mgmt</h3>
                <span>CRE Consultants</span>
            </div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section-label">Portfolio</div>
            <a href="#" class="nav-item active" onclick="switchTab('properties', this)"><i class="bi bi-buildings"></i> Properties</a>
            <a href="#" class="nav-item" onclick="switchTab('tenants', this)"><i class="bi bi-people"></i> Tenants</a>
            <a href="#" class="nav-item" onclick="switchTab('leases', this)"><i class="bi bi-file-earmark-text"></i> Leases</a>
            <a href="#" class="nav-item" onclick="switchTab('maintenance', this)"><i class="bi bi-wrench"></i> Maintenance <span class="nav-badge" id="maintBadge" style="display:none;">0</span></a>
            <div class="nav-section-label">Navigate</div>
            <a href="/dashboard" class="nav-item"><i class="bi bi-house"></i> CRE Home</a>
            <% if (typeof features !== 'undefined' && features.crm !== false) { %>
            <a href="/crm" class="nav-item"><i class="bi bi-funnel"></i> CRM</a>
            <% } %>
            <% if (typeof features !== 'undefined' && features.intel !== false) { %>
            <a href="/intel" class="nav-item"><i class="bi bi-broadcast"></i> INTEL</a>
            <% } %>
            <% if (typeof features !== 'undefined' && features.marketing !== false) { %>
            <a href="/marketing" class="nav-item"><i class="bi bi-megaphone"></i> Marketing</a>
            <% } %>
            <% if (typeof features !== 'undefined' && features.huddle !== false) { %>
            <a href="/huddle" class="nav-item"><i class="bi bi-chat-dots"></i> Huddle</a>
            <% } %>
        </nav>
    </aside>
    <div class="main">
        <div class="top-bar">
            <h1><i class="bi bi-building"></i> Property Management</h1>
            <div style="display:flex;gap:8px;">
                <button class="btn btn-outline" onclick="refreshData()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                <a href="/maintenance" target="_blank" class="btn btn-outline"><i class="bi bi-box-arrow-up-right"></i> Tenant Portal</a>
                <button class="btn btn-primary" onclick="showAddProperty()"><i class="bi bi-plus-lg"></i> Add Property</button>
            </div>
        </div>
        <div class="content">
            <div class="stats-grid">
                <div class="stat-card properties"><div class="stat-value" id="statProperties">—</div><div class="stat-label">Managed Properties</div></div>
                <div class="stat-card tenants"><div class="stat-value" id="statTenants">—</div><div class="stat-label">Active Tenants</div></div>
                <div class="stat-card occupancy"><div class="stat-value" id="statOccupancy">—</div><div class="stat-label">Avg Occupancy</div></div>
                <div class="stat-card expiring"><div class="stat-value" id="statExpiring">—</div><div class="stat-label">Leases Expiring (90d)</div></div>
                <div class="stat-card maintenance"><div class="stat-value" id="statMaint">—</div><div class="stat-label">Open Requests</div></div>
            </div>
            <div id="panelProperties" class="tab-panel active">
                <div class="table-card">
                    <div class="table-header">
                        <div class="table-title"><i class="bi bi-buildings"></i> Managed Properties</div>
                        <div class="table-actions">
                            <div class="search-box"><i class="bi bi-search"></i><input type="text" placeholder="Search properties..." id="searchProperties" oninput="filterProperties()"></div>
                        </div>
                    </div>
                    <table><thead><tr><th>Property</th><th>Type</th><th>City</th><th>Units</th><th>Tenants</th><th>Occupancy</th><th>Actions</th></tr></thead><tbody id="propertiesBody"></tbody></table>
                </div>
            </div>
            <div id="panelTenants" class="tab-panel">
                <div class="table-card">
                    <div class="table-header">
                        <div class="table-title"><i class="bi bi-people"></i> All Tenants</div>
                        <div class="table-actions">
                            <div class="search-box"><i class="bi bi-search"></i><input type="text" placeholder="Search tenants..." id="searchTenants" oninput="filterTenants()"></div>
                            <select class="btn btn-outline" id="tenantStatusFilter" onchange="filterTenants()" style="font-size:13px;"><option value="all">All Status</option><option value="Current">Current</option><option value="MTM">Month-to-Month</option><option value="Expiring">Expiring Soon</option></select>
                        </div>
                    </div>
                    <table><thead><tr><th>Tenant</th><th>Property</th><th>Unit</th><th>Phone</th><th>Email</th><th>Status</th><th>Lease End</th></tr></thead><tbody id="tenantsBody"></tbody></table>
                </div>
            </div>
            <div id="panelLeases" class="tab-panel">
                <div class="table-card">
                    <div class="table-header">
                        <div class="table-title"><i class="bi bi-file-earmark-text"></i> Lease Tracker</div>
                        <div class="table-actions">
                            <select class="btn btn-outline" id="leaseFilter" onchange="filterLeases()" style="font-size:13px;"><option value="all">All Leases</option><option value="expiring30">Expiring in 30 days</option><option value="expiring90">Expiring in 90 days</option><option value="expiring180">Expiring in 180 days</option><option value="mtm">Month-to-Month</option></select>
                        </div>
                    </div>
                    <table><thead><tr><th>Tenant</th><th>Property</th><th>Unit</th><th>Lease Start</th><th>Lease End</th><th>Remaining</th><th>Status</th></tr></thead><tbody id="leasesBody"></tbody></table>
                </div>
            </div>
            <div id="panelMaintenance" class="tab-panel">
                <div class="table-card">
                    <div class="table-header">
                        <div class="table-title"><i class="bi bi-wrench"></i> Maintenance Requests</div>
                        <div class="table-actions">
                            <select class="btn btn-outline" id="maintFilter" onchange="loadMaintenance()" style="font-size:13px;"><option value="all">All Status</option><option value="New">New</option><option value="In Progress">In Progress</option><option value="Completed">Completed</option></select>
                        </div>
                    </div>
                    <table><thead><tr><th>ID</th><th>Property</th><th>Type</th><th>Priority</th><th>Contact</th><th>Status</th><th>Submitted</th><th>Actions</th></tr></thead><tbody id="maintBody"></tbody></table>
                </div>
            </div>
        </div>
    </div>
    <div class="toast" id="toast"></div>
    <script>
        let allProperties = [];
        let allTenants = [];
        let allLeases = [];
        document.addEventListener('DOMContentLoaded', () => { loadProperties(); loadTenants(); loadMaintenance(); });

        function switchTab(tab, el) {
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.sidebar-nav .nav-item').forEach(a => { if(a.getAttribute('onclick')) a.classList.remove('active'); });
            document.getElementById('panel' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            if (el) el.classList.add('active');
        }

        async function loadProperties() {
            try {
                const res = await fetch('/api/pm/portfolio');
                const data = await res.json();
                if (data.success) { allProperties = data.properties; renderProperties(allProperties); updateStats(data); }
            } catch(e) { console.error('Load properties error:', e); }
        }

        function renderProperties(props) {
            const tbody = document.getElementById('propertiesBody');
            if (!props.length) { tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><i class="bi bi-buildings"></i><h3>No properties found</h3></div></td></tr>'; return; }
            tbody.innerHTML = props.map(p => {
                const occ = p.total_units > 0 ? Math.round((p.tenant_count / p.total_units) * 100) : 0;
                const occColor = occ >= 80 ? '#10B981' : occ >= 50 ? '#F59E0B' : '#EF4444';
                return '<tr>' +
                    '<td><div class="prop-name">' + (p.short_name || p.property_name) + '</div><div class="prop-address">' + p.property_address + ', ' + p.city + '</div></td>' +
                    '<td>' + (p.property_type || '—') + '</td>' +
                    '<td>' + p.city + ', ' + p.state + '</td>' +
                    '<td>' + (p.total_units || 0) + '</td>' +
                    '<td>' + (p.tenant_count || 0) + '</td>' +
                    '<td><div class="occupancy-bar"><div class="occupancy-fill" style="width:' + occ + '%;background:' + occColor + ';"></div></div><span style="font-size:12px;font-weight:600;">' + occ + '%</span></td>' +
                    '<td><button class="btn btn-sm btn-outline" onclick="viewProperty(' + p.id + ')"><i class="bi bi-eye"></i></button></td></tr>';
            }).join('');
        }

        async function loadTenants() {
            try {
                const res = await fetch('/api/pm/tenants');
                const data = await res.json();
                if (data.success) { allTenants = data.tenants; allLeases = data.tenants; renderTenants(allTenants); renderLeases(allLeases); updateExpiringCount(); }
            } catch(e) { console.error('Load tenants error:', e); }
        }

        function renderTenants(tenants) {
            const tbody = document.getElementById('tenantsBody');
            if (!tenants.length) { tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><i class="bi bi-people"></i><h3>No tenants found</h3></div></td></tr>'; return; }
            tbody.innerHTML = tenants.map(t => {
                const sc = t.tenant_status === 'MTM' ? 'mtm' : t.is_expiring ? 'expiring' : 'current';
                return '<tr>' +
                    '<td><div style="font-weight:600;">' + t.tenant_name + '</div>' + (t.dba_name ? '<div style="font-size:11px;color:var(--text-muted);">DBA: ' + t.dba_name + '</div>' : '') + '</td>' +
                    '<td>' + (t.property_name || '—') + '</td>' +
                    '<td>' + (t.unit_number || '—') + '</td>' +
                    '<td>' + (t.contact_phone || '<span style="color:var(--text-muted);">—</span>') + '</td>' +
                    '<td>' + (t.contact_email ? '<a href="mailto:' + t.contact_email + '" style="color:#6366F1;text-decoration:none;font-size:12px;">' + t.contact_email + '</a>' : '<span style="color:var(--text-muted);">—</span>') + '</td>' +
                    '<td><span class="badge badge-' + sc + '">' + t.tenant_status + '</span></td>' +
                    '<td><span class="lease-dates">' + (t.lease_end ? formatDate(t.lease_end) : 'No end date') + '</span></td></tr>';
            }).join('');
        }

        function renderLeases(leases) {
            const tbody = document.getElementById('leasesBody');
            if (!leases.length) { tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><i class="bi bi-file-earmark-text"></i><h3>No leases found</h3></div></td></tr>'; return; }
            const now = new Date();
            tbody.innerHTML = leases.map(t => {
                let remaining = '—', rc = 'ok';
                if (t.lease_end) {
                    const end = new Date(t.lease_end);
                    const days = Math.ceil((end - now) / 86400000);
                    if (days < 0) { remaining = 'Expired'; rc = 'danger'; }
                    else if (days < 30) { remaining = days + ' days'; rc = 'danger'; }
                    else if (days < 90) { remaining = Math.floor(days/30) + ' months'; rc = 'warning'; }
                    else if (days < 365) { remaining = Math.floor(days/30) + ' months'; rc = 'ok'; }
                    else { remaining = Math.floor(days/365) + 'y ' + Math.floor((days%365)/30) + 'm'; rc = 'ok'; }
                } else if (t.tenant_status === 'MTM') { remaining = 'Month-to-Month'; rc = 'warning'; }
                const sb = t.tenant_status === 'MTM' ? 'mtm' : rc === 'danger' ? 'expiring' : 'current';
                return '<tr>' +
                    '<td style="font-weight:600;">' + t.tenant_name + '</td>' +
                    '<td>' + (t.property_name || '—') + '</td>' +
                    '<td>' + (t.unit_number || '—') + '</td>' +
                    '<td class="lease-dates">' + (t.lease_start ? formatDate(t.lease_start) : '—') + '</td>' +
                    '<td class="lease-dates">' + (t.lease_end ? formatDate(t.lease_end) : '—') + '</td>' +
                    '<td><span class="lease-remaining ' + rc + '">' + remaining + '</span></td>' +
                    '<td><span class="badge badge-' + sb + '">' + t.tenant_status + '</span></td></tr>';
            }).join('');
        }

        async function loadMaintenance() {
            try {
                const status = document.getElementById('maintFilter') ? document.getElementById('maintFilter').value : 'all';
                const res = await fetch('/api/pm/requests?status=' + status);
                const data = await res.json();
                const tbody = document.getElementById('maintBody');
                if (!data.requests || !data.requests.length) {
                    tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state"><i class="bi bi-check-circle"></i><h3>No maintenance requests</h3><p>All clear! Requests from the Tenant Portal will appear here.</p></div></td></tr>';
                    return;
                }
                tbody.innerHTML = data.requests.map(r =>
                    '<tr><td style="font-weight:600;color:#6366F1;">' + r.request_id + '</td>' +
                    '<td>' + (r.short_name || r.property_name || '—') + '</td>' +
                    '<td>' + (r.request_type || '—') + '</td>' +
                    '<td><span class="badge badge-' + (r.priority||'medium').toLowerCase() + '">' + r.priority + '</span></td>' +
                    '<td>' + (r.contact_name || '—') + '</td>' +
                    '<td><span class="badge badge-' + (r.status==='New'?'new':r.status==='In Progress'?'progress':'complete') + '">' + r.status + '</span></td>' +
                    '<td>' + (r.submitted_at ? formatDate(r.submitted_at) : '—') + '</td>' +
                    '<td><button class="btn btn-sm btn-outline" onclick="updateRequest(\'' + r.request_id + '\')"><i class="bi bi-pencil"></i></button></td></tr>'
                ).join('');
                if (data.requests.length > 0) {
                    const badge = document.getElementById('maintBadge');
                    const open = data.requests.filter(r => r.status !== 'Completed' && r.status !== 'Closed').length;
                    if (open > 0) { badge.textContent = open; badge.style.display = 'inline'; }
                }
            } catch(e) { console.error('Load maintenance error:', e); }
        }

        function updateStats(data) {
            document.getElementById('statProperties').textContent = data.properties.length;
            const totalTenants = data.properties.reduce((s, p) => s + (parseInt(p.tenant_count) || 0), 0);
            document.getElementById('statTenants').textContent = totalTenants;
            const totalUnits = data.properties.reduce((s, p) => s + (parseInt(p.total_units) || 0), 0);
            document.getElementById('statOccupancy').textContent = (totalUnits > 0 ? Math.round((totalTenants/totalUnits)*100) : 0) + '%';
            document.getElementById('statMaint').textContent = data.openRequests || 0;
        }

        function updateExpiringCount() {
            const now = new Date();
            const expiring = allTenants.filter(t => { if (!t.lease_end) return false; const d = Math.ceil((new Date(t.lease_end)-now)/86400000); return d >= 0 && d <= 90; }).length;
            document.getElementById('statExpiring').textContent = expiring;
        }

        function filterProperties() {
            const q = document.getElementById('searchProperties').value.toLowerCase();
            renderProperties(allProperties.filter(p => (p.short_name||'').toLowerCase().includes(q) || (p.property_name||'').toLowerCase().includes(q) || (p.city||'').toLowerCase().includes(q) || (p.property_type||'').toLowerCase().includes(q)));
        }

        function filterTenants() {
            const q = document.getElementById('searchTenants').value.toLowerCase();
            const status = document.getElementById('tenantStatusFilter').value;
            let f = allTenants;
            if (q) f = f.filter(t => (t.tenant_name||'').toLowerCase().includes(q) || (t.dba_name||'').toLowerCase().includes(q) || (t.property_name||'').toLowerCase().includes(q) || (t.contact_email||'').toLowerCase().includes(q));
            if (status !== 'all') {
                if (status === 'Expiring') { const now = new Date(); f = f.filter(t => t.lease_end && Math.ceil((new Date(t.lease_end)-now)/86400000) <= 90 && Math.ceil((new Date(t.lease_end)-now)/86400000) >= 0); }
                else f = f.filter(t => t.tenant_status === status);
            }
            renderTenants(f);
        }

        function filterLeases() {
            const fl = document.getElementById('leaseFilter').value;
            const now = new Date();
            let f = allLeases;
            if (fl === 'expiring30') f = f.filter(t => t.lease_end && Math.ceil((new Date(t.lease_end)-now)/86400000) <= 30 && Math.ceil((new Date(t.lease_end)-now)/86400000) >= 0);
            else if (fl === 'expiring90') f = f.filter(t => t.lease_end && Math.ceil((new Date(t.lease_end)-now)/86400000) <= 90 && Math.ceil((new Date(t.lease_end)-now)/86400000) >= 0);
            else if (fl === 'expiring180') f = f.filter(t => t.lease_end && Math.ceil((new Date(t.lease_end)-now)/86400000) <= 180 && Math.ceil((new Date(t.lease_end)-now)/86400000) >= 0);
            else if (fl === 'mtm') f = f.filter(t => t.tenant_status === 'MTM' || !t.lease_end);
            renderLeases(f);
        }

        function formatDate(d) { if (!d) return '—'; return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); }
        function viewProperty(id) {
            const prop = allProperties.find(p => p.id === id);
            if (!prop) return;
            renderTenants(allTenants.filter(t => t.property_id === id));
            switchTab('tenants', document.querySelectorAll('.sidebar-nav .nav-item')[1]);
            showToast('Showing tenants for ' + prop.short_name);
        }
        function showAddProperty() { showToast('Property import from Danimal Data coming soon!'); }
        function updateRequest(rid) { showToast('Request management coming soon!'); }
        function refreshData() { loadProperties(); loadTenants(); loadMaintenance(); showToast('Data refreshed!'); }
        function showToast(msg, type) { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast ' + (type||'success'); t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 3000); }
    </script>
</body>
</html>
