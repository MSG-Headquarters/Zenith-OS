<!DOCTYPE html>
<html lang="en" data-theme="<%= typeof theme !== 'undefined' ? theme : 'light' %>">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Request | CRE Consultants</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/theme.css">
    <script src="/js/theme.js"></script>
    <style>
        :root { --cre-green: #1B5E20; --cre-gold: #C9A227; --bg: #f8f9fa; --border: #e0e0e0; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Source Sans 3', sans-serif; background: var(--bg); color: #1a1a1a; }
        .header { background: linear-gradient(135deg, #1B5E20, #2E7D32); color: white; padding: 1.25rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .header-brand { display: flex; align-items: center; gap: 1rem; }
        .header-logo { width: 48px; height: 48px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--cre-green); }
        .header h1 { font-family: 'Playfair Display', serif; font-size: 1.35rem; }
        .header a { color: var(--cre-gold); }
        .container { max-width: 720px; margin: 0 auto; padding: 2rem; }
        .page-title { text-align: center; margin-bottom: 2rem; }
        .page-title h2 { font-family: 'Playfair Display', serif; font-size: 1.75rem; color: var(--cre-green); }
        .form-card { background: white; border-radius: 16px; padding: 2rem; margin-bottom: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }
        .section-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 2px solid var(--cre-gold); }
        .section-header h3 { font-family: 'Playfair Display', serif; color: var(--cre-green); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 0.4rem; }
        .form-group label .req { color: #dc3545; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.7rem; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; }
        .form-group textarea { min-height: 100px; }
        .property-info { background: var(--bg); padding: 0.75rem; border-radius: 8px; margin-top: 0.5rem; display: none; }
        .property-info.visible { display: block; }
        .type-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; }
        .type-btn { padding: 0.75rem; background: var(--bg); border: 2px solid transparent; border-radius: 8px; cursor: pointer; text-align: center; }
        .type-btn:hover, .type-btn.selected { border-color: var(--cre-green); background: rgba(27,94,32,0.08); }
        .type-btn .icon { font-size: 1.25rem; }
        .type-btn .label { font-size: 0.75rem; color: #666; }
        .priority-row { display: flex; gap: 0.5rem; }
        .priority-btn { flex: 1; padding: 0.6rem; border: 2px solid var(--border); border-radius: 8px; background: white; cursor: pointer; text-align: center; }
        .priority-btn:hover, .priority-btn.selected { border-color: var(--cre-green); }
        .btn-submit { width: 100%; padding: 1rem; background: linear-gradient(135deg, #1B5E20, #2E7D32); color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(27,94,32,0.3); }
        .success-screen { display: none; text-align: center; padding: 3rem; }
        .success-screen.visible { display: block; }
        .success-screen h2 { color: var(--cre-green); font-family: 'Playfair Display', serif; }
        .success-screen .request-id { font-size: 1.5rem; font-weight: 700; color: var(--cre-green); margin: 1rem 0; font-family: monospace; }
        .error-msg { background: rgba(220,53,69,0.1); border: 1px solid rgba(220,53,69,0.3); color: #dc3545; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; display: none; }
        .error-msg.visible { display: block; }
        @media (max-width: 600px) { .form-row, .type-grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-brand">
            <div class="header-logo">CRE</div>
            <div><h1>CRE Consultants</h1><small>Property Management</small></div>
        </div>
        <div style="text-align:right"><div>PM Inquiries</div><a href="mailto:pm@creconsultants.com">pm@creconsultants.com</a></div>
    </header>
    <div class="container">
        <div class="page-title"><h2>Maintenance Request Portal</h2><p style="color:#666">Submit a request for your managed property</p></div>
        <div id="errorMsg" class="error-msg"></div>
        <form id="maintenanceForm">
            <div class="form-card">
                <div class="section-header"><span>üè¢</span><h3>Property</h3></div>
                <div class="form-group">
                    <label>Select Property <span class="req">*</span></label>
                    <select id="propertySelect" required><option value="">-- Select --</option></select>
                    <div id="propertyInfo" class="property-info"></div>
                </div>
            </div>
            <div class="form-card">
                <div class="section-header"><span>üë§</span><h3>Contact</h3></div>
                <div class="form-row">
                    <div class="form-group"><label>Name <span class="req">*</span></label><input type="text" id="contactName" required></div>
                    <div class="form-group"><label>Phone</label><input type="tel" id="contactPhone"></div>
                </div>
                <div class="form-group"><label>Email <span class="req">*</span></label><input type="email" id="contactEmail" required></div>
            </div>
            <div class="form-card">
                <div class="section-header"><span>üîß</span><h3>Request Details</h3></div>
                <div class="form-group">
                    <label>Type <span class="req">*</span></label>
                    <div class="type-grid" id="typeGrid">
                        <button type="button" class="type-btn" data-type="HVAC"><div class="icon">‚ùÑÔ∏è</div><div class="label">HVAC</div></button>
                        <button type="button" class="type-btn" data-type="Plumbing"><div class="icon">üöø</div><div class="label">Plumbing</div></button>
                        <button type="button" class="type-btn" data-type="Electrical"><div class="icon">‚ö°</div><div class="label">Electrical</div></button>
                        <button type="button" class="type-btn" data-type="Roofing"><div class="icon">üè†</div><div class="label">Roofing</div></button>
                        <button type="button" class="type-btn" data-type="Landscaping"><div class="icon">üå≥</div><div class="label">Landscape</div></button>
                        <button type="button" class="type-btn" data-type="Pest"><div class="icon">üêú</div><div class="label">Pest</div></button>
                        <button type="button" class="type-btn" data-type="Parking"><div class="icon">üÖøÔ∏è</div><div class="label">Parking</div></button>
                        <button type="button" class="type-btn" data-type="Other"><div class="icon">üìã</div><div class="label">Other</div></button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Priority <span class="req">*</span></label>
                    <div class="priority-row" id="priorityRow">
                        <button type="button" class="priority-btn" data-priority="Low">üü¢ Low</button>
                        <button type="button" class="priority-btn selected" data-priority="Medium">üü° Medium</button>
                        <button type="button" class="priority-btn" data-priority="High">üü† High</button>
                        <button type="button" class="priority-btn" data-priority="Emergency">üî¥ Emergency</button>
                    </div>
                </div>
                <div class="form-group"><label>Location</label><input type="text" id="location" placeholder="Suite, floor, area"></div>
                <div class="form-group"><label>Description <span class="req">*</span></label><textarea id="description" required placeholder="Describe the issue..."></textarea></div>
                <div class="form-row">
                    <div class="form-group"><label>Preferred Date</label><input type="date" id="preferredDate"></div>
                    <div class="form-group"><label>Access Info</label><input type="text" id="accessInfo" placeholder="Key, contact"></div>
                </div>
            </div>
            <button type="submit" class="btn-submit" id="submitBtn">Submit Request</button>
        </form>
        <div id="successScreen" class="success-screen form-card">
            <div style="font-size:4rem">‚úÖ</div>
            <h2>Request Submitted!</h2>
            <p>Your request has been received.</p>
            <div class="request-id" id="requestIdDisplay"></div>
            <p>Confirmation email sent.</p>
            <button type="button" class="btn-submit" style="margin-top:1.5rem;max-width:300px" onclick="location.reload()">Submit Another</button>
        </div>
    </div>
    <script>
        var selectedType = '', selectedPriority = 'Medium', properties = [];
        fetch('/api/pm/properties/public').then(r => r.json()).then(data => {
            if (data.success) {
                properties = data.properties;
                var sel = document.getElementById('propertySelect');
                properties.forEach(function(p) {
                    var opt = document.createElement('option');
                    opt.value = p.account_number;
                    opt.textContent = p.short_name + ' - ' + p.property_name;
                    sel.appendChild(opt);
                });
            }
        });
        document.getElementById('propertySelect').onchange = function() {
            var p = properties.find(function(x) { return x.account_number === this.value; }.bind(this));
            var info = document.getElementById('propertyInfo');
            if (p) { info.innerHTML = '<strong>' + p.property_address + '</strong><br>' + p.city + ', ' + p.state + ' ' + p.zip; info.classList.add('visible'); }
            else { info.classList.remove('visible'); }
        };
        document.getElementById('typeGrid').onclick = function(e) {
            var btn = e.target.closest('.type-btn'); if (!btn) return;
            document.querySelectorAll('.type-btn').forEach(function(b) { b.classList.remove('selected'); });
            btn.classList.add('selected'); selectedType = btn.dataset.type;
        };
        document.getElementById('priorityRow').onclick = function(e) {
            var btn = e.target.closest('.priority-btn'); if (!btn) return;
            document.querySelectorAll('.priority-btn').forEach(function(b) { b.classList.remove('selected'); });
            btn.classList.add('selected'); selectedPriority = btn.dataset.priority;
        };
        document.getElementById('maintenanceForm').onsubmit = function(e) {
            e.preventDefault();
            var err = document.getElementById('errorMsg'); err.classList.remove('visible');
            if (!selectedType) { err.textContent = 'Please select request type.'; err.classList.add('visible'); return; }
            var btn = document.getElementById('submitBtn'); btn.disabled = true; btn.textContent = 'Submitting...';
            fetch('/api/pm/requests/public', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    account_number: document.getElementById('propertySelect').value,
                    contact_name: document.getElementById('contactName').value,
                    contact_phone: document.getElementById('contactPhone').value,
                    contact_email: document.getElementById('contactEmail').value,
                    request_type: selectedType, priority: selectedPriority,
                    location_in_building: document.getElementById('location').value,
                    description: document.getElementById('description').value,
                    preferred_date: document.getElementById('preferredDate').value,
                    access_instructions: document.getElementById('accessInfo').value
                })
            }).then(r => r.json()).then(data => {
                if (data.success) {
                    document.getElementById('maintenanceForm').style.display = 'none';
                    document.getElementById('requestIdDisplay').textContent = data.request_id;
                    document.getElementById('successScreen').classList.add('visible');
                } else { err.textContent = data.error || 'Failed'; err.classList.add('visible'); }
                btn.disabled = false; btn.textContent = 'Submit Request';
            }).catch(function() { err.textContent = 'Network error'; err.classList.add('visible'); btn.disabled = false; btn.textContent = 'Submit Request'; });
        };
    </script>
</body>
</html>
