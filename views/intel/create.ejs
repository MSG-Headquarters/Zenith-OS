<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INTEL Create - Zenith OS</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f1724; color: #e2e8f0; min-height: 100vh; display: flex; }

        /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
        .sidebar { width: 240px; background: #1a2332; display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.06); position: fixed; top: 0; bottom: 0; left: 0; z-index: 100; }
        .sidebar-header { padding: 20px 16px 16px; border-bottom: 1px solid rgba(255,255,255,0.06); }
        .sidebar-header h2 { font-size: 1.1rem; font-weight: 700; }
        .sidebar-header h2 span:first-child { color: #10b981; }
        .sidebar-header h2 span:last-child { color: #e2e8f0; }
        .sidebar-header p { color: #64748b; font-size: 0.75rem; margin-top: 2px; }
        .nav-section { padding: 12px 0; }
        .nav-section-label { color: #475569; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1.2px; padding: 0 16px 8px; font-weight: 600; }
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 9px 16px; color: #94a3b8; text-decoration: none; font-size: 0.85rem; transition: all 0.15s; border-left: 3px solid transparent; }
        .nav-item:hover { background: rgba(255,255,255,0.04); color: #e2e8f0; }
        .nav-item.active { background: rgba(16, 185, 129, 0.08); color: #10b981; border-left-color: #10b981; }
        .nav-icon { font-size: 1rem; width: 20px; text-align: center; }
        .sidebar-footer { margin-top: auto; padding: 16px; border-top: 1px solid rgba(255,255,255,0.06); }
        .sidebar-footer .user-info { display: flex; align-items: center; gap: 10px; }
        .sidebar-footer .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: #10b981; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; color: #fff; }
        .sidebar-footer .user-name { font-size: 0.8rem; color: #e2e8f0; }
        .sidebar-footer .user-role { font-size: 0.65rem; color: #64748b; }
        .sidebar-footer a { color: #64748b; font-size: 0.75rem; text-decoration: none; display: block; margin-top: 8px; }
        .sidebar-footer a:hover { color: #ef4444; }

        /* ‚îÄ‚îÄ Main Content ‚îÄ‚îÄ */
        .main-content { flex: 1; margin-left: 240px; min-height: 100vh; display: flex; flex-direction: column; }

        /* ‚îÄ‚îÄ Top Bar ‚îÄ‚îÄ */
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 16px 32px; border-bottom: 1px solid rgba(255,255,255,0.06); background: #1a2332; }
        .top-bar h1 { font-size: 1.35rem; font-weight: 700; }
        .top-bar h1 .accent { color: #10b981; }
        .top-bar-actions { display: flex; gap: 10px; }
        .btn { padding: 8px 16px; border-radius: 8px; font-size: 0.85rem; font-weight: 500; border: none; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; transition: all 0.15s; }
        .btn-ghost { background: transparent; color: #94a3b8; border: 1px solid rgba(255,255,255,0.1); }
        .btn-ghost:hover { background: rgba(255,255,255,0.05); color: #e2e8f0; }
        .btn-primary { background: #10b981; color: #fff; }
        .btn-primary:hover { background: #059669; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }

        /* ‚îÄ‚îÄ Sub-Tab Navigation ‚îÄ‚îÄ */
        .intel-tabs { display: flex; gap: 4px; padding: 12px 32px 0; background: #1a2332; }
        .intel-tab { padding: 10px 20px; border-radius: 8px 8px 0 0; font-size: 0.85rem; font-weight: 500; color: #64748b; text-decoration: none; display: flex; align-items: center; gap: 8px; transition: all 0.15s; border: 1px solid transparent; border-bottom: none; position: relative; }
        .intel-tab:hover { color: #e2e8f0; background: rgba(255,255,255,0.03); }
        .intel-tab.active { color: #10b981; background: #0f1724; border-color: rgba(255,255,255,0.06); }
        .intel-tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: #10b981; }
        .intel-tab i { font-size: 1rem; }

        /* ‚îÄ‚îÄ Create Layout: Project List + Canvas ‚îÄ‚îÄ */
        .create-container { flex: 1; display: flex; flex-direction: column; padding: 24px 32px; gap: 20px; }

        /* ‚îÄ‚îÄ Project List View ‚îÄ‚îÄ */
        .project-list-view { }
        .project-list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .project-list-title { font-size: 1.1rem; font-weight: 700; }
        .project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
        .project-card { background: #1a2332; border-radius: 14px; padding: 20px; border: 1px solid rgba(255,255,255,0.06); cursor: pointer; transition: all 0.2s; }
        .project-card:hover { border-color: rgba(16,185,129,0.25); transform: translateY(-2px); box-shadow: 0 6px 24px rgba(0,0,0,0.25); }
        .project-card-name { font-size: 1rem; font-weight: 600; color: #e2e8f0; margin-bottom: 4px; }
        .project-card-address { font-size: 0.8rem; color: #64748b; margin-bottom: 12px; }
        .project-card-meta { display: flex; gap: 12px; font-size: 0.75rem; color: #475569; }
        .project-card-meta span { display: flex; align-items: center; gap: 4px; }
        .project-empty { background: #1a2332; border-radius: 14px; padding: 48px; text-align: center; border: 1px solid rgba(255,255,255,0.06); }
        .project-empty i { font-size: 2.5rem; color: #334155; margin-bottom: 12px; }
        .project-empty h3 { font-size: 1rem; color: #94a3b8; margin-bottom: 4px; }
        .project-empty p { font-size: 0.85rem; color: #475569; margin-bottom: 16px; }

        /* ‚îÄ‚îÄ Canvas Editor View (hidden until project opened) ‚îÄ‚îÄ */
        .canvas-view { display: none; flex: 1; flex-direction: column; }
        .canvas-view.active { display: flex; }
        .canvas-toolbar { display: flex; gap: 6px; flex-wrap: wrap; padding: 12px 16px; background: #1a2332; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); margin-bottom: 12px; align-items: center; }
        .tool-btn { padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.08); background: transparent; color: #94a3b8; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; transition: all 0.15s; }
        .tool-btn:hover { background: rgba(255,255,255,0.05); color: #e2e8f0; }
        .tool-btn.active { background: rgba(16,185,129,0.12); color: #10b981; border-color: rgba(16,185,129,0.3); }
        .tool-sep { width: 1px; height: 28px; background: rgba(255,255,255,0.06); margin: 0 4px; }
        .canvas-area { flex: 1; display: flex; gap: 16px; min-height: 500px; position: relative; }
        .canvas-main { flex: 1; background: #1a2332; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .canvas-main canvas { border: 1px solid rgba(255,255,255,0.1); }

        /* ‚îÄ‚îÄ Logo Catalog Sidebar ‚îÄ‚îÄ */
        .logo-panel { width: 260px; background: #1a2332; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); display: flex; flex-direction: column; max-height: calc(100vh - 260px); }
        .logo-panel-header { padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.06); }
        .logo-panel-header h3 { font-size: 0.9rem; font-weight: 600; margin-bottom: 8px; }
        .logo-search { width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.08); background: #0f1724; color: #e2e8f0; font-size: 0.8rem; outline: none; }
        .logo-search:focus { border-color: #10b981; }
        .logo-search::placeholder { color: #475569; }
        .logo-categories { display: flex; gap: 4px; flex-wrap: wrap; padding: 10px 16px; border-bottom: 1px solid rgba(255,255,255,0.04); }
        .logo-cat { padding: 4px 10px; border-radius: 100px; font-size: 0.7rem; background: rgba(255,255,255,0.04); color: #64748b; cursor: pointer; border: 1px solid transparent; transition: all 0.15s; }
        .logo-cat:hover, .logo-cat.active { color: #10b981; border-color: rgba(16,185,129,0.3); background: rgba(16,185,129,0.08); }
        .logo-grid { flex: 1; overflow-y: auto; padding: 12px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .logo-item { aspect-ratio: 1; background: #0f1724; border-radius: 8px; border: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; justify-content: center; cursor: grab; padding: 6px; transition: all 0.15s; font-size: 0.6rem; color: #64748b; text-align: center; word-break: break-word; }
        .logo-item:hover { border-color: rgba(16,185,129,0.3); background: rgba(16,185,129,0.05); }
        .logo-item img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .logo-upload-btn { margin: 8px 12px 12px; padding: 8px; border-radius: 8px; border: 1px dashed rgba(255,255,255,0.15); background: transparent; color: #64748b; cursor: pointer; font-size: 0.8rem; text-align: center; transition: all 0.15s; }
        .logo-upload-btn:hover { border-color: #10b981; color: #10b981; }
        
        /* -- Floating Property Panel -- */
        .property-panel { 
            position: absolute; 
            left: 16px; 
            top: 16px; 
            width: 300px; 
            background: rgba(15, 23, 42, 0.92); 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px);
            border-radius: 16px; 
            border: 1px solid rgba(16,185,129,0.2); 
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            display: flex; 
            flex-direction: column; 
            max-height: calc(100vh - 300px); 
            overflow: hidden;
            z-index: 50;
            transition: all 0.3s ease;
        }
        .property-panel.collapsed { width: 52px; height: 52px; border-radius: 14px; }
        .property-panel.collapsed .property-panel-body { display: none; }
        .property-panel.collapsed .property-panel-header h3 span { display: none; }
        .property-panel.collapsed .property-panel-header .enrichment-status { display: none; }
        .property-panel-header { 
            padding: 14px 16px; 
            border-bottom: 1px solid rgba(255,255,255,0.06); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer;
            background: rgba(16, 185, 129, 0.08);
            border-radius: 16px 16px 0 0;
        }
        .property-panel.collapsed .property-panel-header { border-radius: 14px; }
        .property-panel-header:hover { background: rgba(16, 185, 129, 0.15); }
        .property-panel-header h3 { font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 8px; color: #10b981; margin: 0; }
        .property-panel-body { overflow-y: auto; flex: 1; }
        .property-panel-section { padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.04); }
        .property-panel-section h4 { font-size: 0.7rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; font-weight: 600; }
        .property-info-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.8rem; }
        .property-info-label { color: #64748b; }
        .property-info-value { color: #e2e8f0; font-weight: 500; text-align: right; max-width: 60%; }
        .property-address { font-size: 0.95rem; color: #fff; font-weight: 600; margin-bottom: 2px; }
        .property-city { font-size: 0.8rem; color: #94a3b8; }
        .photo-upload-zone { border: 2px dashed rgba(139,92,246,0.3); border-radius: 10px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.2s; background: rgba(139,92,246,0.05); }
        .photo-upload-zone:hover { border-color: #8b5cf6; background: rgba(139,92,246,0.1); }
        .photo-upload-zone i { font-size: 1.2rem; color: #8b5cf6; }
        .photo-upload-zone p { font-size: 0.75rem; color: #94a3b8; margin: 4px 0 0; }
        .photo-upload-zone span { font-size: 0.65rem; color: #64748b; }
        .photo-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 10px; }
        .photo-thumb { aspect-ratio: 1; border-radius: 8px; overflow: hidden; position: relative; cursor: pointer; border: 2px solid transparent; }
        .photo-thumb:hover { border-color: #8b5cf6; }
        .photo-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .api-asset-btn { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.08); background: transparent; color: #94a3b8; cursor: pointer; font-size: 0.75rem; width: 100%; margin-bottom: 6px; transition: all 0.15s; }
        .api-asset-btn:hover { background: rgba(255,255,255,0.05); color: #e2e8f0; }
        .api-asset-btn.loaded { border-color: rgba(16,185,129,0.3); color: #10b981; }
        .enrichment-status { font-size: 0.65rem; padding: 2px 8px; border-radius: 100px; background: rgba(16,185,129,0.15); color: #10b981; }
        .chat-section { padding: 12px 16px; }
        .chat-section h4 { font-size: 0.7rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .chat-messages { max-height: 120px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; margin-bottom: 8px; }
        .chat-msg { padding: 6px 10px; border-radius: 8px; font-size: 0.75rem; max-width: 90%; }
        .chat-msg.broker { background: rgba(139,92,246,0.15); color: #c4b5fd; align-self: flex-end; }
        .chat-msg.marketing { background: rgba(16,185,129,0.15); color: #6ee7b7; align-self: flex-start; }
        .chat-msg .chat-meta { font-size: 0.6rem; color: #64748b; margin-top: 2px; }
        .chat-empty { text-align: center; color: #475569; font-size: 0.7rem; padding: 12px 0; }
        .chat-input-wrap { display: flex; gap: 6px; }
        .chat-input { flex: 1; padding: 8px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.08); background: #0f1724; color: #e2e8f0; font-size: 0.75rem; outline: none; }
        .chat-input:focus { border-color: #10b981; }
        .chat-send { padding: 8px 10px; border-radius: 8px; background: #10b981; color: white; border: none; cursor: pointer; }
        .chat-send:hover { background: #059669; }
        .collapse-icon { transition: transform 0.3s; font-size: 0.8rem; color: #64748b; }
        .property-panel.collapsed .collapse-icon { transform: rotate(180deg); }

        /* ‚îÄ‚îÄ Page Tabs within a Project ‚îÄ‚îÄ */
        .page-tabs { display: flex; gap: 4px; margin-bottom: 12px; }
        .page-tab { padding: 8px 16px; border-radius: 8px; font-size: 0.8rem; color: #64748b; cursor: pointer; border: 1px solid rgba(255,255,255,0.06); background: transparent; transition: all 0.15s; }
        .page-tab:hover { color: #e2e8f0; }
        .page-tab.active { color: #10b981; background: rgba(16,185,129,0.08); border-color: rgba(16,185,129,0.25); }

        /* ‚îÄ‚îÄ New Project Modal ‚îÄ‚îÄ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-box { background: #1a2332; border-radius: 16px; border: 1px solid rgba(255,255,255,0.08); padding: 32px; width: 460px; max-width: 90vw; }
        .modal-title { font-size: 1.15rem; font-weight: 700; margin-bottom: 20px; }
        .modal-field { margin-bottom: 16px; }
        .modal-label { display: block; font-size: 0.8rem; color: #94a3b8; margin-bottom: 6px; font-weight: 500; }
        .modal-input { width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: #0f1724; color: #e2e8f0; font-size: 0.9rem; outline: none; }
        .modal-input:focus { border-color: #10b981; }
        .modal-input::placeholder { color: #475569; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 24px; }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <h2><span>ZENITH</span> <span>OS</span></h2>
            <p><%= typeof tenant !== 'undefined' && tenant ? tenant.name : 'CRE Consultants' %></p>
        </div>
        <div class="nav-section">
            <div class="nav-section-label">Navigation</div>
            <a href="/dashboard" class="nav-item"><span class="nav-icon"><i class="bi bi-house"></i></span> Dashboard</a>
            <a href="/crm" class="nav-item"><span class="nav-icon"><i class="bi bi-kanban"></i></span> CRM Pipeline</a>
            <a href="/intel" class="nav-item active"><span class="nav-icon"><i class="bi bi-broadcast"></i></span> INTEL</a>
            <a href="/huddle" class="nav-item"><span class="nav-icon"><i class="bi bi-chat-dots"></i></span> Huddle</a>
            <a href="/mailer" class="nav-item"><span class="nav-icon"><i class="bi bi-envelope"></i></span> Mailer</a>
            <a href="/vault" class="nav-item"><span class="nav-icon"><i class="bi bi-lock"></i></span> Vault</a>
            <a href="/pm" class="nav-item"><span class="nav-icon"><i class="bi bi-building"></i></span> Property Mgmt</a>
            <a href="/cfo" class="nav-item"><span class="nav-icon"><i class="bi bi-graph-up"></i></span> CFO</a>
            <a href="/danimal" class="nav-item"><span class="nav-icon"><i class="bi bi-database"></i></span> Danimal Data</a>
        </div>
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar"><%= typeof user !== 'undefined' && user && user.first_name ? user.first_name.charAt(0) : 'U' %><%= typeof user !== 'undefined' && user && user.last_name ? user.last_name.charAt(0) : '' %></div>
                <div>
                    <div class="user-name"><%= typeof user !== 'undefined' && user ? (user.first_name || '') + ' ' + (user.last_name || '') : 'User' %></div>
                    <div class="user-role"><%= typeof user !== 'undefined' && user ? user.role : '' %></div>
                </div>
            </div>
            <a href="/auth/logout"><i class="bi bi-box-arrow-left"></i> Sign Out</a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <h1><span class="accent">INTEL</span> Create</h1>
            <div class="top-bar-actions">
                <a href="/intel" class="btn btn-ghost"><i class="bi bi-arrow-left"></i> Back to INTEL</a>
                <button class="btn btn-primary" onclick="showNewProjectModal()"><i class="bi bi-plus-lg"></i> New Project</button>
            </div>
        </div>

        <!-- Sub-Tab Navigation -->
        <div class="intel-tabs">
            <a href="/intel" class="intel-tab">
                <i class="bi bi-grid-3x3-gap"></i> Overview
            </a>
            <a href="/intel/research" class="intel-tab">
                <i class="bi bi-search"></i> Research
            </a>
            <a href="/intel/create" class="intel-tab active">
                <i class="bi bi-brush"></i> Create
            </a>
        </div>

        <div class="create-container">
            <!-- PROJECT LIST VIEW -->
            <div class="project-list-view" id="projectListView">
                <div class="project-list-header">
                    <div class="project-list-title">Your Projects</div>
                </div>
                <div class="project-grid" id="projectGrid">
                    <div class="project-empty">
                        <i class="bi bi-folder-plus"></i>
                        <h3>No INTEL Projects Yet</h3>
                        <p>Create your first project to start building institutional-quality marketing materials.</p>
                        <button class="btn btn-primary" onclick="showNewProjectModal()"><i class="bi bi-plus-lg"></i> Create First Project</button>
                    </div>
                </div>
            </div>

            <!-- CANVAS EDITOR VIEW (hidden until project opened) -->
            <div class="canvas-view" id="canvasView">
                <!-- Page Tabs -->
                <div class="page-tabs" id="pageTabs">
                    <button class="page-tab active" data-page="aerial" onclick="switchPage('aerial')"><i class="bi bi-camera"></i> Aerial Hero</button>
                    <button class="page-tab" data-page="market" onclick="switchPage('market')"><i class="bi bi-map"></i> Market Map</button>
                    <button class="page-tab" data-page="site" onclick="switchPage('site')"><i class="bi bi-grid-3x3"></i> Site Plan</button>
                    <span style="flex:1;"></span>
                    <button class="btn btn-ghost btn-sm" onclick="backToProjects()"><i class="bi bi-arrow-left"></i> Projects</button>
                </div>

                <!-- Canvas Toolbar -->
                <div class="canvas-toolbar">
                    <button class="tool-btn" onclick="setTool('select')" id="tool-select" title="Select"><i class="bi bi-cursor"></i></button>
                    <button class="tool-btn" onclick="addText()" title="Add Text"><i class="bi bi-type"></i></button>
                    <button class="tool-btn" onclick="addArrow()" title="Add Arrow"><i class="bi bi-arrow-up-right"></i></button>
                    <button class="tool-btn" onclick="addRect()" title="Add Rectangle"><i class="bi bi-square"></i></button>
                    <button class="tool-btn" onclick="toggleDraw()" id="tool-draw" title="Freehand Draw"><i class="bi bi-pencil"></i></button>
                    <div class="tool-sep"></div>
                    <button class="tool-btn" onclick="uploadBackground()" title="Upload Background"><i class="bi bi-image"></i></button>
                    <div class="tool-sep"></div>
                    <button class="tool-btn" onclick="undoCanvas()" title="Undo (Ctrl+Z)"><i class="bi bi-arrow-counterclockwise"></i></button>
                    <button class="tool-btn" onclick="redoCanvas()" title="Redo (Ctrl+Y)"><i class="bi bi-arrow-clockwise"></i></button>
                    <div class="tool-sep"></div>
                    <button class="tool-btn" onclick="zoomIn()" title="Zoom In"><i class="bi bi-zoom-in"></i></button>
                    <button class="tool-btn" onclick="zoomOut()" title="Zoom Out"><i class="bi bi-zoom-out"></i></button>
                    <button class="tool-btn" onclick="zoomFit()" title="Fit to Screen"><i class="bi bi-fullscreen"></i></button>
                    <div class="tool-sep"></div>
                    <select class="tool-btn" id="canvasPreset" onchange="setCanvasPreset(this.value)" style="appearance:auto;padding-right:24px;">
                        <option value="letter">Letter (8.5√ó11)</option>
                        <option value="tabloid">Tabloid (11√ó17)</option>
                        <option value="linkedin" selected>LinkedIn (1200√ó630)</option>
                    </select>
                    <span style="flex:1;"></span>
                    <button class="tool-btn" onclick="saveCanvas()" title="Save (Ctrl+S)" style="color:#10b981;border-color:rgba(16,185,129,0.3);"><i class="bi bi-check-lg"></i> Save</button>
                    <button class="tool-btn" onclick="exportCanvas('png')" title="Export PNG"><i class="bi bi-download"></i> PNG</button>
                    <button class="tool-btn" onclick="shareLinkedIn()" title="Share to LinkedIn" style="color:#0a66c2;"><i class="bi bi-linkedin"></i></button>
                </div>

                <!-- Canvas + Panels -->
                <div class="canvas-area">
                    <!-- Property Info Panel (Left) -->
                    <div class="property-panel" id="propertyPanel">
                        <div class="property-panel-header" onclick="togglePropertyPanel()">
                            <h3><i class="bi bi-building"></i> <span>Property Info</span></h3>
                            <span class="enrichment-status ready" id="enrichmentStatus">Ready</span>
                            <i class="bi bi-chevron-down collapse-icon"></i>
                        </div>
                        <div class="property-panel-body">
                        <div class="property-panel-section">
                            <div class="property-address" id="propAddress">Loading...</div>
                            <div class="property-city" id="propCity"></div>
                        </div>
                        
                        <div class="property-panel-section">
                            <h4><i class="bi bi-info-circle"></i> Details</h4>
                            <div class="property-info-row">
                                <span class="property-info-label">Type</span>
                                <span class="property-info-value" id="propType">--</span>
                            </div>
                            <div class="property-info-row">
                                <span class="property-info-label">Size</span>
                                <span class="property-info-value" id="propSize">--</span>
                            </div>
                            <div class="property-info-row">
                                <span class="property-info-label">Price</span>
                                <span class="property-info-value" id="propPrice">--</span>
                            </div>
                            <div class="property-info-row">
                                <span class="property-info-label">Transaction</span>
                                <span class="property-info-value" id="propTransaction">--</span>
                            </div>
                        </div>
                        
                        <div class="property-panel-section">
                            <h4><i class="bi bi-cloud-download"></i> API Assets</h4>
                            <button class="api-asset-btn" onclick="fetchAerial()" id="btnAerial">
                                <i class="bi bi-camera"></i> Fetch Aerial Image
                            </button>
                            <button class="api-asset-btn" onclick="fetchDemographics()" id="btnDemo">
                                <i class="bi bi-people"></i> Demographics (1/3/5 mi)
                            </button>
                            <button class="api-asset-btn" onclick="fetchTraffic()" id="btnTraffic">
                                <i class="bi bi-signpost-2"></i> Traffic Counts
                            </button>
                            <button class="api-asset-btn" onclick="fetchTenants()" id="btnTenants">
                                <i class="bi bi-shop"></i> Nearby Tenants
                            </button>
                        </div>
                        
                        <div class="property-panel-section">
                            <h4><i class="bi bi-images"></i> Broker Photos</h4>
                            <div class="photo-upload-zone" onclick="document.getElementById('photoUpload').click()">
                                <i class="bi bi-cloud-arrow-up"></i>
                                <p>Drop photos here</p>
                                <span>or click to browse</span>
                            </div>
                            <input type="file" id="photoUpload" multiple accept="image/*" style="display:none" onchange="handlePhotoUpload(event)">
                            <div class="photo-grid" id="photoGrid"></div>
                        </div>
                        
                        <div class="chat-section">
                            <h4><i class="bi bi-chat-dots"></i> Broker ? Marketing <span class="unread-badge" id="unreadBadge" style="display:none">0</span></h4>
                            <div class="chat-messages" id="chatMessages">
                                <div class="chat-empty">No messages yet. Start the conversation!</div>
                            </div>
                            <div class="chat-input-wrap">
                                <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter')sendChatMessage()">
                                <button class="chat-send" onclick="sendChatMessage()"><i class="bi bi-send"></i></button>
                            </div>
                        </div>
                        </div>
                    </div>
                    
                    <!-- Canvas Main -->
                    <div class="canvas-main">
                        <canvas id="fabricCanvas"></canvas>
                    </div>
                    <div class="logo-panel">
                        <div class="logo-panel-header">
                            <h3><i class="bi bi-bookmark-star"></i> Logo Catalog</h3>
                            <input type="text" class="logo-search" placeholder="Search logos..." id="logoSearch" oninput="filterLogos(this.value)" />
                        </div>
                        <div class="logo-categories">
                            <span class="logo-cat active" onclick="filterCategory('all')">All</span>
                            <span class="logo-cat" onclick="filterCategory('retail')">Retail</span>
                            <span class="logo-cat" onclick="filterCategory('restaurant')">Food</span>
                            <span class="logo-cat" onclick="filterCategory('grocery')">Grocery</span>
                            <span class="logo-cat" onclick="filterCategory('bank')">Bank</span>
                            <span class="logo-cat" onclick="filterCategory('medical')">Medical</span>
                            <span class="logo-cat" onclick="filterCategory('fitness')">Fitness</span>
                        </div>
                        <div class="logo-grid" id="logoGrid">
                            <!-- Logos loaded dynamically from API -->
                        </div>
                        <button class="logo-upload-btn" onclick="uploadLogo()"><i class="bi bi-plus-lg"></i> Upload Logo</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Project Modal -->
    <div class="modal-overlay" id="newProjectModal">
        <div class="modal-box">
            <div class="modal-title"><i class="bi bi-folder-plus"></i> New INTEL Project</div>
            <div class="modal-field">
                <label class="modal-label">Project Name</label>
                <input type="text" class="modal-input" id="newProjectName" placeholder="e.g. 950 Encore Way Listing Package" />
            </div>
            <div class="modal-field">
                <label class="modal-label">Property Address</label>
                <input type="text" class="modal-input" id="newProjectAddress" placeholder="e.g. 950 Encore Way, Naples, FL 34110" />
            </div>
            <div class="modal-field">
                <label class="modal-label">Transaction Type</label>
                <select class="modal-input" id="newProjectType">
                    <option value="lease">Lease</option>
                    <option value="sale">Sale</option>
                    <option value="both">Lease & Sale</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createProject()"><i class="bi bi-plus-lg"></i> Create Project</button>
            </div>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="bgUpload" accept="image/*" style="display:none" onchange="handleBgUpload(event)" />
    <input type="file" id="logoUploadInput" accept="image/*" style="display:none" onchange="handleLogoUpload(event)" />

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // STATE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let canvas, currentProject = null, currentPage = 'aerial';
        let undoStack = [], redoStack = [];
        const PRESETS = {
            letter:   { w: 816, h: 1056 },
            tabloid:  { w: 1056, h: 1632 },
            linkedin: { w: 1200, h: 630 }
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INIT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        document.addEventListener('DOMContentLoaded', () => {
            canvas = new fabric.Canvas('fabricCanvas', {
                width: 1200, height: 630,
                backgroundColor: '#1e293b',
                selection: true
            });
            canvas.on('object:modified', saveState);
            canvas.on('object:added', saveState);

            loadProjects();
            loadLogos();

            // Check for ?address= or ?project= params
            const params = new URLSearchParams(window.location.search);
            if (params.get('address')) {
                document.getElementById('newProjectAddress').value = params.get('address');
                showNewProjectModal();
            }
            if (params.get('project')) {
                openProject(params.get('project'));
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PROJECT MANAGEMENT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function loadProjects() {
            try {
                const res = await fetch('/api/intel/projects');
                if (!res.ok) return;
                const data = await res.json();
                const grid = document.getElementById('projectGrid');
                if (data.projects && data.projects.length > 0) {
                    grid.innerHTML = data.projects.map(p =>
                        '<div class="project-card" onclick="openProject(\'' + p.id + '\')">' +
                        '<div class="project-card-name">' + (p.name || 'Untitled') + '</div>' +
                        '<div class="project-card-address">' + (p.address || 'No address') + '</div>' +
                        '<div class="project-card-meta">' +
                        '<span><i class="bi bi-file-earmark"></i> ' + (p.page_count || 3) + ' pages</span>' +
                        '<span><i class="bi bi-calendar3"></i> ' + new Date(p.updated_at || p.created_at).toLocaleDateString() + '</span>' +
                        '</div></div>'
                    ).join('');
                }
            } catch (e) { console.error('[INTEL] Load projects error:', e); }
        }

        function showNewProjectModal() { document.getElementById('newProjectModal').classList.add('active'); document.getElementById('newProjectName').focus(); }
        function closeModal() { document.getElementById('newProjectModal').classList.remove('active'); }

        async function createProject() {
            const name = document.getElementById('newProjectName').value.trim();
            const address = document.getElementById('newProjectAddress').value.trim();
            const type = document.getElementById('newProjectType').value;
            if (!name) { document.getElementById('newProjectName').focus(); return; }

            try {
                const res = await fetch('/api/intel/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, address, transaction_type: type })
                });
                if (res.ok) {
                    const data = await res.json();
                    closeModal();
                    openProject(data.project.id);
                    loadProjects();
                }
            } catch (e) { console.error('[INTEL] Create project error:', e); }
        }

        async function openProject(id) {
            currentProject = id;
            document.getElementById('projectListView').style.display = 'none';
            document.getElementById('canvasView').classList.add('active');

            // Load the first page canvas state
            try {
                const res = await fetch('/api/intel/projects/' + id + '/pages');
                if (res.ok) {
                    const data = await res.json();
                    if (data.pages && data.pages.length > 0) {
                        const page = data.pages.find(p => p.page_type === currentPage) || data.pages[0];
                        if (page.canvas_state) {
                            canvas.loadFromJSON(page.canvas_state, () => { canvas.renderAll(); });
                        } else {
                            canvas.clear();
                            canvas.backgroundColor = '#1e293b';
                            canvas.renderAll();
                        }
                    }
                }
            } catch (e) { console.error('[INTEL] Load pages error:', e); }
            
            // Load project property info
            await loadPropertyInfo(id);
            await loadChatMessages();
            startChatPolling();
        }

        // ---------------------------------------------------
        // PROPERTY INFO & PHOTOS
        // ---------------------------------------------------
        let currentProjectData = null;
        
        function togglePropertyPanel() {
            const panel = document.getElementById('propertyPanel');
            panel.classList.toggle('collapsed');
        }
        let brokerPhotos = [];

        async function loadPropertyInfo(projectId) {
            try {
                const res = await fetch('/api/intel/projects/' + projectId);
                if (res.ok) {
                    const data = await res.json();
                    currentProjectData = data.project;
                    
                    document.getElementById('propAddress').textContent = data.project.property_address || 'No address';
                    document.getElementById('propCity').textContent = [
                        data.project.property_city, data.project.property_state, data.project.property_zip
                    ].filter(Boolean).join(', ') || '';
                    
                    document.getElementById('propType').textContent = data.project.property_type || '--';
                    document.getElementById('propSize').textContent = data.project.property_size ? 
                        data.project.property_size.toLocaleString() + ' ' + (data.project.size_unit || 'SF') : '--';
                    document.getElementById('propPrice').textContent = data.project.price ? 
                        '$' + data.project.price.toLocaleString() : '--';
                    document.getElementById('propTransaction').textContent = data.project.transaction_type || '--';
                    
                    if (data.project.enrichment_data) {
                        document.getElementById('enrichmentStatus').textContent = 'Enriched';
                    }
                    if (data.project.photos) {
                        brokerPhotos = data.project.photos;
                        renderPhotoGrid();
                    }
                }
            } catch (e) { console.error('[INTEL] Load property info error:', e); }
        }

        function handlePhotoUpload(event) {
            const files = event.target.files;
            if (!files.length) return;
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    brokerPhotos.push({ id: Date.now(), name: file.name, data: e.target.result });
                    renderPhotoGrid();
                };
                reader.readAsDataURL(file);
            }
        }

        function renderPhotoGrid() {
            const grid = document.getElementById('photoGrid');
            grid.innerHTML = brokerPhotos.map((photo, idx) => 
                '<div class="photo-thumb" onclick="addPhotoToCanvas(' + idx + ')">' +
                '<img src="' + photo.data + '" alt="' + photo.name + '">' +
                '<button class="photo-delete" onclick="event.stopPropagation(); deletePhoto(' + idx + ')"><i class="bi bi-x"></i></button></div>'
            ).join('');
        }

        function addPhotoToCanvas(idx) {
            const photo = brokerPhotos[idx];
            if (!photo) return;
            fabric.Image.fromURL(photo.data, function(img) {
                img.scaleToWidth(Math.min(400, canvas.width * 0.5));
                img.set({ left: 50, top: 50 });
                canvas.add(img);
                canvas.setActiveObject(img);
                canvas.renderAll();
            });
        }

        function deletePhoto(idx) {
            brokerPhotos.splice(idx, 1);
            renderPhotoGrid();
        }

        async function fetchAerial() {
            if (!currentProjectData || !currentProjectData.lat) {
                alert('Property coordinates not available.');
                return;
            }
            var btn = document.getElementById('btnAerial');
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Fetching...';
            try {
                var res = await fetch('/api/intel/aerial/image?lat=' + currentProjectData.lat + '&lon=' + currentProjectData.lng);
                if (res.ok) {
                    var blob = await res.blob();
                    var url = URL.createObjectURL(blob);
                    fabric.Image.fromURL(url, function(img) {
                        img.scaleToWidth(canvas.width);
                        canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                    });
                    btn.innerHTML = '<i class="bi bi-check-lg"></i> Aerial Loaded';
                    btn.classList.add('loaded');
                }
            } catch (e) {
                btn.innerHTML = '<i class="bi bi-camera"></i> Fetch Aerial';
                alert('Could not fetch aerial. EagleView pending.');
            }
        }

        async function fetchDemographics() {
            alert('Demographics API coming soon! (ArcGIS pending)');
        }

        async function fetchTraffic() {
            if (!currentProjectData || !currentProjectData.lat) { alert('No coordinates'); return; }
            var btn = document.getElementById('btnTraffic');
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Fetching...';
            try {
                var res = await fetch('/api/danimal/traffic/nearby?lat=' + currentProjectData.lat + '&lng=' + currentProjectData.lng + '&radius=2');
                if (res.ok) {
                    var data = await res.json();
                    if (data.results && data.results.length > 0) {
                        var txt = data.results.slice(0,5).map(function(t) { return t.road_name + ': ' + (t.aadt || 'N/A') + ' AADT'; }).join('\n');
                        var text = new fabric.Textbox(txt, { left:50, top:50, width:300, fontFamily:'Arial', fontSize:16, fill:'#fff', backgroundColor:'rgba(0,0,0,0.7)', padding:10 });
                        canvas.add(text);
                        canvas.renderAll();
                        btn.innerHTML = '<i class="bi bi-check-lg"></i> Traffic Added';
                        btn.classList.add('loaded');
                    } else { alert('No traffic data nearby.'); btn.innerHTML = '<i class="bi bi-signpost-2"></i> Traffic Counts'; }
                }
            } catch(e) { btn.innerHTML = '<i class="bi bi-signpost-2"></i> Traffic Counts'; }
        }

        async function fetchTenants() {
            if (!currentProjectData || !currentProjectData.lat) { alert('No coordinates'); return; }
            var btn = document.getElementById('btnTenants');
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Fetching...';
            try {
                var res = await fetch('/api/intel/places/search?query=retail+restaurant&lat=' + currentProjectData.lat + '&lng=' + currentProjectData.lng + '&radius=1000');
                if (res.ok) {
                    var data = await res.json();
                    if (data.results && data.results.length > 0) {
                        var txt = 'NEARBY TENANTS:\n' + data.results.slice(0,10).map(function(t) { return 'ï ' + t.name; }).join('\n');
                        var text = new fabric.Textbox(txt, { left:400, top:50, width:250, fontFamily:'Arial', fontSize:14, fill:'#fff', backgroundColor:'rgba(0,0,0,0.7)', padding:10 });
                        canvas.add(text);
                        canvas.renderAll();
                        btn.innerHTML = '<i class="bi bi-check-lg"></i> Tenants Added';
                        btn.classList.add('loaded');
                    } else { alert('No tenants found.'); btn.innerHTML = '<i class="bi bi-shop"></i> Nearby Tenants'; }
                }
            } catch(e) { btn.innerHTML = '<i class="bi bi-shop"></i> Nearby Tenants'; }
        }

        // ---------------------------------------------------
        // BROKER ? MARKETING CHAT
        // ---------------------------------------------------
        let chatMessages = [];
        let chatPollInterval = null;

        async function loadChatMessages() {
            if (!currentProject) return;
            try {
                const res = await fetch('/api/intel/projects/' + currentProject + '/comments');
                if (res.ok) {
                    const data = await res.json();
                    chatMessages = data.comments || [];
                    renderChatMessages();
                }
            } catch (e) { console.error('Load chat error:', e); }
        }

        function renderChatMessages() {
            const container = document.getElementById('chatMessages');
            if (chatMessages.length === 0) {
                container.innerHTML = '<div class="chat-empty">No messages yet. Start the conversation!</div>';
                return;
            }
            container.innerHTML = chatMessages.map(function(msg) {
                var msgClass = msg.is_from_broker ? 'broker' : 'marketing';
                var time = new Date(msg.created_at).toLocaleString();
                return '<div class="chat-msg ' + msgClass + '">' +
                    '<div>' + msg.message + '</div>' +
                    '<div class="chat-meta">' + (msg.user_name || 'User') + ' ï ' + time + '</div>' +
                '</div>';
            }).join('');
            container.scrollTop = container.scrollHeight;
        }

        async function sendChatMessage() {
            var input = document.getElementById('chatInput');
            var message = input.value.trim();
            if (!message || !currentProject) return;
            
            input.value = '';
            try {
                var res = await fetch('/api/intel/projects/' + currentProject + '/comments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });
                if (res.ok) {
                    loadChatMessages();
                }
            } catch (e) { console.error('Send message error:', e); }
        }

        function startChatPolling() {
            if (chatPollInterval) clearInterval(chatPollInterval);
            chatPollInterval = setInterval(loadChatMessages, 10000);
        }

        function stopChatPolling() {
            if (chatPollInterval) {
                clearInterval(chatPollInterval);
                chatPollInterval = null;
            }
        }

        function backToProjects() {
            stopChatPolling();
            currentProject = null;
            document.getElementById('projectListView').style.display = '';
            document.getElementById('canvasView').classList.remove('active');
            canvas.clear();
            loadProjects();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PAGE SWITCHING
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function switchPage(pageType) {
            if (!currentProject) return;
            // Save current page first
            await saveCanvas();
            currentPage = pageType;
            document.querySelectorAll('.page-tab').forEach(t => t.classList.toggle('active', t.dataset.page === pageType));

            try {
                const res = await fetch('/api/intel/projects/' + currentProject + '/pages');
                if (res.ok) {
                    const data = await res.json();
                    const page = data.pages.find(p => p.page_type === pageType);
                    if (page && page.canvas_state) {
                        canvas.loadFromJSON(page.canvas_state, () => canvas.renderAll());
                    } else {
                        canvas.clear();
                        canvas.backgroundColor = '#1e293b';
                        canvas.renderAll();
                    }
                }
            } catch (e) { console.error('[INTEL] Switch page error:', e); }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CANVAS TOOLS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function setTool(tool) { canvas.isDrawingMode = false; canvas.selection = true; }
        function addText() { const t = new fabric.IText('Label', { left: 100, top: 100, fontFamily: 'Arial', fontSize: 24, fill: '#ffffff', fontWeight: 'bold' }); canvas.add(t); canvas.setActiveObject(t); }
        function addArrow() { const line = new fabric.Line([50, 50, 200, 50], { stroke: '#10b981', strokeWidth: 3, selectable: true }); canvas.add(line); }
        function addRect() { const r = new fabric.Rect({ left: 100, top: 100, width: 200, height: 120, fill: 'transparent', stroke: '#10b981', strokeWidth: 2 }); canvas.add(r); }
        function toggleDraw() { canvas.isDrawingMode = !canvas.isDrawingMode; document.getElementById('tool-draw').classList.toggle('active', canvas.isDrawingMode); if (canvas.isDrawingMode) { canvas.freeDrawingBrush.color = '#10b981'; canvas.freeDrawingBrush.width = 3; } }
        function uploadBackground() { document.getElementById('bgUpload').click(); }
        function handleBgUpload(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (ev) => { fabric.Image.fromURL(ev.target.result, (img) => { img.scaleToWidth(canvas.width); canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas)); }); }; reader.readAsDataURL(file); }

        // Undo / Redo
        function saveState() { undoStack.push(canvas.toJSON()); if (undoStack.length > 30) undoStack.shift(); redoStack = []; }
        function undoCanvas() { if (undoStack.length < 2) return; redoStack.push(undoStack.pop()); canvas.loadFromJSON(undoStack[undoStack.length - 1], () => canvas.renderAll()); }
        function redoCanvas() { if (!redoStack.length) return; const state = redoStack.pop(); undoStack.push(state); canvas.loadFromJSON(state, () => canvas.renderAll()); }

        // Zoom
        function zoomIn() { canvas.setZoom(Math.min(canvas.getZoom() * 1.2, 5)); canvas.renderAll(); }
        function zoomOut() { canvas.setZoom(Math.max(canvas.getZoom() / 1.2, 0.2)); canvas.renderAll(); }
        function zoomFit() { canvas.setZoom(1); canvas.renderAll(); }

        // Canvas Presets
        function setCanvasPreset(preset) { const p = PRESETS[preset]; if (p) { canvas.setDimensions({ width: p.w, height: p.h }); canvas.renderAll(); } }

        // Save
        async function saveCanvas() {
            if (!currentProject) return;
            try {
                await fetch('/api/intel/projects/' + currentProject + '/pages/' + currentPage, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ canvas_state: canvas.toJSON() })
                });
            } catch (e) { console.error('[INTEL] Save error:', e); }
        }

        // Export
        async function exportCanvas(format) {
            const dataURL = canvas.toDataURL({ format: format || 'png', multiplier: 2 });
            const a = document.createElement('a');
            a.href = dataURL;
            a.download = 'intel-export-' + Date.now() + '.' + (format || 'png');
            a.click();
        }

        // LinkedIn Share
        function shareLinkedIn() {
            exportCanvas('png');
            window.open('https://www.linkedin.com/sharing/share-offsite/', '_blank');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // LOGO CATALOG
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let allLogos = [];
        async function loadLogos() {
            try {
                const res = await fetch('/api/intel/logos');
                if (res.ok) {
                    const data = await res.json();
                    allLogos = data.logos || [];
                    renderLogos(allLogos);
                }
            } catch (e) {
                // No logos yet - show empty state
                document.getElementById('logoGrid').innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px;color:#475569;font-size:0.8rem;">No logos yet. Upload to get started.</div>';
            }
        }

        function renderLogos(logos) {
            const grid = document.getElementById('logoGrid');
            if (!logos.length) { grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px;color:#475569;font-size:0.8rem;">No logos found</div>'; return; }
            grid.innerHTML = logos.map(l =>
                '<div class="logo-item" draggable="true" ondragstart="dragLogo(event,\'' + (l.image_url || '') + '\')" onclick="addLogoToCanvas(\'' + (l.image_url || '') + '\')" title="' + l.name + '">' +
                (l.image_url ? '<img src="' + l.image_url + '" alt="' + l.name + '" />' : l.name) +
                '</div>'
            ).join('');
        }

        function filterLogos(query) { const q = query.toLowerCase(); renderLogos(allLogos.filter(l => l.name.toLowerCase().includes(q))); }
        function filterCategory(cat) {
            document.querySelectorAll('.logo-cat').forEach(c => c.classList.toggle('active', c.textContent.toLowerCase() === cat || (cat === 'all' && c.textContent === 'All')));
            if (cat === 'all') { renderLogos(allLogos); } else { renderLogos(allLogos.filter(l => l.category === cat)); }
        }

        function addLogoToCanvas(url) { if (!url) return; fabric.Image.fromURL(url, (img) => { img.scaleToWidth(80); canvas.add(img); canvas.setActiveObject(img); }, { crossOrigin: 'anonymous' }); }
        function dragLogo(e, url) { e.dataTransfer.setData('text/plain', url); }
        function uploadLogo() { document.getElementById('logoUploadInput').click(); }
        function handleLogoUpload(e) { /* Phase 1: Local only - uploads handled via API in production */ }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // KEYBOARD SHORTCUTS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'z') { e.preventDefault(); undoCanvas(); }
            if (e.ctrlKey && e.key === 'y') { e.preventDefault(); redoCanvas(); }
            if (e.ctrlKey && e.key === 's') { e.preventDefault(); saveCanvas(); }
            if (e.key === 'Delete' || e.key === 'Backspace') {
                const obj = canvas.getActiveObject();
                if (obj && !(obj instanceof fabric.IText && obj.isEditing)) { canvas.remove(obj); }
            }
        });
    </script>
<%- include('../partials/notification-bubble') %>
</body>
</html>
