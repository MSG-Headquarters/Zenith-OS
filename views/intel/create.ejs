<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INTEL Create - Zenith OS</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f1724; color: #e2e8f0; min-height: 100vh; display: flex; }

        /* ── Sidebar ── */
        .sidebar { width: 240px; background: #1a2332; display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.06); position: fixed; top: 0; bottom: 0; left: 0; z-index: 100; }
        .sidebar-header { padding: 20px 16px 16px; border-bottom: 1px solid rgba(255,255,255,0.06); }
        .sidebar-header h2 { font-size: 1.1rem; font-weight: 700; }
        .sidebar-header h2 span:first-child { color: #10b981; }
        .sidebar-header h2 span:last-child { color: #e2e8f0; }
        .sidebar-header p { color: #64748b; font-size: 0.75rem; margin-top: 2px; }
        .nav-section { padding: 12px 0; }
        .nav-section-label { color: #475569; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1.2px; padding: 0 16px 8px; font-weight: 600; }
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 9px 16px; color: #94a3b8; text-decoration: none; font-size: 0.85rem; transition: all 0.15s; border-left: 3px solid transparent; }
        .nav-item:hover { background: rgba(255,255,255,0.04); color: #e2e8f0; }
        .nav-item.active { background: rgba(16, 185, 129, 0.08); color: #10b981; border-left-color: #10b981; }
        .nav-icon { font-size: 1rem; width: 20px; text-align: center; }
        .sidebar-footer { margin-top: auto; padding: 16px; border-top: 1px solid rgba(255,255,255,0.06); }
        .sidebar-footer .user-info { display: flex; align-items: center; gap: 10px; }
        .sidebar-footer .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: #10b981; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; color: #fff; }
        .sidebar-footer .user-name { font-size: 0.8rem; color: #e2e8f0; }
        .sidebar-footer .user-role { font-size: 0.65rem; color: #64748b; }
        .sidebar-footer a { color: #64748b; font-size: 0.75rem; text-decoration: none; display: block; margin-top: 8px; }
        .sidebar-footer a:hover { color: #ef4444; }

        /* ── Main Content ── */
        .main-content { flex: 1; margin-left: 240px; min-height: 100vh; display: flex; flex-direction: column; }

        /* ── Top Bar ── */
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 16px 32px; border-bottom: 1px solid rgba(255,255,255,0.06); background: #1a2332; }
        .top-bar h1 { font-size: 1.35rem; font-weight: 700; }
        .top-bar h1 .accent { color: #10b981; }
        .top-bar-actions { display: flex; gap: 10px; }
        .btn { padding: 8px 16px; border-radius: 8px; font-size: 0.85rem; font-weight: 500; border: none; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; transition: all 0.15s; }
        .btn-ghost { background: transparent; color: #94a3b8; border: 1px solid rgba(255,255,255,0.1); }
        .btn-ghost:hover { background: rgba(255,255,255,0.05); color: #e2e8f0; }
        .btn-primary { background: #10b981; color: #fff; }
        .btn-primary:hover { background: #059669; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }

        /* ── Sub-Tab Navigation ── */
        .intel-tabs { display: flex; gap: 4px; padding: 12px 32px 0; background: #1a2332; }
        .intel-tab { padding: 10px 20px; border-radius: 8px 8px 0 0; font-size: 0.85rem; font-weight: 500; color: #64748b; text-decoration: none; display: flex; align-items: center; gap: 8px; transition: all 0.15s; border: 1px solid transparent; border-bottom: none; position: relative; }
        .intel-tab:hover { color: #e2e8f0; background: rgba(255,255,255,0.03); }
        .intel-tab.active { color: #10b981; background: #0f1724; border-color: rgba(255,255,255,0.06); }
        .intel-tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: #10b981; }
        .intel-tab i { font-size: 1rem; }

        /* ── Create Layout: Project List + Canvas ── */
        .create-container { flex: 1; display: flex; flex-direction: column; padding: 24px 32px; gap: 20px; }

        /* ── Project List View ── */
        .project-list-view { }
        .project-list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .project-list-title { font-size: 1.1rem; font-weight: 700; }
        .project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
        .project-card { background: #1a2332; border-radius: 14px; padding: 20px; border: 1px solid rgba(255,255,255,0.06); cursor: pointer; transition: all 0.2s; }
        .project-card:hover { border-color: rgba(16,185,129,0.25); transform: translateY(-2px); box-shadow: 0 6px 24px rgba(0,0,0,0.25); }
        .project-card-name { font-size: 1rem; font-weight: 600; color: #e2e8f0; margin-bottom: 4px; }
        .project-card-address { font-size: 0.8rem; color: #64748b; margin-bottom: 12px; }
        .project-card-meta { display: flex; gap: 12px; font-size: 0.75rem; color: #475569; }
        .project-card-meta span { display: flex; align-items: center; gap: 4px; }
        .project-empty { background: #1a2332; border-radius: 14px; padding: 48px; text-align: center; border: 1px solid rgba(255,255,255,0.06); }
        .project-empty i { font-size: 2.5rem; color: #334155; margin-bottom: 12px; }
        .project-empty h3 { font-size: 1rem; color: #94a3b8; margin-bottom: 4px; }
        .project-empty p { font-size: 0.85rem; color: #475569; margin-bottom: 16px; }

        /* ── Canvas Editor View (hidden until project opened) ── */
        .canvas-view { display: none; flex: 1; flex-direction: column; }
        .canvas-view.active { display: flex; }
        .canvas-toolbar { display: flex; gap: 6px; flex-wrap: wrap; padding: 12px 16px; background: #1a2332; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); margin-bottom: 12px; align-items: center; }
        .tool-btn { padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.08); background: transparent; color: #94a3b8; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; transition: all 0.15s; }
        .tool-btn:hover { background: rgba(255,255,255,0.05); color: #e2e8f0; }
        .tool-btn.active { background: rgba(16,185,129,0.12); color: #10b981; border-color: rgba(16,185,129,0.3); }
        .tool-sep { width: 1px; height: 28px; background: rgba(255,255,255,0.06); margin: 0 4px; }
        .canvas-area { flex: 1; display: flex; gap: 16px; min-height: 500px; }
        .canvas-main { flex: 1; background: #1a2332; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .canvas-main canvas { border: 1px solid rgba(255,255,255,0.1); }

        /* ── Logo Catalog Sidebar ── */
        .logo-panel { width: 260px; background: #1a2332; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); display: flex; flex-direction: column; max-height: calc(100vh - 260px); }
        .logo-panel-header { padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.06); }
        .logo-panel-header h3 { font-size: 0.9rem; font-weight: 600; margin-bottom: 8px; }
        .logo-search { width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.08); background: #0f1724; color: #e2e8f0; font-size: 0.8rem; outline: none; }
        .logo-search:focus { border-color: #10b981; }
        .logo-search::placeholder { color: #475569; }
        .logo-categories { display: flex; gap: 4px; flex-wrap: wrap; padding: 10px 16px; border-bottom: 1px solid rgba(255,255,255,0.04); }
        .logo-cat { padding: 4px 10px; border-radius: 100px; font-size: 0.7rem; background: rgba(255,255,255,0.04); color: #64748b; cursor: pointer; border: 1px solid transparent; transition: all 0.15s; }
        .logo-cat:hover, .logo-cat.active { color: #10b981; border-color: rgba(16,185,129,0.3); background: rgba(16,185,129,0.08); }
        .logo-grid { flex: 1; overflow-y: auto; padding: 12px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .logo-item { aspect-ratio: 1; background: #0f1724; border-radius: 8px; border: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; justify-content: center; cursor: grab; padding: 6px; transition: all 0.15s; font-size: 0.6rem; color: #64748b; text-align: center; word-break: break-word; }
        .logo-item:hover { border-color: rgba(16,185,129,0.3); background: rgba(16,185,129,0.05); }
        .logo-item img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .logo-upload-btn { margin: 8px 12px 12px; padding: 8px; border-radius: 8px; border: 1px dashed rgba(255,255,255,0.15); background: transparent; color: #64748b; cursor: pointer; font-size: 0.8rem; text-align: center; transition: all 0.15s; }
        .logo-upload-btn:hover { border-color: #10b981; color: #10b981; }

        /* ── Page Tabs within a Project ── */
        .page-tabs { display: flex; gap: 4px; margin-bottom: 12px; }
        .page-tab { padding: 8px 16px; border-radius: 8px; font-size: 0.8rem; color: #64748b; cursor: pointer; border: 1px solid rgba(255,255,255,0.06); background: transparent; transition: all 0.15s; }
        .page-tab:hover { color: #e2e8f0; }
        .page-tab.active { color: #10b981; background: rgba(16,185,129,0.08); border-color: rgba(16,185,129,0.25); }

        /* ── New Project Modal ── */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-box { background: #1a2332; border-radius: 16px; border: 1px solid rgba(255,255,255,0.08); padding: 32px; width: 460px; max-width: 90vw; }
        .modal-title { font-size: 1.15rem; font-weight: 700; margin-bottom: 20px; }
        .modal-field { margin-bottom: 16px; }
        .modal-label { display: block; font-size: 0.8rem; color: #94a3b8; margin-bottom: 6px; font-weight: 500; }
        .modal-input { width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: #0f1724; color: #e2e8f0; font-size: 0.9rem; outline: none; }
        .modal-input:focus { border-color: #10b981; }
        .modal-input::placeholder { color: #475569; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 24px; }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <h2><span>ZENITH</span> <span>OS</span></h2>
            <p><%= typeof tenant !== 'undefined' && tenant ? tenant.name : 'CRE Consultants' %></p>
        </div>
        <div class="nav-section">
            <div class="nav-section-label">Navigation</div>
            <a href="/dashboard" class="nav-item"><span class="nav-icon"><i class="bi bi-house"></i></span> Dashboard</a>
            <a href="/crm" class="nav-item"><span class="nav-icon"><i class="bi bi-kanban"></i></span> CRM Pipeline</a>
            <a href="/intel" class="nav-item active"><span class="nav-icon"><i class="bi bi-broadcast"></i></span> INTEL</a>
            <a href="/huddle" class="nav-item"><span class="nav-icon"><i class="bi bi-chat-dots"></i></span> Huddle</a>
            <a href="/mailer" class="nav-item"><span class="nav-icon"><i class="bi bi-envelope"></i></span> Mailer</a>
            <a href="/vault" class="nav-item"><span class="nav-icon"><i class="bi bi-lock"></i></span> Vault</a>
            <a href="/pm" class="nav-item"><span class="nav-icon"><i class="bi bi-building"></i></span> Property Mgmt</a>
            <a href="/cfo" class="nav-item"><span class="nav-icon"><i class="bi bi-graph-up"></i></span> CFO</a>
            <a href="/danimal" class="nav-item"><span class="nav-icon"><i class="bi bi-database"></i></span> Danimal Data</a>
        </div>
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar"><%= typeof user !== 'undefined' && user && user.first_name ? user.first_name.charAt(0) : 'U' %><%= typeof user !== 'undefined' && user && user.last_name ? user.last_name.charAt(0) : '' %></div>
                <div>
                    <div class="user-name"><%= typeof user !== 'undefined' && user ? (user.first_name || '') + ' ' + (user.last_name || '') : 'User' %></div>
                    <div class="user-role"><%= typeof user !== 'undefined' && user ? user.role : '' %></div>
                </div>
            </div>
            <a href="/auth/logout"><i class="bi bi-box-arrow-left"></i> Sign Out</a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <h1><span class="accent">INTEL</span> Create</h1>
            <div class="top-bar-actions">
                <a href="/intel" class="btn btn-ghost"><i class="bi bi-arrow-left"></i> Back to INTEL</a>
                <button class="btn btn-primary" onclick="showNewProjectModal()"><i class="bi bi-plus-lg"></i> New Project</button>
            </div>
        </div>

        <!-- Sub-Tab Navigation -->
        <div class="intel-tabs">
            <a href="/intel" class="intel-tab">
                <i class="bi bi-grid-3x3-gap"></i> Overview
            </a>
            <a href="/intel/research" class="intel-tab">
                <i class="bi bi-search"></i> Research
            </a>
            <a href="/intel/create" class="intel-tab active">
                <i class="bi bi-brush"></i> Create
            </a>
        </div>

        <div class="create-container">
            <!-- PROJECT LIST VIEW -->
            <div class="project-list-view" id="projectListView">
                <div class="project-list-header">
                    <div class="project-list-title">Your Projects</div>
                </div>
                <div class="project-grid" id="projectGrid">
                    <div class="project-empty">
                        <i class="bi bi-folder-plus"></i>
                        <h3>No INTEL Projects Yet</h3>
                        <p>Create your first project to start building institutional-quality marketing materials.</p>
                        <button class="btn btn-primary" onclick="showNewProjectModal()"><i class="bi bi-plus-lg"></i> Create First Project</button>
                    </div>
                </div>
            </div>

            <!-- CANVAS EDITOR VIEW (hidden until project opened) -->
            <div class="canvas-view" id="canvasView">
                <!-- Page Tabs -->
                <div class="page-tabs" id="pageTabs">
                    <button class="page-tab active" data-page="aerial" onclick="switchPage('aerial')"><i class="bi bi-camera"></i> Aerial Hero</button>
                    <button class="page-tab" data-page="market" onclick="switchPage('market')"><i class="bi bi-map"></i> Market Map</button>
                    <button class="page-tab" data-page="site" onclick="switchPage('site')"><i class="bi bi-grid-3x3"></i> Site Plan</button>
                    <span style="flex:1;"></span>
                    <button class="btn btn-ghost btn-sm" onclick="backToProjects()"><i class="bi bi-arrow-left"></i> Projects</button>
                </div>

                <!-- Canvas Toolbar -->
                <div class="canvas-toolbar">
                    <button class="tool-btn" onclick="setTool('select')" id="tool-select" title="Select"><i class="bi bi-cursor"></i></button>
                    <button class="tool-btn" onclick="addText()" title="Add Text"><i class="bi bi-type"></i></button>
                    <button class="tool-btn" onclick="addArrow()" title="Add Arrow"><i class="bi bi-arrow-up-right"></i></button>
                    <button class="tool-btn" onclick="addRect()" title="Add Rectangle"><i class="bi bi-square"></i></button>
                    <button class="tool-btn" onclick="toggleDraw()" id="tool-draw" title="Freehand Draw"><i class="bi bi-pencil"></i></button>
                    <div class="tool-sep"></div>
                    <button class="tool-btn" onclick="uploadBackground()" title="Upload Background"><i class="bi bi-image"></i></button>
                    <div class="tool-sep"></div>
                    <button class="tool-btn" onclick="undoCanvas()" title="Undo (Ctrl+Z)"><i class="bi bi-arrow-counterclockwise"></i></button>
                    <button class="tool-btn" onclick="redoCanvas()" title="Redo (Ctrl+Y)"><i class="bi bi-arrow-clockwise"></i></button>
                    <div class="tool-sep"></div>
                    <button class="tool-btn" onclick="zoomIn()" title="Zoom In"><i class="bi bi-zoom-in"></i></button>
                    <button class="tool-btn" onclick="zoomOut()" title="Zoom Out"><i class="bi bi-zoom-out"></i></button>
                    <button class="tool-btn" onclick="zoomFit()" title="Fit to Screen"><i class="bi bi-fullscreen"></i></button>
                    <div class="tool-sep"></div>
                    <select class="tool-btn" id="canvasPreset" onchange="setCanvasPreset(this.value)" style="appearance:auto;padding-right:24px;">
                        <option value="letter">Letter (8.5×11)</option>
                        <option value="tabloid">Tabloid (11×17)</option>
                        <option value="linkedin" selected>LinkedIn (1200×630)</option>
                    </select>
                    <span style="flex:1;"></span>
                    <button class="tool-btn" onclick="saveCanvas()" title="Save (Ctrl+S)" style="color:#10b981;border-color:rgba(16,185,129,0.3);"><i class="bi bi-check-lg"></i> Save</button>
                    <button class="tool-btn" onclick="exportCanvas('png')" title="Export PNG"><i class="bi bi-download"></i> PNG</button>
                    <button class="tool-btn" onclick="shareLinkedIn()" title="Share to LinkedIn" style="color:#0a66c2;"><i class="bi bi-linkedin"></i></button>
                </div>

                <!-- Canvas + Logo Panel -->
                <div class="canvas-area">
                    <div class="canvas-main">
                        <canvas id="fabricCanvas"></canvas>
                    </div>
                    <div class="logo-panel">
                        <div class="logo-panel-header">
                            <h3><i class="bi bi-bookmark-star"></i> Logo Catalog</h3>
                            <input type="text" class="logo-search" placeholder="Search logos..." id="logoSearch" oninput="filterLogos(this.value)" />
                        </div>
                        <div class="logo-categories">
                            <span class="logo-cat active" onclick="filterCategory('all')">All</span>
                            <span class="logo-cat" onclick="filterCategory('retail')">Retail</span>
                            <span class="logo-cat" onclick="filterCategory('restaurant')">Food</span>
                            <span class="logo-cat" onclick="filterCategory('grocery')">Grocery</span>
                            <span class="logo-cat" onclick="filterCategory('bank')">Bank</span>
                            <span class="logo-cat" onclick="filterCategory('medical')">Medical</span>
                            <span class="logo-cat" onclick="filterCategory('fitness')">Fitness</span>
                        </div>
                        <div class="logo-grid" id="logoGrid">
                            <!-- Logos loaded dynamically from API -->
                        </div>
                        <button class="logo-upload-btn" onclick="uploadLogo()"><i class="bi bi-plus-lg"></i> Upload Logo</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Project Modal -->
    <div class="modal-overlay" id="newProjectModal">
        <div class="modal-box">
            <div class="modal-title"><i class="bi bi-folder-plus"></i> New INTEL Project</div>
            <div class="modal-field">
                <label class="modal-label">Project Name</label>
                <input type="text" class="modal-input" id="newProjectName" placeholder="e.g. 950 Encore Way Listing Package" />
            </div>
            <div class="modal-field">
                <label class="modal-label">Property Address</label>
                <input type="text" class="modal-input" id="newProjectAddress" placeholder="e.g. 950 Encore Way, Naples, FL 34110" />
            </div>
            <div class="modal-field">
                <label class="modal-label">Transaction Type</label>
                <select class="modal-input" id="newProjectType">
                    <option value="lease">Lease</option>
                    <option value="sale">Sale</option>
                    <option value="both">Lease & Sale</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createProject()"><i class="bi bi-plus-lg"></i> Create Project</button>
            </div>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="bgUpload" accept="image/*" style="display:none" onchange="handleBgUpload(event)" />
    <input type="file" id="logoUploadInput" accept="image/*" style="display:none" onchange="handleLogoUpload(event)" />

    <script>
        // ═══════════════════════════════════════════════════
        // STATE
        // ═══════════════════════════════════════════════════
        let canvas, currentProject = null, currentPage = 'aerial';
        let undoStack = [], redoStack = [];
        const PRESETS = {
            letter:   { w: 816, h: 1056 },
            tabloid:  { w: 1056, h: 1632 },
            linkedin: { w: 1200, h: 630 }
        };

        // ═══════════════════════════════════════════════════
        // INIT
        // ═══════════════════════════════════════════════════
        document.addEventListener('DOMContentLoaded', () => {
            canvas = new fabric.Canvas('fabricCanvas', {
                width: 1200, height: 630,
                backgroundColor: '#1e293b',
                selection: true
            });
            canvas.on('object:modified', saveState);
            canvas.on('object:added', saveState);

            loadProjects();
            loadLogos();

            // Check for ?address= or ?project= params
            const params = new URLSearchParams(window.location.search);
            if (params.get('address')) {
                document.getElementById('newProjectAddress').value = params.get('address');
                showNewProjectModal();
            }
            if (params.get('project')) {
                openProject(params.get('project'));
            }
        });

        // ═══════════════════════════════════════════════════
        // PROJECT MANAGEMENT
        // ═══════════════════════════════════════════════════
        async function loadProjects() {
            try {
                const res = await fetch('/api/intel/projects');
                if (!res.ok) return;
                const data = await res.json();
                const grid = document.getElementById('projectGrid');
                if (data.projects && data.projects.length > 0) {
                    grid.innerHTML = data.projects.map(p =>
                        '<div class="project-card" onclick="openProject(\'' + p.id + '\')">' +
                        '<div class="project-card-name">' + (p.name || 'Untitled') + '</div>' +
                        '<div class="project-card-address">' + (p.address || 'No address') + '</div>' +
                        '<div class="project-card-meta">' +
                        '<span><i class="bi bi-file-earmark"></i> ' + (p.page_count || 3) + ' pages</span>' +
                        '<span><i class="bi bi-calendar3"></i> ' + new Date(p.updated_at || p.created_at).toLocaleDateString() + '</span>' +
                        '</div></div>'
                    ).join('');
                }
            } catch (e) { console.error('[INTEL] Load projects error:', e); }
        }

        function showNewProjectModal() { document.getElementById('newProjectModal').classList.add('active'); document.getElementById('newProjectName').focus(); }
        function closeModal() { document.getElementById('newProjectModal').classList.remove('active'); }

        async function createProject() {
            const name = document.getElementById('newProjectName').value.trim();
            const address = document.getElementById('newProjectAddress').value.trim();
            const type = document.getElementById('newProjectType').value;
            if (!name) { document.getElementById('newProjectName').focus(); return; }

            try {
                const res = await fetch('/api/intel/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, address, transaction_type: type })
                });
                if (res.ok) {
                    const data = await res.json();
                    closeModal();
                    openProject(data.project.id);
                    loadProjects();
                }
            } catch (e) { console.error('[INTEL] Create project error:', e); }
        }

        async function openProject(id) {
            currentProject = id;
            document.getElementById('projectListView').style.display = 'none';
            document.getElementById('canvasView').classList.add('active');

            // Load the first page canvas state
            try {
                const res = await fetch('/api/intel/projects/' + id + '/pages');
                if (res.ok) {
                    const data = await res.json();
                    if (data.pages && data.pages.length > 0) {
                        const page = data.pages.find(p => p.page_type === currentPage) || data.pages[0];
                        if (page.canvas_state) {
                            canvas.loadFromJSON(page.canvas_state, () => { canvas.renderAll(); });
                        } else {
                            canvas.clear();
                            canvas.backgroundColor = '#1e293b';
                            canvas.renderAll();
                        }
                    }
                }
            } catch (e) { console.error('[INTEL] Load pages error:', e); }
        }

        function backToProjects() {
            currentProject = null;
            document.getElementById('projectListView').style.display = '';
            document.getElementById('canvasView').classList.remove('active');
            canvas.clear();
            loadProjects();
        }

        // ═══════════════════════════════════════════════════
        // PAGE SWITCHING
        // ═══════════════════════════════════════════════════
        async function switchPage(pageType) {
            if (!currentProject) return;
            // Save current page first
            await saveCanvas();
            currentPage = pageType;
            document.querySelectorAll('.page-tab').forEach(t => t.classList.toggle('active', t.dataset.page === pageType));

            try {
                const res = await fetch('/api/intel/projects/' + currentProject + '/pages');
                if (res.ok) {
                    const data = await res.json();
                    const page = data.pages.find(p => p.page_type === pageType);
                    if (page && page.canvas_state) {
                        canvas.loadFromJSON(page.canvas_state, () => canvas.renderAll());
                    } else {
                        canvas.clear();
                        canvas.backgroundColor = '#1e293b';
                        canvas.renderAll();
                    }
                }
            } catch (e) { console.error('[INTEL] Switch page error:', e); }
        }

        // ═══════════════════════════════════════════════════
        // CANVAS TOOLS
        // ═══════════════════════════════════════════════════
        function setTool(tool) { canvas.isDrawingMode = false; canvas.selection = true; }
        function addText() { const t = new fabric.IText('Label', { left: 100, top: 100, fontFamily: 'Arial', fontSize: 24, fill: '#ffffff', fontWeight: 'bold' }); canvas.add(t); canvas.setActiveObject(t); }
        function addArrow() { const line = new fabric.Line([50, 50, 200, 50], { stroke: '#10b981', strokeWidth: 3, selectable: true }); canvas.add(line); }
        function addRect() { const r = new fabric.Rect({ left: 100, top: 100, width: 200, height: 120, fill: 'transparent', stroke: '#10b981', strokeWidth: 2 }); canvas.add(r); }
        function toggleDraw() { canvas.isDrawingMode = !canvas.isDrawingMode; document.getElementById('tool-draw').classList.toggle('active', canvas.isDrawingMode); if (canvas.isDrawingMode) { canvas.freeDrawingBrush.color = '#10b981'; canvas.freeDrawingBrush.width = 3; } }
        function uploadBackground() { document.getElementById('bgUpload').click(); }
        function handleBgUpload(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (ev) => { fabric.Image.fromURL(ev.target.result, (img) => { img.scaleToWidth(canvas.width); canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas)); }); }; reader.readAsDataURL(file); }

        // Undo / Redo
        function saveState() { undoStack.push(canvas.toJSON()); if (undoStack.length > 30) undoStack.shift(); redoStack = []; }
        function undoCanvas() { if (undoStack.length < 2) return; redoStack.push(undoStack.pop()); canvas.loadFromJSON(undoStack[undoStack.length - 1], () => canvas.renderAll()); }
        function redoCanvas() { if (!redoStack.length) return; const state = redoStack.pop(); undoStack.push(state); canvas.loadFromJSON(state, () => canvas.renderAll()); }

        // Zoom
        function zoomIn() { canvas.setZoom(Math.min(canvas.getZoom() * 1.2, 5)); canvas.renderAll(); }
        function zoomOut() { canvas.setZoom(Math.max(canvas.getZoom() / 1.2, 0.2)); canvas.renderAll(); }
        function zoomFit() { canvas.setZoom(1); canvas.renderAll(); }

        // Canvas Presets
        function setCanvasPreset(preset) { const p = PRESETS[preset]; if (p) { canvas.setDimensions({ width: p.w, height: p.h }); canvas.renderAll(); } }

        // Save
        async function saveCanvas() {
            if (!currentProject) return;
            try {
                await fetch('/api/intel/projects/' + currentProject + '/pages/' + currentPage, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ canvas_state: canvas.toJSON() })
                });
            } catch (e) { console.error('[INTEL] Save error:', e); }
        }

        // Export
        async function exportCanvas(format) {
            const dataURL = canvas.toDataURL({ format: format || 'png', multiplier: 2 });
            const a = document.createElement('a');
            a.href = dataURL;
            a.download = 'intel-export-' + Date.now() + '.' + (format || 'png');
            a.click();
        }

        // LinkedIn Share
        function shareLinkedIn() {
            exportCanvas('png');
            window.open('https://www.linkedin.com/sharing/share-offsite/', '_blank');
        }

        // ═══════════════════════════════════════════════════
        // LOGO CATALOG
        // ═══════════════════════════════════════════════════
        let allLogos = [];
        async function loadLogos() {
            try {
                const res = await fetch('/api/intel/logos');
                if (res.ok) {
                    const data = await res.json();
                    allLogos = data.logos || [];
                    renderLogos(allLogos);
                }
            } catch (e) {
                // No logos yet - show empty state
                document.getElementById('logoGrid').innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px;color:#475569;font-size:0.8rem;">No logos yet. Upload to get started.</div>';
            }
        }

        function renderLogos(logos) {
            const grid = document.getElementById('logoGrid');
            if (!logos.length) { grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px;color:#475569;font-size:0.8rem;">No logos found</div>'; return; }
            grid.innerHTML = logos.map(l =>
                '<div class="logo-item" draggable="true" ondragstart="dragLogo(event,\'' + (l.image_url || '') + '\')" onclick="addLogoToCanvas(\'' + (l.image_url || '') + '\')" title="' + l.name + '">' +
                (l.image_url ? '<img src="' + l.image_url + '" alt="' + l.name + '" />' : l.name) +
                '</div>'
            ).join('');
        }

        function filterLogos(query) { const q = query.toLowerCase(); renderLogos(allLogos.filter(l => l.name.toLowerCase().includes(q))); }
        function filterCategory(cat) {
            document.querySelectorAll('.logo-cat').forEach(c => c.classList.toggle('active', c.textContent.toLowerCase() === cat || (cat === 'all' && c.textContent === 'All')));
            if (cat === 'all') { renderLogos(allLogos); } else { renderLogos(allLogos.filter(l => l.category === cat)); }
        }

        function addLogoToCanvas(url) { if (!url) return; fabric.Image.fromURL(url, (img) => { img.scaleToWidth(80); canvas.add(img); canvas.setActiveObject(img); }, { crossOrigin: 'anonymous' }); }
        function dragLogo(e, url) { e.dataTransfer.setData('text/plain', url); }
        function uploadLogo() { document.getElementById('logoUploadInput').click(); }
        function handleLogoUpload(e) { /* Phase 1: Local only - uploads handled via API in production */ }

        // ═══════════════════════════════════════════════════
        // KEYBOARD SHORTCUTS
        // ═══════════════════════════════════════════════════
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'z') { e.preventDefault(); undoCanvas(); }
            if (e.ctrlKey && e.key === 'y') { e.preventDefault(); redoCanvas(); }
            if (e.ctrlKey && e.key === 's') { e.preventDefault(); saveCanvas(); }
            if (e.key === 'Delete' || e.key === 'Backspace') {
                const obj = canvas.getActiveObject();
                if (obj && !(obj instanceof fabric.IText && obj.isEditing)) { canvas.remove(obj); }
            }
        });
    </script>
</body>
</html>
