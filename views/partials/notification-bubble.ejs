<!-- Global Notification Bubble Component -->
<div id="notificationBubble" class="notification-bubble" style="display:none;">
    <div class="notification-bubble-header" onclick="toggleNotificationExpand()">
        <div class="notification-bubble-icon">
            <i class="bi bi-bell-fill"></i>
            <span class="notification-count" id="notificationCount" style="display:none;">0</span>
        </div>
        <div class="notification-bubble-preview" id="notificationPreview">
            <span class="notification-title">New notification</span>
        </div>
        <button class="notification-close" onclick="dismissCurrentNotification(event)">
            <i class="bi bi-x"></i>
        </button>
    </div>
    <div class="notification-bubble-expanded" id="notificationExpanded">
        <div class="notification-content" id="notificationContent">
            <!-- Dynamic content here -->
        </div>
        <div class="notification-chat" id="notificationChat" style="display:none;">
            <div class="notification-chat-messages" id="notificationChatMessages"></div>
            <div class="notification-chat-input">
                <input type="text" id="notificationChatInput" placeholder="Type a reply..." onkeypress="if(event.key==='Enter')sendNotificationReply()">
                <button onclick="sendNotificationReply()"><i class="bi bi-send"></i></button>
            </div>
        </div>
        <div class="notification-actions" id="notificationActions">
            <!-- Dynamic actions here -->
        </div>
    </div>
</div>

<style>
/* Notification Bubble Styles */
.notification-bubble {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 9999;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.notification-bubble-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: linear-gradient(135deg, #1a2332 0%, #0f1724 100%);
    border: 1px solid rgba(16, 185, 129, 0.3);
    border-radius: 16px;
    cursor: pointer;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 0 1px rgba(16,185,129,0.1);
    transition: all 0.3s ease;
    min-width: 280px;
    max-width: 380px;
}

.notification-bubble-header:hover {
    border-color: rgba(16, 185, 129, 0.5);
    box-shadow: 0 12px 40px rgba(0,0,0,0.5), 0 0 20px rgba(16,185,129,0.15);
    transform: translateY(-2px);
}

.notification-bubble.expanded .notification-bubble-header {
    border-radius: 16px 16px 0 0;
}

.notification-bubble-icon {
    position: relative;
    width: 40px;
    height: 40px;
    background: rgba(16, 185, 129, 0.15);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #10b981;
    font-size: 1.1rem;
    flex-shrink: 0;
}

.notification-bubble-icon.urgent {
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
    50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
}

.notification-count {
    position: absolute;
    top: -4px;
    right: -4px;
    background: #ef4444;
    color: white;
    font-size: 0.65rem;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 100px;
    min-width: 18px;
    text-align: center;
}

.notification-bubble-preview {
    flex: 1;
    overflow: hidden;
}

.notification-bubble-preview .notification-title {
    display: block;
    font-weight: 600;
    color: #e2e8f0;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.notification-bubble-preview .notification-subtitle {
    display: block;
    font-size: 0.75rem;
    color: #64748b;
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.notification-close {
    background: rgba(255,255,255,0.05);
    border: none;
    color: #64748b;
    width: 28px;
    height: 28px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
    flex-shrink: 0;
}

.notification-close:hover {
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
}

.notification-bubble-expanded {
    display: none;
    background: linear-gradient(135deg, #1a2332 0%, #0f1724 100%);
    border: 1px solid rgba(16, 185, 129, 0.3);
    border-top: none;
    border-radius: 0 0 16px 16px;
    padding: 16px;
    max-height: 400px;
    overflow-y: auto;
}

.notification-bubble.expanded .notification-bubble-expanded {
    display: block;
}

.notification-content {
    margin-bottom: 12px;
}

.notification-content p {
    color: #94a3b8;
    font-size: 0.85rem;
    line-height: 1.5;
    margin: 0;
}

.notification-content .notification-meta {
    display: flex;
    gap: 12px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid rgba(255,255,255,0.06);
}

.notification-content .notification-meta-item {
    font-size: 0.75rem;
    color: #64748b;
    display: flex;
    align-items: center;
    gap: 4px;
}

.notification-content .notification-meta-item i {
    color: #10b981;
}

.notification-chat {
    background: rgba(0,0,0,0.2);
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 12px;
}

.notification-chat-messages {
    max-height: 150px;
    overflow-y: auto;
    margin-bottom: 10px;
}

.notification-chat-msg {
    padding: 8px 12px;
    border-radius: 10px;
    font-size: 0.8rem;
    margin-bottom: 6px;
    max-width: 85%;
}

.notification-chat-msg.outgoing {
    background: rgba(16, 185, 129, 0.2);
    color: #6ee7b7;
    margin-left: auto;
}

.notification-chat-msg.incoming {
    background: rgba(139, 92, 246, 0.2);
    color: #c4b5fd;
}

.notification-chat-input {
    display: flex;
    gap: 8px;
}

.notification-chat-input input {
    flex: 1;
    padding: 10px 14px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(0,0,0,0.3);
    color: #e2e8f0;
    font-size: 0.85rem;
    outline: none;
}

.notification-chat-input input:focus {
    border-color: #10b981;
}

.notification-chat-input button {
    padding: 10px 14px;
    border-radius: 10px;
    background: #10b981;
    color: white;
    border: none;
    cursor: pointer;
    transition: all 0.15s;
}

.notification-chat-input button:hover {
    background: #059669;
}

.notification-actions {
    display: flex;
    gap: 8px;
}

.notification-action-btn {
    flex: 1;
    padding: 10px 16px;
    border-radius: 10px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.notification-action-btn.primary {
    background: #10b981;
    color: white;
}

.notification-action-btn.primary:hover {
    background: #059669;
}

.notification-action-btn.secondary {
    background: rgba(255,255,255,0.05);
    color: #94a3b8;
    border: 1px solid rgba(255,255,255,0.1);
}

.notification-action-btn.secondary:hover {
    background: rgba(255,255,255,0.1);
    color: #e2e8f0;
}

/* Animation for new notifications */
.notification-bubble.animate-in {
    animation: slideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(100px) scale(0.8);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Notification queue indicator */
.notification-queue {
    position: absolute;
    bottom: -8px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 4px;
}

.notification-queue-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: rgba(255,255,255,0.3);
}

.notification-queue-dot.active {
    background: #10b981;
}
</style>

<script>
// WebSocket Notification System
(function() {
    let ws = null;
    let notifications = [];
    let currentNotification = null;
    let isExpanded = false;
    let reconnectAttempts = 0;
    let timeoutTimer = null;
    
    const userId = <%= typeof user !== 'undefined' && user ? user.id : 'null' %>;
    const orgId = <%= typeof org !== 'undefined' && org ? org.id : 'null' %>;
    
    function connectWebSocket() {
        if (!userId || !orgId) {
            console.log('[WS] No user session, skipping WebSocket connection');
            return;
        }
        
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/notifications?userId=${userId}&orgId=${orgId}`;
        
        console.log('[WS] Connecting to:', wsUrl);
        
        ws = new WebSocket(wsUrl);
        
        ws.onopen = function() {
            console.log('[WS] Connected to notification service');
            reconnectAttempts = 0;
        };
        
        ws.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            } catch (e) {
                console.error('[WS] Message parse error:', e);
            }
        };
        
        ws.onclose = function() {
            console.log('[WS] Connection closed, reconnecting...');
            setTimeout(() => {
                reconnectAttempts++;
                if (reconnectAttempts < 10) {
                    connectWebSocket();
                }
            }, Math.min(1000 * reconnectAttempts, 30000));
        };
        
        ws.onerror = function(error) {
            console.error('[WS] Error:', error);
        };
    }
    
    function handleWebSocketMessage(data) {
        switch (data.type) {
            case 'connected':
                console.log('[WS] Welcome message received');
                break;
            case 'notification':
                addNotification(data.notification);
                break;
            case 'pending_notifications':
                data.notifications.forEach(n => addNotification(n, false));
                break;
            case 'notification_dismissed':
            case 'notification_resolved':
                removeNotification(data.notificationId);
                break;
        }
    }
    
    function addNotification(notification, animate = true) {
        // Check if already in queue
        if (notifications.find(n => n.id === notification.id)) return;
        
        notifications.push(notification);
        updateNotificationCount();
        
        // If no current notification, show this one
        if (!currentNotification) {
            showNotification(notification, animate);
        }
    }
    
    function showNotification(notification, animate = true) {
        currentNotification = notification;
        const bubble = document.getElementById('notificationBubble');
        const preview = document.getElementById('notificationPreview');
        const content = document.getElementById('notificationContent');
        const actions = document.getElementById('notificationActions');
        const icon = bubble.querySelector('.notification-bubble-icon');
        const chat = document.getElementById('notificationChat');
        
        // Set preview
        preview.innerHTML = `
            <span class="notification-title">${notification.title}</span>
            ${notification.message ? `<span class="notification-subtitle">${notification.message}</span>` : ''}
        `;
        
        // Set expanded content
        let contentHtml = `<p>${notification.message || ''}</p>`;
        if (notification.data && Object.keys(notification.data).length > 0) {
            contentHtml += '<div class="notification-meta">';
            if (notification.data.propertyAddress) {
                contentHtml += `<span class="notification-meta-item"><i class="bi bi-geo-alt"></i> ${notification.data.propertyAddress}</span>`;
            }
            if (notification.data.requestedByName) {
                contentHtml += `<span class="notification-meta-item"><i class="bi bi-person"></i> ${notification.data.requestedByName}</span>`;
            }
            contentHtml += '</div>';
        }
        content.innerHTML = contentHtml;
        
        // Set actions
        let actionsHtml = '';
        if (notification.action_url) {
            actionsHtml += `<button class="notification-action-btn primary" onclick="openNotificationAction('${notification.action_url}')">
                <i class="bi bi-arrow-right"></i> ${notification.action_label || 'View'}
            </button>`;
        }
        if (notification.requires_action) {
            actionsHtml += `<button class="notification-action-btn secondary" onclick="resolveNotification(${notification.id})">
                <i class="bi bi-check-lg"></i> Mark Complete
            </button>`;
        }
        actions.innerHTML = actionsHtml;
        
        // Show/hide chat based on type
        if (notification.type === 'flyer_request' || notification.type === 'chat_message') {
            chat.style.display = 'block';
        } else {
            chat.style.display = 'none';
        }
        
        // Set icon style
        icon.classList.toggle('urgent', notification.priority === 'high');
        
        // Show bubble
        bubble.style.display = 'block';
        if (animate) {
            bubble.classList.add('animate-in');
            setTimeout(() => bubble.classList.remove('animate-in'), 400);
        }
        
        // Mark as read after showing
        markAsRead(notification.id);
        
        // Set timeout if applicable (but not for task notifications)
        if (notification.timeout_seconds && !notification.requires_action) {
            clearTimeout(timeoutTimer);
            timeoutTimer = setTimeout(() => {
                if (!isExpanded) {
                    dismissCurrentNotification();
                }
            }, notification.timeout_seconds * 1000);
        }
    }
    
    function removeNotification(notificationId) {
        notifications = notifications.filter(n => n.id !== notificationId);
        updateNotificationCount();
        
        if (currentNotification && currentNotification.id === notificationId) {
            showNextNotification();
        }
    }
    
    function showNextNotification() {
        currentNotification = null;
        clearTimeout(timeoutTimer);
        
        if (notifications.length > 0) {
            // Show oldest unresolved notification
            const next = notifications[0];
            showNotification(next, true);
        } else {
            document.getElementById('notificationBubble').style.display = 'none';
            isExpanded = false;
            document.getElementById('notificationBubble').classList.remove('expanded');
        }
    }
    
    function updateNotificationCount() {
        const countEl = document.getElementById('notificationCount');
        const count = notifications.length;
        
        if (count > 1) {
            countEl.textContent = count;
            countEl.style.display = 'block';
        } else {
            countEl.style.display = 'none';
        }
    }
    
    // Global functions
    window.toggleNotificationExpand = function() {
        isExpanded = !isExpanded;
        document.getElementById('notificationBubble').classList.toggle('expanded', isExpanded);
        
        // Cancel timeout when expanded
        if (isExpanded) {
            clearTimeout(timeoutTimer);
        }
    };
    
    window.dismissCurrentNotification = function(event) {
        if (event) event.stopPropagation();
        
        if (currentNotification) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ 
                    type: 'dismiss', 
                    notificationId: currentNotification.id 
                }));
            }
            removeNotification(currentNotification.id);
        }
    };
    
    window.resolveNotification = function(notificationId) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ 
                type: 'resolve', 
                notificationId: notificationId 
            }));
        }
        removeNotification(notificationId);
    };
    
    window.openNotificationAction = function(url) {
        window.location.href = url;
    };
    
    window.sendNotificationReply = function() {
        const input = document.getElementById('notificationChatInput');
        const message = input.value.trim();
        if (!message || !currentNotification) return;
        
        // Add to chat display
        const chatMessages = document.getElementById('notificationChatMessages');
        chatMessages.innerHTML += `<div class="notification-chat-msg outgoing">${message}</div>`;
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // Send via WebSocket
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                type: 'chat_response',
                notificationId: currentNotification.id,
                response: message,
                sourceType: currentNotification.source_type,
                sourceId: currentNotification.source_id
            }));
        }
        
        input.value = '';
    };
    
    function markAsRead(notificationId) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ 
                type: 'mark_read', 
                notificationId: notificationId 
            }));
        }
    }
    
    // Connect when page loads
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', connectWebSocket);
    } else {
        connectWebSocket();
    }
})();
</script>
